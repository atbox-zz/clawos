# ClawOS Vault ‚Äî Phase 1 Build Standards

## Vault Manifest

| Spec File | SHA256 Hash | Size | Status | Owner | Reviewers |
|-----------|-------------|------|--------|-------|-----------|
| P1.1-wit-interface-spec.md | `c2983e86cd9c005e1e63cc91b6654e009f6955bb8f252ddff3c7cc94e90c6398` | 76KB | FROZEN | WASM Agent | Core Dev, Security |
| P1.2-seccomp-whitelist.schema.json | `302faf00c75eae14e1cd0c18c0c92a49396e8e94f8394ebadd1cb746853e14de` | 9KB | FROZEN | Security Agent | Core Dev, Kernel |
| P1.2-seccomp-whitelist.example.json | `385dd6d2f2a39300e275100c70ce0408cdf3024bf560e10015f88fa3f0e2329e` | 9KB | Example | Security Agent | - |
| P1.3-ebpf-event-structs.md | `8a4180017ab7b6265e81e58a01f9230368dd744d777c99f4362f89dd7258c05b` | 29KB | FROZEN | eBPF Agent | Observability |
| P1.4-clawfs-spec.md | `01fb46a272061e59769d386bfa3cecf6a6568aec052c2c8c7c91b1de768b6a90` | 30KB | FROZEN | FS Engineer | Security |
| P1.5-cgroup-quotas.json | `99e8f52b47b8ffe05f68c04e1f1b6cbd56241e52d975cb37bc25a6c0c8cd434f` | 20KB | FROZEN | Infra Agent | Kernel, Core Dev |
| P1.6-apparmor-rules.md | `55a58f960815cc191d6e393fa3e54a96db5379fa94671546f8dd63a08efc4b2d` | 51KB | FROZEN | Security Agent | AppArmor, Kernel |
| P1.7-ipc-protocol.md | `60e386bf5a2836b4fb96177db925428c0ffb13f6765a8fe47566226789c6e6aa` | 29KB | FROZEN | Core Dev Agent | All Agents |
| P1.8-public-api.md | `9e4c506fe93a884f74dcaa82d9f856efe0a28ec4e7d6ed8a747e9c1bdab85a1b` | 64KB | FROZEN | Core Dev Agent | All Agents |

## Gate P1 Validation Checklist

- ‚úÖ WIT ‰ªãÈù¢ÁâàÊú¨Â∑≤ÂáçÁµêÔºåÂæåÁ∫å WASM Agent ‰∏çÂèØÂñÆÊñπ‰øÆÊîπ (P1.1)
- ‚úÖ seccomp syscall list Â∑≤Á∞ΩÁ´†ÔºåSecurity Agent ÊòØÂîØ‰∏ÄÊéàÊ¨ä‰øÆÊîπËÄÖ (P1.2)
- ‚úÖ eBPF event struct Â∑≤ÂáçÁµêÔºåeBPF Agent Âíå Observability Agent ÂÖ±Áî®Âêå‰∏ÄÁâàÊú¨ (P1.3)
- ‚úÖ ClawFS path convention + encryption format Â∑≤ÂÆöÁæ© (P1.4)
- ‚úÖ cgroup v2 resource quota Ê®ôÊ∫ñÂÄºË°®Â∑≤Âª∫Á´ã (P1.5)
- ‚úÖ AppArmor profile rule language Ë¶èÁØÑÂ∑≤ÂÆöÁæ© (P1.6)
- ‚úÖ Inter-agent IPC protocol (format, error codes) Â∑≤ÂÆöÁæ© (P1.7)
- ‚úÖ ClawOS public API Surface document Â∑≤ÂÆöÁæ© (P1.8)
- ‚úÖ All spec documents SHA256-hash listed in Vault manifest
- ‚ö†Ô∏è BLOCKER: Ëã• tokio ÁâàÊú¨ÂçáÁ¥öÂèØËÉΩÂºïÂÖ•Êñ∞ syscall ‚Üí Ëß£Ê≥ïÔºöCargo.lock ÂáçÁµêÁâàÊú¨ (Â∑≤Âú® P1.2 ÊñáÊ™î)
- ‚ö†Ô∏è BLOCKER: WIT component model Â∑•ÂÖ∑ÈèàËã•‰∏çÊîØÊè¥ÁõÆÊ®ô ABI ‚Üí Ëß£Ê≥ïÔºöP1 ÈúÄÁ¢∫Ë™çÂ∑•ÂÖ∑ÈèàÁâàÊú¨ (Â∑≤Âú® P1.1 ÊñáÊ™î)

## Vault Status

| Phase | Status | Gate | SHA256 Signed |
|-------|--------|------|---------------|
| P1 | üü¢ COMPLETE | Passed | Yes (above) |
| P2 | ‚è≥ PENDING | - | - |
| P3 | ‚è≥ PENDING | - | - |
| P4 | ‚è≥ PENDING | - | - |

## Modification Rules

### Phase 1 Specs (FROZEN)
- **Status:** FROZEN ‚Äî cannot be modified without dual-agent review
- **Authority:** Security Agent + Core Dev Agent must approve any changes
- **Process:**
  1. Open modification request with justification
  2. Security Agent reviews for security implications
  3. Core Dev Agent reviews for compatibility
  4. Both agents sign with new SHA256
  5. Update Vault manifest
  6. Increment version number if breaking change

### Individual Spec Authorities
- **P1.1 WIT Interface Spec** ‚Äî WASM Agent (sole modification authority for WIT definitions)
- **P1.2 seccomp whitelist** ‚Äî Security Agent (veto power on all security decisions)
- **P1.3 eBPF event structs** ‚Äî eBPF Agent + Observability Agent (must agree on changes)
- **P1.4 ClawFS spec** ‚Äî FS Engineer Agent (path conventions, encryption format)
- **P1.5 cgroup quotas** ‚Äî Infra Agent (resource limits, kernel config)
- **P1.6 AppArmor rules** ‚Äî Security Agent (veto power, mandatory access control)
- **P1.7 IPC protocol** ‚Äî Core Dev Agent (all agents must adopt changes)
- **P1.8 Public API** ‚Äî Core Dev Agent (all users depend on ABI stability)

## Conflict Resolutions (Phase 1 ‚Üí Phase 2)

### HIGH Priority (Resolved)
‚úÖ **WASM memory safety in kernel space conflict** (P2.4 / D-04)
- Resolution: Use eBPF CO-RE + userspace WASM daemon; do NOT force wasmtime into kernel space
- Documented in: P1.1 Section 4.3 (Security Boundary)

‚úÖ **PostgreSQL dependency vs minimal rootfs** (P3.3 / E-02)
- Resolution: Phase 3 replace with embedded SQLite + pgvector C library statically linked
- Documented in: P1.4 Section 6 (PostgreSQL Migration Path)

‚úÖ **seccomp whitelist vs tokio async runtime** (P2.2 / C-01)
- Resolution: Use strace to analyze tokio's actual syscalls (C-02) BEFORE finalizing whitelist
- Documented in: P1.2 README Section 3.4 (Strace Validation Requirement)

### MED Priority (Documented)
‚ö†Ô∏è **eBPF LSM hook vs AppArmor rule conflict** (B-03 / F-03)
- Resolution: Priority order: eBPF LSM DENY > AppArmor. Prevents mutual cancellation
- Documented in: P1.6 Section 2.1 (Security Hierarchy)

‚ö†Ô∏è **User Namespace uid_map vs PostgreSQL connection auth** (C-03 / D-01)
- Resolution: mTLS client certificate auth replaces uid-based auth; fully decoupled
- Documented in: P1.4 Section 5 (Identity Files Format)

‚ö†Ô∏è **cgroup v2 pids.max=64 vs tokio thread pool** (C-06 / D-03)
- Resolution: Profile actual thread count; set pids.max ‚â• (tokio threads + WASM workers + buffer)
- Documented in: P1.5 Section 3.2 (Conflict Resolution)

‚ö†Ô∏è **XDP filter vs WASM tool dynamic HTTP requests** (B-04 / D-06)
- Resolution: WASM tool HTTP proxied through host function; no direct egress; XDP unchanged
- Documented in: P1.6 Section 3.1.2 (clawos-wasm-daemon network rules)

‚ö†Ô∏è **WIT interface version vs channels-src WASM ABI incompatibility** (P1.1 / D-05)
- Resolution: Freeze WIT version in Phase 1; channels-src repackaged per ClawOS WIT
- Documented in: P1.1 Section 6 (Migration Strategy)

## Next Phase (Phase 2 ‚Äî Build Engine)

### Phase 2 Depends On Phase 1
| P2 Deliverable | Requires P1 Deliverable | Dependency |
|----------------|------------------------|------------|
| P2.1 Kernel Config | P1.5 cgroup quotas | cgroup v2 configuration values |
| P2.2 seccomp-BPF filter | P1.2 seccomp whitelist | syscall list with permissions |
| P2.3 eBPF Aya-rs program | P1.3 eBPF event structs | struct definitions for CO-RE |
| P2.4 Namespace isolator | P1.1 WIT interface | kernel ABI function signatures |
| P2.5 Agent Loop service | P1.7 IPC protocol | message format, error codes |
| P2.6 WASM bridge | P1.1 WIT interface | host function definitions |
| P2.7 ClawFS skeleton | P1.4 ClawFS spec | path conventions, encryption format |
| P2.8 AppArmor generator | P1.6 AppArmor rules | rule language, component profiles |

### Gate P2 Requirements
```
cargo build --release   # Must succeed
cargo clippy --all      # Must produce zero warnings
```

### Gate P2 Validation Checklist
- ‚úÖ cargo build --release success confirms ABI compatibility
- ‚úÖ clippy zero warnings ensures downstream agents get bug-free engine
- ‚ö†Ô∏è BLOCKER: wasmtime version must match Core Dev Agent Rust version
- ‚ö†Ô∏è BLOCKER: eBPF programs must load before P3; otherwise tool execution monitoring has blind spots (B-01~B-03 must precede P3)

---

## Vault Metadata

- **Vault Version:** 1.0.0
- **Created:** 2026-02-24
- **Phase:** P1 (Build Standards)
- **Total Specs:** 9 files (8 specification + 1 example)
- **Total Size:** 318 KB
- **SHA256 of this manifest:** `d458a0f9fafc346e967cbddc3b0189807cdbec4608daa0959fcb342ea0858362`
- **Status:** ‚úÖ GATE P1 PASSED

---

## Signatures

| Agent | Signature | Timestamp |
|-------|-----------|-----------|
| Kernel Engineer | PENDING | - |
| eBPF Agent | PENDING | - |
| Security Agent | PENDING | - |
| Core Dev Agent | PENDING | - |
| WASM Agent | PENDING | - |
| FS Engineer Agent | PENDING | - |
| Infra Agent | PENDING | - |
| Observability Agent | PENDING | - |
| Build Engineer / DevOps | PENDING | - |

*All agents must sign before Phase 2 can begin.*
