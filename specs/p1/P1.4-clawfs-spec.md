# P1.4 â€” ClawFS Filesystem Specification

**Status:** ðŸ”’ **FROZEN** (SHA256: `PLACEHOLDER_SHA256_TO_BE_FILLED`)
**Version:** 1.0.0
**Date:** 2026-02-24
**Owner:** FS Engineer Agent
**Dependencies:** None (base specification)

---

## Overview

ClawFS is an AI-aware filesystem designed for ClawOS, providing:
- **Vector-indexed storage** for semantic search across workspaces
- **AES-256-GCM encryption** for secrets vault
- **POSIX-compatible interface** for seamless integration
- **Identity Files** as persistent kernel memory mechanism
- **Hybrid search** combining full-text (FTS5) and vector similarity (HNSW)

ClawFS replaces PostgreSQL + pgvector from IronClaw with embedded SQLite + HNSW for minimal footprint and embedded deployment.

---

## 1. Path Namespace Hierarchy

### 1.1 Root Structure

```
/clawfs/
â”œâ”€â”€ system/          # OS-managed files (read-only)
â”œâ”€â”€ agents/          # Agent-specific workspaces
â”œâ”€â”€ tools/           # Tool definitions and WASM binaries
â”œâ”€â”€ workspaces/      # User workspaces with vector storage
â”œâ”€â”€ vault/           # Encrypted secrets storage
â””â”€â”€ specs/           # Frozen specification documents (SHA256-signed)
```

### 1.2 Directory Specifications

#### `/clawfs/system/` â€” OS-Managed Files

**Purpose:** Read-only system files managed by ClawOS kernel.

**Permissions:** `0555` (read-only, execute for directory traversal)

**Structure:**
```
/clawfs/system/
â”œâ”€â”€ kernel/
â”‚   â”œâ”€â”€ config-6.6-clawos          # Kernel .config (SHA256-signed)
â”‚   â””â”€â”€ modules/
â”‚       â”œâ”€â”€ ebpf-monitor.ko        # eBPF monitoring module
â”‚       â””â”€â”€ clawfs-bridge.ko       # ClawFS kernel bridge
â”œâ”€â”€ seccomp/
â”‚   â””â”€â”€ whitelist.json             # seccomp syscall whitelist (P1.2)
â”œâ”€â”€ apparmor/
â”‚   â””â”€â”€ clawos-profile             # AppArmor profile (P1.6)
â””â”€â”€ cgroup/
    â””â”€â”€ quotas.json                # cgroup v2 resource quotas (P1.5)
```

**Constraints:**
- All files are immutable after boot
- Modified only via secure update mechanism (signed packages)
- SHA256 hashes stored in `/clawfs/vault/system-manifest.json`

---

#### `/clawfs/agents/` â€” Agent Workspaces

**Purpose:** Isolated workspaces for each AI agent (8 agents total).

**Permissions:** `0750` (agent owner: read/write/execute, group: read/execute)

**Structure:**
```
/clawfs/agents/
â”œâ”€â”€ kernel-engine/
â”‚   â”œâ”€â”€ workspace.db               # SQLite workspace (FTS5 + HNSW)
â”‚   â”œâ”€â”€ state.json                 # Agent state snapshot
â”‚   â”œâ”€â”€ logs/
â”‚   â”‚   â””â”€â”€ agent-YYYY-MM-DD.log   # Daily logs (RULE-007)
â”‚   â””â”€â”€ cache/                     # Temporary cache files
â”œâ”€â”€ ebpf-agent/
â”‚   â”œâ”€â”€ workspace.db
â”‚   â”œâ”€â”€ state.json
â”‚   â””â”€â”€ logs/
â”œâ”€â”€ security-agent/
â”‚   â”œâ”€â”€ workspace.db
â”‚   â”œâ”€â”€ state.json
â”‚   â””â”€â”€ logs/
â”œâ”€â”€ core-dev-agent/
â”‚   â”œâ”€â”€ workspace.db
â”‚   â”œâ”€â”€ state.json
â”‚   â””â”€â”€ logs/
â”œâ”€â”€ wasm-agent/
â”‚   â”œâ”€â”€ workspace.db
â”‚   â”œâ”€â”€ state.json
â”‚   â””â”€â”€ logs/
â”œâ”€â”€ fs-engine/
â”‚   â”œâ”€â”€ workspace.db
â”‚   â”œâ”€â”€ state.json
â”‚   â””â”€â”€ logs/
â”œâ”€â”€ observability/
â”‚   â”œâ”€â”€ workspace.db
â”‚   â”œâ”€â”€ state.json
â”‚   â””â”€â”€ logs/
â””â”€â”€ build-engine/
    â”œâ”€â”€ workspace.db
    â”œâ”€â”€ state.json
    â””â”€â”€ logs/
```

**Constraints:**
- Each agent has isolated workspace.db (SQLite + HNSW)
- Agent cannot write outside its own directory (RULE-001)
- Workspace.db follows hybrid search schema (Section 3)

---

#### `/clawfs/tools/` â€” Tool Definitions and WASM Binaries

**Purpose:** Tool registry with WASM binaries and metadata.

**Permissions:** `0755` (read/execute for all, write only by WASM Agent)

**Structure:**
```
/clawfs/tools/
â”œâ”€â”€ registry.json                  # Tool manifest (SHA256-signed)
â”œâ”€â”€ definitions/
â”‚   â”œâ”€â”€ tool-telegram-channel.json
â”‚   â”œâ”€â”€ tool-slack-channel.json
â”‚   â”œâ”€â”€ tool-web-search.json
â”‚   â””â”€â”€ tool-...
â””â”€â”€ binaries/
    â”œâ”€â”€ telegram-channel-v1.0.0.wasm
    â”œâ”€â”€ slack-channel-v1.0.0.wasm
    â”œâ”€â”€ web-search-v1.0.0.wasm
    â””â”€â”€ ...
```

**Tool Definition Schema:**
```json
{
  "tool_id": "telegram-channel",
  "version": "1.0.0",
  "wasm_path": "/clawfs/tools/binaries/telegram-channel-v1.0.0.wasm",
  "wasm_hash": "sha256:abc123...",
  "wit_interface": "clawos-channel-v1",
  "capabilities": [
    "network:outbound:telegram",
    "filesystem:read:/clawfs/workspaces"
  ],
  "memory_limit_mb": 64,
  "cpu_quota_percent": 10,
  "timeout_seconds": 300,
  "author": "ClawOS Project",
  "license": "MIT"
}
```

**Constraints:**
- WASM binaries are immutable (versioned in filename)
- Registry.json is SHA256-signed (stored in Vault)
- Tool execution requires capability check via seccomp + AppArmor

---

#### `/clawfs/workspaces/` â€” User Workspaces

**Purpose:** User-defined workspaces with vector-indexed content.

**Permissions:** `0750` (user: read/write/execute, group: read/execute)

**Structure:**
```
/clawfs/workspaces/
â”œâ”€â”€ default/
â”‚   â”œâ”€â”€ workspace.db               # SQLite + HNSW
â”‚   â”œâ”€â”€ metadata.json              # Workspace metadata
â”‚   â””â”€â”€ snapshots/                 # Workspace snapshots
â”‚       â”œâ”€â”€ snapshot-2024-02-24.db
â”‚       â””â”€â”€ snapshot-2024-02-25.db
â”œâ”€â”€ project-alpha/
â”‚   â”œâ”€â”€ workspace.db
â”‚   â”œâ”€â”€ metadata.json
â”‚   â””â”€â”€ snapshots/
â””â”€â”€ project-beta/
    â”œâ”€â”€ workspace.db
    â”œâ”€â”€ metadata.json
    â””â”€â”€ snapshots/
```

**Workspace Metadata Schema:**
```json
{
  "workspace_id": "default",
  "created_at": "2024-02-24T00:00:00Z",
  "updated_at": "2024-02-24T12:34:56Z",
  "vector_dimension": 1536,
  "hnsw_params": {
    "m": 16,
    "ef_construction": 200,
    "ef_search": 50
  },
  "owner": "user",
  "encryption_enabled": false
}
```

**Constraints:**
- Each workspace has independent SQLite + HNSW database
- Vector dimension must be uniform across all components (default: 1536)
- Snapshots are full database copies (not incremental)

---

#### `/clawfs/vault/` â€” Encrypted Secrets Storage

**Purpose:** Secure storage for secrets (API keys, credentials, encryption keys).

**Permissions:** `0700` (root-only access)

**Structure:**
```
/clawfs/vault/
â”œâ”€â”€ master-key.enc                # Encrypted master key (AES-256-GCM)
â”œâ”€â”€ secrets/
â”‚   â”œâ”€â”€ openai-api-key.enc
â”‚   â”œâ”€â”€ near-ai-token.enc
â”‚   â”œâ”€â”€ github-pat.enc
â”‚   â””â”€â”€ ...
â”œâ”€â”€ system-manifest.json          # SHA256 hashes of system files
â””â”€â”€ spec-signatures.json          # SHA256 signatures of P1 specs
```

**Secret File Format:**
```json
{
  "secret_id": "openai-api-key",
  "encrypted_value": "base64-encoded-aes-gcm-ciphertext",
  "iv": "base64-encoded-96-bit-iv",
  "auth_tag": "base64-encoded-128-bit-tag",
  "algorithm": "AES-256-GCM",
  "key_id": "kernel-keyring:clawos-master",
  "created_at": "2024-02-24T00:00:00Z",
  "version": 1
}
```

**Constraints:**
- All secrets encrypted with AES-256-GCM (Section 2)
- Master key sealed in TPM 2.0 when available (Section 2.2)
- Vault access requires kernel keyring authentication

---

#### `/clawfs/specs/` â€” Frozen Specification Documents

**Purpose:** Immutable, SHA256-signed specification documents from Phase 1.

**Permissions:** `0444` (read-only for all)

**Structure:**
```
/clawfs/specs/
â”œâ”€â”€ p1/
â”‚   â”œâ”€â”€ P1.1-wit-interface-spec.md
â”‚   â”œâ”€â”€ P1.2-seccomp-whitelist-spec.md
â”‚   â”œâ”€â”€ P1.3-ebpf-event-struct-spec.md
â”‚   â”œâ”€â”€ P1.4-clawfs-spec.md        # This document
â”‚   â”œâ”€â”€ P1.5-cgroup-quotas-spec.md
â”‚   â”œâ”€â”€ P1.6-apparmor-profile-spec.md
â”‚   â”œâ”€â”€ P1.7-ipc-protocol-spec.md
â”‚   â””â”€â”€ P1.8-public-api-spec.md
â””â”€â”€ signatures.json                # SHA256 signatures of all P1 specs
```

**Signature Schema:**
```json
{
  "spec_id": "P1.4-clawfs-spec",
  "sha256": "PLACEHOLDER_SHA256_TO_BE_FILLED",
  "signed_by": "FS Engineer Agent",
  "signed_at": "2024-02-24T00:00:00Z",
  "status": "FROZEN"
}
```

**Constraints:**
- All P1 specs are immutable after Gate P1
- Modifying frozen spec requires dual-agent review (Security + Core Dev, RULE-003)
- SHA256 mismatch blocks execution (Task Spec frozen_spec_deps)

---

## 2. Path Naming Conventions

### 2.1 General Rules

| Rule                    | Description                                  | Example                                                         |
| ----------------------- | -------------------------------------------- | --------------------------------------------------------------- |
| **Lowercase**           | All path components must be lowercase        | `/clawfs/tools/` (not `/ClawFS/Tools/`)                         |
| **Hyphen-separated**    | Use hyphens, not underscores or spaces       | `tool-telegram-channel.json` (not `tool_telegram_channel.json`) |
| **Semantic versioning** | Versioned files use `vX.Y.Z` format          | `telegram-channel-v1.0.0.wasm`                                  |
| **No special chars**    | Only alphanumeric, hyphens, and dots allowed | `workspace.db` (not `workspace@v1.db`)                          |
| **Max length**          | Path component â‰¤ 255 characters              | Enforced by filesystem                                          |
| **ASCII only**          | No Unicode in path components                | Use ASCII for compatibility                                     |

### 2.2 Agent Directory Names

Agent directories match the agent roster from SKILLS.md:

```
kernel-engine/
ebpf-agent/
security-agent/
core-dev-agent/
wasm-agent/
fs-engine/
observability/
build-engine/
```

### 2.3 Tool Naming Convention

```
tool-{tool-name}.json
{tool-name}-v{major}.{minor}.{patch}.wasm
```

Examples:
- `tool-telegram-channel.json`
- `telegram-channel-v1.0.0.wasm`
- `tool-web-search.json`
- `web-search-v1.2.3.wasm`

### 2.4 Workspace Naming Convention

```
{workspace-name}/
```

Rules:
- Workspace names must be unique
- Reserved names: `default`, `system`, `vault`
- Max length: 64 characters
- Pattern: `[a-z0-9-]+`

### 2.5 Snapshot Naming Convention

```
snapshot-{YYYY-MM-DD}.db
```

Examples:
- `snapshot-2024-02-24.db`
- `snapshot-2024-02-25.db`

---

## 3. Secrets Encryption Format

### 3.1 Algorithm Specification

| Parameter          | Value                               |
| ------------------ | ----------------------------------- |
| **Algorithm**      | AES-256-GCM (Galois/Counter Mode)   |
| **Key size**       | 256 bits (32 bytes)                 |
| **IV size**        | 96 bits (12 bytes)                  |
| **Auth tag size**  | 128 bits (16 bytes)                 |
| **KDF**            | PBKDF2-HMAC-SHA256                  |
| **KDF iterations** | 600,000 (OWASP 2024 recommendation) |
| **Salt size**      | 128 bits (16 bytes)                 |

### 3.2 Key Source Hierarchy

ClawOS uses a hierarchical key derivation strategy:

```
TPM 2.0 (Primary)
    â†“ (sealed key)
Kernel Keyring (Secondary)
    â†“ (derived key)
Per-Secret Keys (Tertiary)
```

#### Level 1: TPM 2.0 Sealed Key (When Available)

**Purpose:** Hardware-bound master key sealed in TPM.

**Process:**
1. Generate 256-bit random master key
2. Seal key in TPM 2.0 using PCR values (boot measurement)
3. Store sealed key blob in `/clawfs/vault/master-key.enc`
4. Key can only be unsealed by trusted boot state

**TPM Commands:**
```bash
# Create primary key
tpm2_createprimary -C e -g sha256 -G rsa -c primary.ctx

# Create sealed key object
tpm2_create -C primary.ctx -g sha256 -G aes256cfb -u key.pub -r key.priv

# Load and seal master key
tpm2_load -C primary.ctx -u key.pub -r key.priv -c key.ctx
tpm2_unseal -c key.ctx -o master-key.bin
```

**Fallback:** If TPM unavailable, use kernel keyring directly (Level 2).

#### Level 2: Kernel Keyring (Always Available)

**Purpose:** Software-based key storage in kernel keyring.

**Keyring Structure:**
```
keyring: .clawos
  â”œâ”€â”€ key: clawos-master (type: user, 256-bit)
  â”œâ”€â”€ key: clawos-tpm-sealed (type: trusted, if TPM available)
  â””â”€â”€ key: clawos-derived-{secret-id} (type: logon, per-secret)
```

**Commands:**
```bash
# Add master key to keyring
keyctl add user clawos-master "binary-key-data" @u

# Add TPM-sealed key (if available)
keyctl add trusted clawos-tpm-sealed "tpm2-blob" @u

# Derive per-secret key
keyctl add logon clawos-derived-openai-api-key "derived-key-data" @u
```

#### Level 3: Per-Secret Derived Keys

**Purpose:** Unique encryption key for each secret.

**Derivation Process:**
```
master_key (256 bits)
    â†“ PBKDF2-HMAC-SHA256
|  |
    iterations = 600,000
    â†“
per_secret_key (256 bits)
```

**Pseudocode:**
```rust
use pbkdf2::pbkdf2_hmac;
use sha2::Sha256;

fn derive_secret_key(master_key: &[u8], secret_id: &str, version: u32) -> [u8; 32] {
    let salt = format!("{}:v{}", secret_id, version);
    let mut key = [0u8; 32];
    pbkdf2_hmac::<Sha256>(
        master_key,
        salt.as_bytes(),
        600_000,
        &mut key
    );
    key
}
```

### 3.3 Encryption Process

**Input:** Plaintext secret value (UTF-8 string or binary)

**Steps:**
1. Generate random 96-bit IV
2. Derive per-secret key from master key (PBKDF2)
3. Encrypt plaintext with AES-256-GCM
4. Extract 128-bit auth tag
|  | ciphertext |  |

**Rust Implementation (aes-gcm crate):**
```rust
use aes_gcm::{
    aead::{Aead, KeyInit},
    Aes256Gcm, Nonce,
};

fn encrypt_secret(plaintext: &[u8], key: &[u8; 32]) -> Result<Vec<u8>, Error> {
    let cipher = Aes256Gcm::new(key.into());
    let nonce = Nonce::from_slice(&rand::random::<[u8; 12]>());

    let ciphertext = cipher.encrypt(nonce, plaintext)?;

|  | Ciphertext (variable) |  |
    let mut result = Vec::with_capacity(12 + ciphertext.len());
    result.extend_from_slice(nonce);
    result.extend_from_slice(&ciphertext);

    Ok(result)
}
```

### 3.4 Decryption Process

**Input:** Encrypted secret file

**Steps:**
1. Read IV (first 12 bytes)
2. Read ciphertext + auth tag (remaining bytes)
3. Derive per-secret key from master key (PBKDF2)
4. Decrypt with AES-256-GCM (auth tag verified automatically)
5. Return plaintext

**Rust Implementation:**
```rust
fn decrypt_secret(encrypted: &[u8], key: &[u8; 32]) -> Result<Vec<u8>, Error> {
    let cipher = Aes256Gcm::new(key.into());

    let nonce = Nonce::from_slice(&encrypted[..12]);
    let ciphertext = &encrypted[12..];

    let plaintext = cipher.decrypt(nonce, ciphertext)?;

    Ok(plaintext)
}
```

### 3.5 Secret File Format (JSON)

```json
{
  "secret_id": "openai-api-key",
  "encrypted_value": "base64-encoded-aes-gcm-ciphertext",
  "iv": "base64-encoded-96-bit-iv",
  "auth_tag": "base64-encoded-128-bit-tag",
  "algorithm": "AES-256-GCM",
  "key_id": "kernel-keyring:clawos-master",
  "kdf": {
    "algorithm": "PBKDF2-HMAC-SHA256",
    "iterations": 600000,
    "salt": "base64-encoded-salt"
  },
  "created_at": "2024-02-24T00:00:00Z",
  "updated_at": "2024-02-24T12:34:56Z",
  "version": 1
}
```

### 3.6 Key Rotation Strategy

**Trigger:** Every 90 days or on security incident.

**Process:**
1. Generate new master key
2. Re-encrypt all secrets with new key
3. Update version number in secret files
4. Archive old master key (retain for 30 days)
5. Verify decryption of all secrets

**Rollback:** If rotation fails, restore from archive.

---

## 4. Vector Index Storage

### 4.1 Hybrid Search Architecture

ClawFS uses a **hybrid search** combining:
- **Full-text search** via SQLite FTS5 (BM25 ranking)
- **Vector similarity** via HNSW (Hierarchical Navigable Small World)

**Benefits:**
- Exact keyword matching (FTS5)
- Semantic similarity (HNSW)
- Single database file (SQLite + extension)

### 4.2 SQLite Schema

#### Main Tables

```sql
-- Documents table (FTS5 enabled)
CREATE VIRTUAL TABLE documents USING fts5(
    id INTEGER PRIMARY KEY,
    workspace_id TEXT NOT NULL,
    content TEXT,
    metadata TEXT,  -- JSON metadata
    tokenize = 'porter unicode61'
);

-- Vector table (HNSW extension)
CREATE TABLE vectors (
    id INTEGER PRIMARY KEY,
    document_id INTEGER NOT NULL,
    embedding BLOB NOT NULL,  -- Float32 array, dimension = 1536 or 3072
    created_at TEXT NOT NULL,
    FOREIGN KEY (document_id) REFERENCES documents(id)
);

-- HNSW index (created via extension)
CREATE VIRTUAL TABLE vectors_hnsw USING hnsw(
    vectors_embedding
) WITH (
    dimension = 1536,  -- or 3072 (configurable)
    m = 16,
    ef_construction = 200
);

-- Metadata table
CREATE TABLE metadata (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL
);
```

#### Metadata Schema for Vector Entries

```json
{
  "document_id": 123,
  "workspace_id": "default",
  "content_type": "text/markdown",
  "source": "user-input",
  "tags": ["important", "reference"],
  "author": "user",
  "created_at": "2024-02-24T00:00:00Z",
  "updated_at": "2024-02-24T12:34:56Z",
  "embedding_model": "openai-ada-002",
  "embedding_dimension": 1536
}
```

### 4.3 Vector Dimension Specification

**Default:** 1536 dimensions (OpenAI ada-002 compatible)

**Alternative:** 3072 dimensions (configurable for future models)

**Constraint:** Vector dimension must be **uniform** across all components:
- All workspaces in a ClawOS instance must use the same dimension
- Changing dimension requires full re-indexing
- Dimension is stored in workspace metadata.json

**Configuration:**
```json
{
  "vector_dimension": 1536,
  "hnsw_params": {
    "m": 16,
    "ef_construction": 200,
    "ef_search": 50
  }
}
```

### 4.4 HNSW Parameters

| Parameter         | Default | Range    | Description              |
| ----------------- | ------- | -------- | ------------------------ |
| `dimension`       | 1536    | 128-4096 | Vector dimension         |
| `m`               | 16      | 8-64     | Max connections per node |
| `ef_construction` | 200     | 100-1000 | Index build quality      |
| `ef_search`       | 50      | 10-200   | Search quality vs speed  |

**Trade-offs:**
- Higher `m` = better recall, slower build, more memory
- Higher `ef_construction` = better index quality, slower build
- Higher `ef_search` = better search quality, slower query

### 4.5 Search API

#### Full-Text Search (FTS5)

```sql
-- BM25 ranking
SELECT id, content, bm25(documents) as score
FROM documents
WHERE documents MATCH 'search query'
ORDER BY score
LIMIT 10;
```

#### Vector Similarity Search (HNSW)

```sql
-- KNN search
SELECT
    v.id,
    d.content,
    distance(v.embedding, :query_embedding) as similarity
FROM vectors v
JOIN documents d ON v.document_id = d.id
ORDER BY similarity
LIMIT 10;
```

#### Hybrid Search (Combined)

```sql
-- Weighted combination: 0.7 * vector + 0.3 * text
WITH
text_results AS (
    SELECT id, bm25(documents) as text_score
    FROM documents
    WHERE documents MATCH :query
    LIMIT 20
),
vector_results AS (
    SELECT
        v.id,
        1.0 - distance(v.embedding, :query_embedding) as vector_score
    FROM vectors v
    ORDER BY vector_score DESC
    LIMIT 20
)
SELECT
    d.id,
    d.content,
    COALESCE(tr.text_score, 0) * 0.3 + COALESCE(vr.vector_score, 0) * 0.7 as combined_score
FROM documents d
LEFT JOIN text_results tr ON d.id = tr.id
LEFT JOIN vector_results vr ON d.id = vr.id
WHERE tr.id IS NOT NULL OR vr.id IS NOT NULL
ORDER BY combined_score DESC
LIMIT 10;
```

### 4.6 Indexing Workflow

**Step 1: Insert Document**
```sql
INSERT INTO documents (workspace_id, content, metadata)
VALUES ('default', 'Document content here', '{"tags": ["important"]}');
```

**Step 2: Generate Embedding**
```rust
// Call embedding service (OpenAI or local model)
let embedding = generate_embedding("Document content here").await?;
// embedding: Vec<f32> with length 1536
```

**Step 3: Insert Vector**
```sql
INSERT INTO vectors (document_id, embedding, created_at)
VALUES (1, :embedding, '2024-02-24T00:00:00Z');
```

**Step 4: HNSW Index Updates Automatically**
- The HNSW extension automatically updates the index on INSERT
- No manual rebuild required

---

## 5. Identity Files Format

### 5.1 Purpose

Identity Files are the **persistent kernel memory mechanism** for ClawOS agents. They store:
- Agent state snapshots
- Learned patterns and heuristics
- Historical execution context
- Performance metrics

### 5.2 File Location

```
/clawfs/agents/{agent-name}/identity.json
```

Examples:
- `/clawfs/agents/kernel-engine/identity.json`
- `/clawfs/agents/ebpf-agent/identity.json`

### 5.3 Identity File Schema

```json
{
  "agent_id": "kernel-engine",
  "version": 1,
  "created_at": "2024-02-24T00:00:00Z",
  "updated_at": "2024-02-24T12:34:56Z",

  "state": {
    "current_phase": "P2",
    "current_task": "A-01",
    "last_checkpoint": "2024-02-24T10:00:00Z",
    "status": "in_progress"
  },

  "memory": {
    "learned_patterns": [
      {
        "pattern_id": "syscall-pattern-001",
        "description": "Tokio async runtime requires epoll_wait",
        "confidence": 0.95,
        "learned_at": "2024-02-20T15:30:00Z",
        "usage_count": 42
      }
    ],
    "heuristics": [
      {
        "heuristic_id": "resource-estimation-001",
        "rule": "cgroup pids.max >= tokio_threads + wasm_workers + 10",
        "accuracy": 0.88,
        "last_validated": "2024-02-23T09:00:00Z"
      }
    ]
  },

  "history": {
    "completed_tasks": ["A-01", "A-02", "B-01"],
    "failed_tasks": [],
    "total_executions": 156,
    "success_rate": 0.97
  },

  "performance": {
    "avg_execution_time_ms": 2340,
    "peak_memory_mb": 512,
    "last_benchmark": "2024-02-23T18:00:00Z"
  },

  "checksum": "sha256:abc123..."
}
```

### 5.4 Identity File Lifecycle

**Creation:**
- Created on first agent execution
- Initialized with default state

**Updates:**
- Updated after each task completion
- Checksum recalculated on each update
- Atomic write (write to temp file, then rename)

**Persistence:**
- Survives agent restarts
- Survives system reboots
- Backed up to `/clawfs/vault/identity-backups/`

**Migration:**
- Version field allows schema evolution
- Migration scripts handle version upgrades

### 5.5 Checksum Verification

**Algorithm:** SHA-256 of entire JSON (excluding checksum field)

**Purpose:** Detect corruption or tampering

**Verification:**
```rust
fn verify_identity(identity: &IdentityFile) -> bool {
    let json = serde_json::to_string(identity).unwrap();
    let hash = sha256::digest(json);
    hash == identity.checksum.replace("sha256:", "")
}
```

---

## 6. Migration Path from PostgreSQL

### 6.1 Background

IronClaw uses PostgreSQL + pgvector for vector storage. ClawOS replaces this with embedded SQLite + HNSW for:
- Minimal footprint (no separate database process)
- Embedded deployment (single binary)
- Simplified backup (single file)

### 6.2 Migration Strategy (Phase 3, Task E-02)

**Source:** PostgreSQL 15+ with pgvector 0.7+
**Target:** SQLite 3.47+ with HNSW extension

**Migration Steps:**

#### Step 1: Schema Mapping

| PostgreSQL                 | SQLite                               |
| -------------------------- | ------------------------------------ |
| `documents` table          | `documents` FTS5 virtual table       |
| `vectors` table (pgvector) | `vectors` table + HNSW virtual table |
| `metadata` JSONB column    | `metadata` TEXT column (JSON)        |
| `embedding` vector(1536)   | `embedding` BLOB (Float32 array)     |

#### Step 2: Data Export (PostgreSQL)

```sql
-- Export documents
COPY (
    SELECT id, workspace_id, content, metadata::text
    FROM documents
) TO '/tmp/documents.csv' CSV HEADER;

-- Export vectors
COPY (
    SELECT id, document_id, embedding::bytea, created_at
    FROM vectors
) TO '/tmp/vectors.csv' CSV BINARY;
```

#### Step 3: Data Import (SQLite)

```bash
# Import documents
sqlite3 workspace.db <<EOF
.mode csv
.import /tmp/documents.csv documents
EOF

# Import vectors (binary format)
sqlite3 workspace.db <<EOF
.import /tmp/vectors.csv vectors
EOF
```

#### Step 4: Rebuild HNSW Index

```sql
-- HNSW index rebuilds automatically on INSERT
-- No manual rebuild required
```

#### Step 5: Verification

```sql
-- Compare row counts
SELECT (SELECT COUNT(*) FROM documents) as pg_count,
       (SELECT COUNT(*) FROM documents) as sqlite_count;

-- Compare vector dimensions
SELECT array_length(embedding, 1) as dimension FROM vectors LIMIT 1;
```

### 6.3 Migration Tool (Rust)

**Location:** `tools/migrate-pg-to-sqlite/`

**Usage:**
```bash
cargo run --bin migrate-pg-to-sqlite \
  --pg-url "postgresql://user:pass@localhost/ironclaw" \
  --sqlite-path "/clawfs/workspaces/default/workspace.db" \
  --workspace-id "default"
```

**Features:**
- Batch processing (1000 rows per transaction)
- Progress reporting
- Rollback on failure
- Checksum verification

### 6.4 Rollback Plan

If migration fails:
1. Keep PostgreSQL running (dual-write mode)
2. Revert to PostgreSQL for affected workspaces
3. Log failure for investigation
4. Retry migration after fix

### 6.5 Deprecation Timeline

| Phase     | Status                                         |
| --------- | ---------------------------------------------- |
| P1-P2     | PostgreSQL still used (IronClaw compatibility) |
| P3 (E-02) | Migration to SQLite + HNSW                     |
| P3 (E-03) | PostgreSQL removed from codebase               |
| P4        | PostgreSQL dependency fully deprecated         |

---

## 7. POSIX-Compatible Interface

### 7.1 File Operations

ClawFS exposes standard POSIX file operations:

| Operation   | Description            | Example                                                          |
| ----------- | ---------------------- | ---------------------------------------------------------------- |
| `open()`    | Open file              | `fd = open("/clawfs/workspaces/default/workspace.db", O_RDONLY)` |
| `read()`    | Read file content      | `read(fd, buffer, size)`                                         |
| `write()`   | Write file content     | `write(fd, buffer, size)`                                        |
| `close()`   | Close file descriptor  | `close(fd)`                                                      |
| `stat()`    | Get file metadata      | `stat("/clawfs/tools/registry.json", &st)`                       |
| `readdir()` | List directory entries | `readdir("/clawfs/agents/")`                                     |

### 7.2 Extended Attributes (xattr)

ClawFS uses extended attributes for metadata:

```bash
# Set workspace metadata
setfattr -n user.clawfs.vector_dimension -v "1536" /clawfs/workspaces/default/

# Get workspace metadata
getfattr -n user.clawfs.vector_dimension /clawfs/workspaces/default/
```

### 7.3 Inotify Support

ClawFS supports inotify for file change notifications:

```c
// Watch for changes in workspace
int fd = inotify_init();
int wd = inotify_add_watch(fd, "/clawfs/workspaces/default/",
| IN_CREATE |

// Read events
read(fd, buffer, sizeof(buffer));
```

### 7.4 FUSE Integration

ClawFS can be mounted via FUSE for userspace access:

```bash
# Mount ClawFS
clawfs-fuse /clawfs /mnt/clawfs

# Access via standard tools
ls /mnt/clawfs/workspaces/
cat /mnt/clawfs/tools/registry.json
```

---

## 8. Security Considerations

### 8.1 Access Control

| Directory             | Owner      | Group         | Permissions |
| --------------------- | ---------- | ------------- | ----------- |
| `/clawfs/system/`     | root       | root          | 0555        |
| `/clawfs/agents/`     | root       | clawos-agents | 0750        |
| `/clawfs/tools/`      | wasm-agent | clawos-agents | 0755        |
| `/clawfs/workspaces/` | root       | clawos-users  | 0750        |
| `/clawfs/vault/`      | root       | root          | 0700        |
| `/clawfs/specs/`      | root       | root          | 0444        |

### 8.2 seccomp Integration

ClawFS operations are filtered by seccomp-BPF:

```rust
// Allowed syscalls for ClawFS
let allowed = [
    "open", "openat", "read", "write", "close",
    "stat", "fstat", "lstat",
    "readdir", "getdents",
    "mmap", "munmap",
    "ioctl",  // Limited to FUSE ioctls
];
```

### 8.3 AppArmor Integration

ClawFS processes run under AppArmor profile:

```
#include <tunables/global>

profile clawos-fs {
  #include <abstractions/base>

  /clawfs/** r,
  /clawfs/system/** r,
  /clawfs/vault/** r,
  /clawfs/agents/*/workspace.db rw,
  /clawfs/agents/*/identity.json rw,

  deny /clawfs/vault/master-key.enc w,

  capability dac_override,
  capability dac_read_search,
}
```

### 8.4 Audit Logging

All ClawFS operations are logged:

```bash
# Audit log location
/var/log/clawos/clawfs-audit.log

# Log format
2024-02-24T12:34:56Z [INFO] agent=kernel-engine operation=open path=/clawfs/agents/kernel-engine/workspace.db
2024-02-24T12:34:57Z [INFO] agent=kernel-engine operation=read bytes=4096
2024-02-24T12:34:58Z [WARN] agent=unknown operation=write path=/clawfs/vault/master-key.enc denied=true
```

---

## 9. Performance Considerations

### 9.1 SQLite Configuration

```sql
-- Enable WAL mode for better concurrency
PRAGMA journal_mode = WAL;

-- Increase cache size (default: 2MB)
PRAGMA cache_size = -64000;  -- 64MB

-- Enable memory-mapped I/O
PRAGMA mmap_size = 268435456;  -- 256MB

-- Optimize for embedded use
PRAGMA synchronous = NORMAL;
PRAGMA temp_store = MEMORY;
```

### 9.2 HNSW Tuning

**Build-time (ef_construction):**
- Higher = better index quality, slower build
- Default: 200 (good balance)

**Query-time (ef_search):**
- Higher = better recall, slower query
- Default: 50 (good balance)

**Memory usage:**
- Approx: `dimension * 4 * m * num_vectors` bytes
- Example: 1536 * 4 * 16 * 100,000 = ~98 MB

### 9.3 Benchmarks (Target)

| Metric           | Target  | Notes                          |
| ---------------- | ------- | ------------------------------ |
| Document insert  | < 10ms  | Including embedding generation |
| Full-text search | < 50ms  | 1000 results                   |
| Vector search    | < 100ms | Top-10 results                 |
| Hybrid search    | < 150ms | Top-10 results                 |
| Database size    | < 1GB   | 100,000 documents              |

---

## 10. Dependencies and Versions

| Component      | Version      | Purpose                |
| -------------- | ------------ | ---------------------- |
| SQLite         | 3.47+        | Embedded database      |
| HNSW extension | usearch 2.0+ | Vector similarity      |
| aes-gcm        | 0.10+        | AES-256-GCM encryption |
| pbkdf2         | 0.12+        | Key derivation         |
| sha2           | 0.10+        | SHA-256 hashing        |
| serde_json     | 1.0+         | JSON serialization     |

---

## 11. Validation Checklist

Before marking this specification as **FROZEN**, verify:

- [ ] All path namespaces are defined
- [ ] Path naming conventions are consistent
- [ ] Secrets encryption format is complete (AES-256-GCM)
- [ ] Key derivation hierarchy is clear (TPM â†’ Keyring â†’ Per-secret)
- [ ] Vector index storage is specified (SQLite + HNSW)
- [ ] Vector dimension is uniform (1536 default)
- [ ] Identity Files format is defined
- [ ] PostgreSQL migration path is documented
- [ ] POSIX interface is specified
- [ ] Security considerations are addressed
- [ ] Performance targets are defined
- [ ] Dependencies are locked to specific versions

---

## 12. Change History

| Version | Date       | Changes                      | Author            |
| ------- | ---------- | ---------------------------- | ----------------- |
| 1.0.0   | 2024-02-24 | Initial frozen specification | FS Engineer Agent |

---

## 13. References

- SKILLS.md lines 83-84, 230-237 (ClawFS tasks)
- SQLite FTS5 Documentation: https://www.sqlite.org/fts5.html
- HNSW Algorithm: Malkov, Yashunin, "Efficient and robust approximate nearest neighbor search"
- AES-GCM RFC: https://tools.ietf.org/html/rfc5116
- PBKDF2 RFC: https://tools.ietf.org/html/rfc2898
- TPM 2.0 Specification: https://trustedcomputinggroup.org/

---

**END OF SPECIFICATION**

**Status:** ðŸ”’ **FROZEN** (SHA256: `PLACEHOLDER_SHA256_TO_BE_FILLED`)
**Next Phase:** P2.7 â€” ClawFS Rust crate skeleton implementation
