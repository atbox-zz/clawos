# P1.7: Inter-Agent IPC Protocol Specification

**Status:** üîí FROZEN
**Version:** v1.0
**Date:** 2026-02-24
**Owner:** Core Dev Agent
**SHA256:** `SHA256_PLACEHOLDER_TO_BE_FILLED_ON_SIGNING`

---

## Overview

This specification defines the Inter-Process Communication (IPC) protocol used for component communication within ClawOS. The protocol enables secure, reliable message passing between:

- **Agent Loop:** Central orchestration agent
- **WASM Daemon:** WASM runtime manager
- **eBPF Agent:** Kernel monitoring agent
- **Security Agent:** Policy enforcement agent
- **FS Engine:** Filesystem operations agent
- **Observability Agent:** Metrics and logging agent
- **Router:** Message routing component
- **Scheduler:** Task scheduling component

**Transport Layer:** JSON over Unix Domain Sockets (UDS)
**Critical Requirement:** All components MUST implement protocol v1.0. Any breaking change requires version bump and coordinated update.

---

## Design Principles

1. **Explicit Versioning:** Version field in every message for backward compatibility
2. **Correlation Tracking:** message_id + correlation_id for request/response pairing
3. **Type Safety:** Strict message_type enumeration prevents ambiguity
4. **Error Propagation:** Structured error codes map 1:1 to seccomp syscall errors where applicable
5. **Heartbeat Monitoring:** 30-second interval with kernel watchdog integration (D-08)
6. **Timeout Enforcement:** Per-message-type timeout values prevent hanging
7. **Schema Validation:** JSON Schema for runtime validation

---

## Transport Layer

### Unix Domain Socket (UDS) Configuration

| Parameter        | Value                                          | Description                         |
| -----------------| -----------------------------------------------| ------------------------------------|
| Socket Type      | `SOCK_STREAM`                                  | Connection-oriented, reliable       |
| Address Format   | Abstract namespace (`@clawos-ipc-<component>`) | No filesystem pollution             |
| Max Message Size | 4 MiB                                          | Prevents DoS via oversized messages |
| Buffer Size      | 64 KiB                                         | Per-connection send/receive buffer  |
| Backlog          | 128                                            | Pending connection queue            |

**Socket Path Convention:**
```
@clawos-ipc-agent-loop       # Agent Loop listener
@clawos-ipc-wasm-daemon      # WASM Daemon listener
@clawos-ipc-ebpf-agent       # eBPF Agent listener
@clawos-ipc-security-agent   # Security Agent listener
@clawos-ipc-fs-engine        # FS Engine listener
@clawos-ipc-observability    # Observability Agent listener
@clawos-ipc-router           # Router listener
@clawos-ipc-scheduler        # Scheduler listener
```

**Connection Lifecycle:**
1. **Initiation:** Client connects to server's abstract socket
2. **Handshake:** Client sends `HELLO` message with version
3. **Negotiation:** Server responds with `HELLO_ACK` or version mismatch error
4. **Active:** Bidirectional message exchange
5. **Termination:** Either side sends `GOODBYE` or closes socket

---

## Message Format

### Message Envelope

All IPC messages share a common envelope structure:

```json
{
  "version": "1.0",
  "timestamp_ns": 1234567890123456789,
  "sender": "agent-loop",
  "recipient": "wasm-daemon",
  "message_id": "550e8400-e29b-41d4-a716-446655440000",
  "correlation_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "message_type": "request",
  "payload": { ... }
}
```

### Envelope Fields

| Field            | Type             | Required | Description                                 |
| -----------------| -----------------| ---------| --------------------------------------------|
| `version`        | string           | Yes      | Protocol version (e.g., "1.0")              |
| `timestamp_ns`   | integer          | Yes      | Unix timestamp in nanoseconds (UTC)         |
| `sender`         | string           | Yes      | Component identifier (see Component IDs)    |
| `recipient`      | string           | Yes      | Target component identifier                 |
| `message_id`     | string (UUID v4) | Yes      | Unique message identifier                   |
| `correlation_id` | string (UUID v4) | No       | Links request/response pairs                |
| `message_type`   | enum             | Yes      | Message type (request/response/event/error) |
| `payload`        | object           | Yes      | Message-specific payload                    |

### Component IDs

| ID               | Component           | Description           |
| -----------------| --------------------| ----------------------|
| `agent-loop`     | Agent Loop          | Central orchestration |
| `wasm-daemon`    | WASM Daemon         | WASM runtime manager  |
| `ebpf-agent`     | eBPF Agent          | Kernel monitoring     |
| `security-agent` | Security Agent      | Policy enforcement    |
| `fs-engine`      | FS Engine           | Filesystem operations |
| `observability`  | Observability Agent | Metrics and logging   |
| `router`         | Router              | Message routing       |
| `scheduler`      | Scheduler           | Task scheduling       |

---

## Message Types

### 1. REQUEST

**Direction:** Agent A ‚Üí Agent B
**Purpose:** Request an action or data from another component
**Correlation ID:** Required (must be non-null)

#### Request Payload Structure

```json
{
  "method": "execute_tool",
  "params": {
    "tool_name": "bash",
    "arguments": ["ls", "-la"]
  },
  "timeout_ms": 5000
}
```

#### Request Payload Fields

| Field        | Type    | Required | Description                       |
| -------------| --------| ---------| ----------------------------------|
| `method`     | string  | Yes      | Method name to invoke             |
| `params`     | object  | Yes      | Method-specific parameters        |
| `timeout_ms` | integer | No       | Request timeout (default: 5000ms) |

#### Common Request Methods

| Method             | From ‚Üí To                   | Description                    |
| -------------------| ----------------------------| -------------------------------|
| `execute_tool`     | Agent Loop ‚Üí WASM Daemon    | Execute a tool in WASM runtime |
| `get_metrics`      | Any ‚Üí Observability         | Query current metrics          |
| `check_policy`     | Agent Loop ‚Üí Security Agent | Verify action against policy   |
| `read_file`        | Agent Loop ‚Üí FS Engine      | Read file from ClawFS          |
| `write_file`       | Agent Loop ‚Üí FS Engine      | Write file to ClawFS           |
| `schedule_task`    | Agent Loop ‚Üí Scheduler      | Schedule a task                |
| `route_message`    | Router ‚Üí Any                | Route message to destination   |
| `subscribe_events` | Any ‚Üí eBPF Agent            | Subscribe to eBPF events       |

---

### 2. RESPONSE

**Direction:** Agent B ‚Üí Agent A
**Purpose:** Return result or error for a previous request
**Correlation ID:** Must match original request

#### Success Response Payload

```json
{
  "status": "success",
  "result": {
    "exit_code": 0,
    "stdout": "file1.txt\nfile2.txt\n",
    "stderr": ""
  }
}
```

#### Error Response Payload

```json
{
  "status": "error",
  "error_code": 3,
  "error_message": "ENOENT: entity not found",
  "traceback": "at wasm_daemon::execute_tool (src/main.rs:42)\n  at agent_loop::dispatch (src/loop.rs:128)"
}
```

#### Response Payload Fields

| Field           | Type    | Required | Description                            |
| ----------------| --------| ---------| ---------------------------------------|
| `status`        | enum    | Yes      | "success" or "error"                   |
| `result`        | object  | No       | Response data (if success)             |
| `error_code`    | integer | No       | Error code (if error, see Error Codes) |
| `error_message` | string  | No       | Human-readable error description       |
| `traceback`     | string  | No       | Stack trace for debugging              |

---

### 3. EVENT

**Direction:** Any ‚Üí Any (typically unidirectional)
**Purpose:** Asynchronous notification of state changes or occurrences
**Correlation ID:** Optional (null for fire-and-forget events)

#### Event Payload Structure

```json
{
  "event_name": "anomaly_detected",
  "event_data": {
    "event_type": "SYSCALL_ANOMALY",
    "pid": 12345,
    "syscall": "execve",
    "severity": "high",
    "timestamp_ns": 1234567890123456789
  }
}
```

#### Event Payload Fields

| Field        | Type   | Required | Description         |
| -------------| -------| ---------| --------------------|
| `event_name` | string | Yes      | Event identifier    |
| `event_data` | object | Yes      | Event-specific data |

#### Common Event Types

| Event Name           | Source         | Description                        |
| ---------------------| ---------------| -----------------------------------|
| `anomaly_detected`   | eBPF Agent     | Security anomaly detected          |
| `threshold_exceeded` | eBPF Agent     | Resource threshold exceeded        |
| `policy_violation`   | Security Agent | Security policy violation          |
| `task_completed`     | Scheduler      | Task execution completed           |
| `task_failed`        | Scheduler      | Task execution failed              |
| `component_ready`    | Any            | Component initialized and ready    |
| `component_shutdown` | Any            | Component shutting down            |
| `heartbeat`          | Any            | Periodic heartbeat (see Heartbeat) |

---

### 4. ERROR

**Direction:** Any ‚Üí Any
**Purpose:** Propagate critical errors that prevent normal operation
**Correlation ID:** Optional (null for standalone errors)

#### Error Payload Structure

```json
{
  "error_code": 7,
  "error_message": "EINTERNAL: internal error (should be logged)",
  "component": "wasm-daemon",
  "severity": "critical",
  "context": {
    "operation": "load_wasm_module",
    "module_path": "/clawfs/tools/example.wasm"
  },
  "traceback": "at wasm_daemon::load_module (src/loader.rs:67)\n  at wasm_daemon::init (src/main.rs:23)"
}
```

#### Error Payload Fields

| Field           | Type    | Required | Description                      |
| ----------------| --------| ---------| ---------------------------------|
| `error_code`    | integer | Yes      | Error code (see Error Codes)     |
| `error_message` | string  | Yes      | Human-readable error description |
| `component`     | string  | Yes      | Component reporting the error    |
| `severity`      | enum    | Yes      | "warning", "error", "critical"   |
| `context`       | object  | No       | Additional error context         |
| `traceback`     | string  | No       | Stack trace for debugging        |

---

## Error Codes

### Error Code Mapping

| Code | Name      | Description                            | Seccomp Mapping | Action                |
| -----| ----------| ---------------------------------------| ----------------| ----------------------|
| 0    | SUCCESS   | Operation completed successfully       | N/A             | Continue              |
| 1    | EAGAIN    | Operation would block                  | `EAGAIN`        | Retry with backoff    |
| 2    | EIO       | I/O error                              | `EIO`           | Log and retry or fail |
| 3    | ENOENT    | Entity not found                       | `ENOENT`        | Return 404 or create  |
| 4    | EPERM     | Permission denied                      | `EPERM`         | Log security event    |
| 5    | EPROTO    | Protocol error                         | N/A             | Close connection      |
| 6    | ETIMEOUT  | Operation timeout                      | N/A             | Retry or fail         |
| 7    | EINTERNAL | Internal error (should be logged)      | N/A             | Log and escalate      |
| 8    | EPANIC    | Unrecoverable error (trigger rollback) | N/A             | Initiate rollback     |

### Error Code Details

#### 0: SUCCESS
**Description:** Operation completed successfully.
**Action:** Continue normal operation.

#### 1: EAGAIN
**Description:** Operation would block (resource temporarily unavailable).
**Seccomp Mapping:** `EAGAIN` (11)
**Action:** Retry with exponential backoff (initial: 100ms, max: 5s).

#### 2: EIO
**Description:** I/O error (filesystem, network, or device failure).
**Seccomp Mapping:** `EIO` (5)
**Action:** Log error, retry up to 3 times, then fail.

#### 3: ENOENT
**Description:** Entity not found (file, resource, or component missing).
**Seccomp Mapping:** `ENOENT` (2)
**Action:** Return 404 to caller, or create entity if appropriate.

#### 4: EPERM
**Description:** Permission denied (security policy violation).
**Seccomp Mapping:** `EPERM` (1)
**Action:** Log security event, deny operation, notify Security Agent.

#### 5: EPROTO
**Description:** Protocol error (invalid message format, version mismatch).
**Seccomp Mapping:** N/A
**Action:** Close connection, log error, notify sender.

#### 6: ETIMEOUT
**Description:** Operation timeout (no response within timeout period).
**Seccomp Mapping:** N/A
**Action:** Retry up to 2 times, then fail with error.

#### 7: EINTERNAL
**Description:** Internal error (unexpected condition, should be logged).
**Seccomp Mapping:** N/A
**Action:** Log full context and traceback, escalate to Observability Agent.

#### 8: EPANIC
**Description:** Unrecoverable error (system state corrupted, trigger rollback).
**Seccomp Mapping:** N/A
**Action:** Initiate emergency rollback, notify all components, halt new operations.

---

## Heartbeat Mechanism

### Heartbeat Configuration

| Parameter   | Value                  | Description                            |
| ------------| -----------------------| ---------------------------------------|
| Interval    | 30 seconds             | Heartbeat frequency                    |
| Timeout     | 90 seconds             | Time before component marked unhealthy |
| Integration | Kernel watchdog (D-08) | Watchdog integration point             |

### Heartbeat Message Format

```json
{
  "version": "1.0",
  "timestamp_ns": 1234567890123456789,
  "sender": "wasm-daemon",
  "recipient": "agent-loop",
  "message_id": "550e8400-e29b-41d4-a716-446655440000",
  "correlation_id": null,
  "message_type": "event",
  "payload": {
    "event_name": "heartbeat",
    "event_data": {
      "status": "ok",
      "metrics": {
        "uptime_ns": 1234567890123456789,
        "messages_processed": 1234,
        "messages_failed": 2,
        "memory_usage_bytes": 52428800,
        "cpu_usage_percent": 12.5,
        "active_connections": 5
      }
    }
  }
}
```

### Heartbeat Status Values

| Status     | Description                                  | Action                                     |
| -----------| ---------------------------------------------| -------------------------------------------|
| `ok`       | Component operating normally                 | Continue monitoring                        |
| `degraded` | Component experiencing issues but functional | Log warning, increase monitoring frequency |
| `critical` | Component near failure                       | Initiate recovery, notify operators        |

### Heartbeat Metrics

| Metric               | Type    | Description                      |
| ---------------------| --------| ---------------------------------|
| `uptime_ns`          | integer | Component uptime in nanoseconds  |
| `messages_processed` | integer | Total messages processed         |
| `messages_failed`    | integer | Total messages failed            |
| `memory_usage_bytes` | integer | Current memory usage             |
| `cpu_usage_percent`  | float   | Current CPU usage (0-100)        |
| `active_connections` | integer | Number of active IPC connections |

### Watchdog Integration

**Kernel Watchdog (D-08):**
- Each component registers with kernel watchdog on startup
- Watchdog expects heartbeat within 90 seconds (3x interval)
- Missed heartbeat triggers watchdog timeout
- Watchdog can initiate component restart or system rollback

---

## Timeout Values

### Per-Message-Type Timeouts

| Message Type | Default Timeout | Maximum Timeout | Description                                  |
| -------------| ----------------| ----------------| ---------------------------------------------|
| REQUEST      | 5000ms          | 30000ms         | Request-response cycle                       |
| RESPONSE     | N/A             | N/A             | Responses have no timeout (bound by request) |
| EVENT        | N/A             | N/A             | Events are fire-and-forget                   |
| ERROR        | N/A             | N/A             | Errors are immediate                         |
| HEARTBEAT    | 90000ms         | 90000ms         | Watchdog timeout (3x interval)               |

### Method-Specific Timeouts

| Method             | Default Timeout | Rationale                    |
| -------------------| ----------------| -----------------------------|
| `execute_tool`     | 10000ms         | Tool execution may take time |
| `get_metrics`      | 2000ms          | Metrics query should be fast |
| `check_policy`     | 1000ms          | Policy check should be fast  |
| `read_file`        | 5000ms          | File I/O may be slow         |
| `write_file`       | 5000ms          | File I/O may be slow         |
| `schedule_task`    | 2000ms          | Scheduling should be fast    |
| `route_message`    | 1000ms          | Routing should be fast       |
| `subscribe_events` | 2000ms          | Subscription setup           |

### Timeout Handling

**On Timeout:**
1. Log timeout event with context
2. Send ERROR message to sender with `ETIMEOUT` (6)
3. Close connection if 3 consecutive timeouts
4. Notify Observability Agent for monitoring

---

## Backward Compatibility

### Version Field

The `version` field in the message envelope enables backward compatibility:

**Version Negotiation:**
1. Client connects with `HELLO` message containing supported versions
2. Server responds with highest mutually supported version
3. If no common version, connection is rejected with `EPROTO` (5)

**Version Compatibility Matrix:**

| Client Version | Server 1.0 | Server 1.1 | Server 2.0 |
| ---------------| -----------| -----------| -----------|
| 1.0            | ‚úÖ 1.0      | ‚úÖ 1.0      | ‚ùå Reject   |
| 1.1            | ‚úÖ 1.0      | ‚úÖ 1.1      | ‚ùå Reject   |
| 2.0            | ‚ùå Reject   | ‚ùå Reject   | ‚úÖ 2.0      |

**Version Evolution Rules:**
1. **Minor version bump (1.0 ‚Üí 1.1):** Additive changes only (new fields, new methods)
2. **Major version bump (1.x ‚Üí 2.0):** Breaking changes (removed fields, changed semantics)
3. **Deprecated fields:** Mark as deprecated in documentation, remove in next major version
4. **Unknown fields:** Must be ignored by older versions (forward compatibility)

### Migration Strategy

**When upgrading from v1.0 to v1.1:**
1. Deploy v1.1 to all components (canary first)
2. Monitor for compatibility issues
3. Once stable, v1.0 can be deprecated
4. Remove v1.0 support in v2.0

**Rollback Plan:**
1. If v1.1 causes issues, rollback to v1.0
2. All components must support rollback within 5 minutes
3. Use `EPANIC` (8) to trigger system-wide rollback if needed

---

## JSON Schema

### Complete Message Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://clawos.org/schemas/ipc-message-v1.0.json",
  "title": "ClawOS IPC Message",
  "description": "Inter-Agent IPC Protocol Message Format v1.0",
  "type": "object",
  "required": [
    "version",
    "timestamp_ns",
    "sender",
    "recipient",
    "message_id",
    "message_type",
    "payload"
  ],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$",
      "description": "Protocol version (e.g., '1.0')"
    },
    "timestamp_ns": {
      "type": "integer",
      "minimum": 0,
      "description": "Unix timestamp in nanoseconds (UTC)"
    },
    "sender": {
      "type": "string",
      "enum": [
        "agent-loop",
        "wasm-daemon",
        "ebpf-agent",
        "security-agent",
        "fs-engine",
        "observability",
        "router",
        "scheduler"
      ],
      "description": "Component identifier"
    },
    "recipient": {
      "type": "string",
      "enum": [
        "agent-loop",
        "wasm-daemon",
        "ebpf-agent",
        "security-agent",
        "fs-engine",
        "observability",
        "router",
        "scheduler"
      ],
      "description": "Target component identifier"
    },
    "message_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique message identifier (UUID v4)"
    },
    "correlation_id": {
      "type": ["string", "null"],
      "format": "uuid",
      "description": "Links request/response pairs (UUID v4 or null)"
    },
    "message_type": {
      "type": "string",
      "enum": ["request", "response", "event", "error"],
      "description": "Message type"
    },
    "payload": {
      "type": "object",
      "description": "Message-specific payload (see payload schemas)"
    }
  }
}
```

### Request Payload Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://clawos.org/schemas/ipc-request-v1.0.json",
  "title": "ClawOS IPC Request Payload",
  "type": "object",
  "required": ["method", "params"],
  "properties": {
    "method": {
      "type": "string",
      "description": "Method name to invoke"
    },
    "params": {
      "type": "object",
      "description": "Method-specific parameters"
    },
    "timeout_ms": {
      "type": "integer",
      "minimum": 0,
      "maximum": 30000,
      "default": 5000,
      "description": "Request timeout in milliseconds"
    }
  }
}
```

### Response Payload Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://clawos.org/schemas/ipc-response-v1.0.json",
  "title": "ClawOS IPC Response Payload",
  "type": "object",
  "required": ["status"],
  "properties": {
    "status": {
      "type": "string",
      "enum": ["success", "error"],
      "description": "Response status"
    },
    "result": {
      "type": "object",
      "description": "Response data (if success)"
    },
    "error_code": {
      "type": "integer",
      "minimum": 0,
      "maximum": 8,
      "description": "Error code (if error)"
    },
    "error_message": {
      "type": "string",
      "description": "Human-readable error description (if error)"
    },
    "traceback": {
      "type": "string",
      "description": "Stack trace for debugging (if error)"
    }
  },
  "if": {
    "properties": { "status": { "const": "success" } }
  },
  "then": {
    "required": ["result"]
  },
  "else": {
    "required": ["error_code", "error_message"]
  }
}
```

### Event Payload Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://clawos.org/schemas/ipc-event-v1.0.json",
  "title": "ClawOS IPC Event Payload",
  "type": "object",
  "required": ["event_name", "event_data"],
  "properties": {
    "event_name": {
      "type": "string",
      "description": "Event identifier"
    },
    "event_data": {
      "type": "object",
      "description": "Event-specific data"
    }
  }
}
```

### Error Payload Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://clawos.org/schemas/ipc-error-v1.0.json",
  "title": "ClawOS IPC Error Payload",
  "type": "object",
  "required": ["error_code", "error_message", "component", "severity"],
  "properties": {
    "error_code": {
      "type": "integer",
      "minimum": 0,
      "maximum": 8,
      "description": "Error code"
    },
    "error_message": {
      "type": "string",
      "description": "Human-readable error description"
    },
    "component": {
      "type": "string",
      "enum": [
        "agent-loop",
        "wasm-daemon",
        "ebpf-agent",
        "security-agent",
        "fs-engine",
        "observability",
        "router",
        "scheduler"
      ],
      "description": "Component reporting the error"
    },
    "severity": {
      "type": "string",
      "enum": ["warning", "error", "critical"],
      "description": "Error severity"
    },
    "context": {
      "type": "object",
      "description": "Additional error context"
    },
    "traceback": {
      "type": "string",
      "description": "Stack trace for debugging"
    }
  }
}
```

### Heartbeat Event Data Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://clawos.org/schemas/ipc-heartbeat-v1.0.json",
  "title": "ClawOS IPC Heartbeat Event Data",
  "type": "object",
  "required": ["status", "metrics"],
  "properties": {
    "status": {
      "type": "string",
      "enum": ["ok", "degraded", "critical"],
      "description": "Component health status"
    },
    "metrics": {
      "type": "object",
      "required": [
        "uptime_ns",
        "messages_processed",
        "messages_failed",
        "memory_usage_bytes",
        "cpu_usage_percent",
        "active_connections"
      ],
      "properties": {
        "uptime_ns": {
          "type": "integer",
          "minimum": 0,
          "description": "Component uptime in nanoseconds"
        },
        "messages_processed": {
          "type": "integer",
          "minimum": 0,
          "description": "Total messages processed"
        },
        "messages_failed": {
          "type": "integer",
          "minimum": 0,
          "description": "Total messages failed"
        },
        "memory_usage_bytes": {
          "type": "integer",
          "minimum": 0,
          "description": "Current memory usage in bytes"
        },
        "cpu_usage_percent": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Current CPU usage (0-100)"
        },
        "active_connections": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of active IPC connections"
        }
      }
    }
  }
}
```

---

## Security Considerations

### Authentication

**Unix Domain Socket Credentials:**
- All UDS connections automatically carry peer credentials (PID, UID, GID)
- Components MUST verify peer UID matches expected component UID
- Reject connections from unauthorized UIDs

### Authorization

**Component Access Control:**
- Each component has a whitelist of allowed senders/recipients
- Router enforces access control rules
- Security Agent audits all IPC traffic

### Message Validation

**Schema Validation:**
- All incoming messages MUST be validated against JSON Schema
- Reject malformed messages with `EPROTO` (5)
- Log validation failures for security monitoring

### Rate Limiting

**Per-Connection Limits:**
- Max 100 messages/second per connection
- Burst allowance: 200 messages
- Exceeding limits triggers temporary throttling

---

## Implementation Notes

### Rust Implementation (Phase 2, D-01~D-02)

**Recommended Crates:**
- `tokio::net::UnixStream` - Async UDS support
- `serde_json` - JSON serialization/deserialization
- `uuid` - UUID generation
- `jsonschema` - Schema validation

**Key Components:**
1. `IpcClient` - Client connection management
2. `IpcServer` - Server listener and connection handling
3. `Message` - Message envelope and payload types
4. `Error` - Error code enum and handling
5. `Heartbeat` - Heartbeat timer and watchdog integration

### Systemd Socket Activation (Phase 2, G-02)

**Socket Unit Configuration:**
```ini
[Unit]
Description=ClawOS IPC Socket for %i

[Socket]
ListenStream=@clawos-ipc-%i
Service=clawos-%i.service

[Install]
WantedBy=sockets.target
```

---

## Appendix A: Message Flow Examples

### Example 1: Tool Execution (Request/Response)

**Agent Loop ‚Üí WASM Daemon:**
```json
{
  "version": "1.0",
  "timestamp_ns": 1234567890123456789,
  "sender": "agent-loop",
  "recipient": "wasm-daemon",
  "message_id": "550e8400-e29b-41d4-a716-446655440000",
  "correlation_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "message_type": "request",
  "payload": {
    "method": "execute_tool",
    "params": {
      "tool_name": "bash",
      "arguments": ["ls", "-la"]
    },
    "timeout_ms": 5000
  }
}
```

**WASM Daemon ‚Üí Agent Loop:**
```json
{
  "version": "1.0",
  "timestamp_ns": 1234567891123456789,
  "sender": "wasm-daemon",
  "recipient": "agent-loop",
  "message_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440000",
  "message_type": "response",
  "payload": {
    "status": "success",
    "result": {
      "exit_code": 0,
      "stdout": "file1.txt\nfile2.txt\n",
      "stderr": ""
    }
  }
}
```

### Example 2: Anomaly Detection (Event)

**eBPF Agent ‚Üí Agent Loop:**
```json
{
  "version": "1.0",
  "timestamp_ns": 1234567890123456789,
  "sender": "ebpf-agent",
  "recipient": "agent-loop",
  "message_id": "550e8400-e29b-41d4-a716-446655440000",
  "correlation_id": null,
  "message_type": "event",
  "payload": {
    "event_name": "anomaly_detected",
    "event_data": {
      "event_type": "SYSCALL_ANOMALY",
      "pid": 12345,
      "syscall": "execve",
      "severity": "high",
      "timestamp_ns": 1234567890123456789
    }
  }
}
```

### Example 3: Error Propagation (Error)

**WASM Daemon ‚Üí Agent Loop:**
```json
{
  "version": "1.0",
  "timestamp_ns": 1234567890123456789,
  "sender": "wasm-daemon",
  "recipient": "agent-loop",
  "message_id": "550e8400-e29b-41d4-a716-446655440000",
  "correlation_id": null,
  "message_type": "error",
  "payload": {
    "error_code": 7,
    "error_message": "EINTERNAL: internal error (should be logged)",
    "component": "wasm-daemon",
    "severity": "critical",
    "context": {
      "operation": "load_wasm_module",
      "module_path": "/clawfs/tools/example.wasm"
    },
    "traceback": "at wasm_daemon::load_module (src/loader.rs:67)\n  at wasm_daemon::init (src/main.rs:23)"
  }
}
```

### Example 4: Heartbeat (Event)

**WASM Daemon ‚Üí Agent Loop:**
```json
{
  "version": "1.0",
  "timestamp_ns": 1234567890123456789,
  "sender": "wasm-daemon",
  "recipient": "agent-loop",
  "message_id": "550e8400-e29b-41d4-a716-446655440000",
  "correlation_id": null,
  "message_type": "event",
  "payload": {
    "event_name": "heartbeat",
    "event_data": {
      "status": "ok",
      "metrics": {
        "uptime_ns": 1234567890123456789,
        "messages_processed": 1234,
        "messages_failed": 2,
        "memory_usage_bytes": 52428800,
        "cpu_usage_percent": 12.5,
        "active_connections": 5
      }
    }
  }
}
```

---

## Appendix B: Error Code Reference

### Quick Reference

| Code | Name      | Retry? | Log Level | Action           |
| -----| ----------| -------| ----------| -----------------|
| 0    | SUCCESS   | N/A    | DEBUG     | Continue         |
| 1    | EAGAIN    | Yes    | INFO      | Backoff retry    |
| 2    | EIO       | Yes    | WARNING   | Retry 3x         |
| 3    | ENOENT    | No     | INFO      | Return 404       |
| 4    | EPERM     | No     | ERROR     | Security event   |
| 5    | EPROTO    | No     | ERROR     | Close connection |
| 6    | ETIMEOUT  | Yes    | WARNING   | Retry 2x         |
| 7    | EINTERNAL | No     | ERROR     | Escalate         |
| 8    | EPANIC    | No     | CRITICAL  | Rollback         |

### Seccomp Mapping Table

| IPC Code | Seccomp Code | Seccomp Name | Description                      |
| ---------| -------------| -------------| ---------------------------------|
| 1        | 11           | EAGAIN       | Resource temporarily unavailable |
| 2        | 5            | EIO          | I/O error                        |
| 3        | 2            | ENOENT       | No such file or directory        |
| 4        | 1            | EPERM        | Operation not permitted          |
| 5        | N/A          | N/A          | Protocol error (IPC-specific)    |
| 6        | N/A          | N/A          | Timeout (IPC-specific)           |
| 7        | N/A          | N/A          | Internal error (IPC-specific)    |
| 8        | N/A          | N/A          | Panic (IPC-specific)             |

---

## Appendix C: Version History

### v1.0 (2026-02-24)
- Initial release
- Define message envelope format
- Define 4 message types (request, response, event, error)
- Define 8 error codes with seccomp mapping
- Define heartbeat mechanism (30s interval)
- Define timeout values per message type
- Define backward compatibility strategy
- Include JSON Schema for validation

---

## References

- **P1.2:** seccomp syscall whitelist (error code mapping)
- **P1.3:** eBPF event struct format (anomaly events)
- **P1.4:** ClawFS filesystem specification (file operations)
- **D-08:** Kernel watchdog integration (heartbeat monitoring)
- **D-01~D-02:** Rust IPC implementation (Phase 2)
- **G-02:** Systemd socket activation (Phase 2)

---

**END OF SPECIFICATION**
