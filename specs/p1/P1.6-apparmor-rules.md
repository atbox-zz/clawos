# P1.6: AppArmor Profile Rule Language Specification

**Status:** FROZEN
**Version:** 1.0.0
**Spec ID:** P1.6
**Owner:** Security Agent
**Created:** 2026-02-24T00:00:00Z
**SHA256 Signature:** PLACEHOLDER_SHA256_SIGNATURE

---

## Table of Contents

1. [Overview](#overview)
2. [Security Hierarchy](#security-hierarchy)
3. [EBNF Grammar](#ebnf-grammar)
4. [Component Profiles](#component-profiles)
5. [Rule Types](#rule-types)
6. [Transition Rules](#transition-rules)
7. [Deny Rules](#deny-rules)
8. [Example Profiles](#example-profiles)
9. [Validation Rules](#validation-rules)

---

## Overview

This specification defines the AppArmor profile rule language for ClawOS, providing mandatory access control (MAC) for all system components. AppArmor profiles confine processes to a limited set of files, capabilities, and network operations, working in conjunction with eBPF LSM and seccomp to form a defense-in-depth security architecture.

### Scope

This specification covers:
- AppArmor profile syntax for all ClawOS components
- File path rules with allowed operations
- Network rules with allowlist enforcement
- Linux capability grants (minimum required principle)
- Profile transition rules (complain → enforce workflow)
- Security-sensitive operation deny rules
- EBNF grammar for the rule language

### Components with AppArmor Profiles

| Component          | Profile Name         | Security Level | Primary Concerns                      |
| -------------------| ---------------------| ---------------| --------------------------------------|
| clawos-agent-loop  | `clawos-agent-loop`  | MODERATE       | PostgreSQL access, BPF loading        |
| clawos-wasm-daemon | `clawos-wasm-daemon` | STRICT         | File confinement, syscall restriction |
| clawos-kernel-svc  | `clawos-kernel-svc`  | MODERATE       | Device access, kernel interaction     |

---

## Security Hierarchy

ClawOS implements a layered security model where each layer can veto operations. The hierarchy from most restrictive to least restrictive is:

```
┌─────────────────────────────────────────────────────────────┐
│                    eBPF LSM (Layer 1)                       │
│  - Real-time anomaly detection                              │
│  - Custom security hooks (file_open, socket_connect)        │
│  - XDP network filtering (TCP:5432 only)                    │
│  - VETO POWER: Can DENY any operation                       │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  AppArmor (Layer 2)                         │
│  - Mandatory access control (MAC)                           │
│  - File path confinement                                    │
│  - Capability restriction                                   │
│  - Network allowlist enforcement                            │
│  - VETO POWER: Can DENY any operation                       │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    DAC (Layer 3)                            │
│  - Traditional Unix permissions (rwx)                       │
│  - User/group ownership                                     │
│  - VETO POWER: Can DENY based on permissions                │
└─────────────────────────────────────────────────────────────┘
```

### Layer Interaction Rules

1. **eBPF LSM has final veto authority**: Even if AppArmor and DAC allow an operation, eBPF LSM can deny it based on anomaly detection or custom security policies.

2. **AppArmor enforces confinement**: AppArmor profiles restrict what files, capabilities, and network operations a process can use, regardless of DAC permissions.

3. **DAC provides baseline**: Traditional Unix permissions still apply, but are superseded by AppArmor and eBPF LSM when more restrictive.

4. **Deny propagation**: If any layer denies an operation, the operation is blocked. All layers must allow for the operation to proceed.

### Security Agent Veto Power

The Security Agent has veto power on all security decisions:
- Can override profile transitions (block enforce mode)
- Can modify deny rules without requiring consensus
- Can add temporary emergency restrictions
- Must approve all profile changes before deployment

---

## EBNF Grammar

The AppArmor profile rule language for ClawOS follows this EBNF grammar:

```ebnf
(* AppArmor Profile Rule Language EBNF Grammar for ClawOS *)

<profile> ::= <profile_header> <profile_body> <profile_footer>

<profile_header> ::= <profile_declaration> <profile_flags> <profile_includes>

<profile_declaration> ::= 'profile' <profile_name> <profile_flags> '{' newline

<profile_name> ::= <identifier>
| <digit> | '-' |

<profile_flags> ::= { <profile_flag> }
<profile_flag> ::= 'flags=' '(' <flag_list> ')'
<flag_list> ::= <flag> { ',' <flag> }
| 'audit' | 'mediate_deleted' |

<profile_includes> ::= { <include_directive> }
<include_directive> ::= '#include' '<' <include_path> '>' newline
<include_path> ::= <abstractions_path> | <tunables_path>

<profile_body> ::= { <rule_block> }

<rule_block> ::= <capability_rule>
              | <file_rule>
              | <network_rule>
              | <mount_rule>
              | <pivot_root_rule>
              | <ptrace_rule>
              | <signal_rule>
              | <dbus_rule>
              | <unix_rule>
              | <rlimit_rule>
              | <change_profile_rule>
              | <deny_rule>

(* Capability Rules *)
<capability_rule> ::= <capability_allow> | <capability_deny>
<capability_allow> ::= 'capability' <capability_set> ','
<capability_deny> ::= 'deny capability' <capability_set> ','
<capability_set> ::= <capability_name> | <capability_list>
<capability_list> ::= '{' <capability_name> { ',' <capability_name> } '}'

| 'dac_override'    | 'dac_read_search'  |
| 'fsetid'          | 'kill'             | 'setgid'      | 'setuid' |
| 'linux_immutable' | 'net_bind_service' |
| 'net_admin'       | 'net_raw'          | 'ipc_lock'    |
| 'sys_module'      | 'sys_rawio'        | 'sys_chroot'  |
| 'sys_pacct'       | 'sys_admin'        | 'sys_boot'    |
| 'sys_resource'    | 'sys_time'         |
| 'mknod'           | 'lease'            | 'audit_write' |
| 'setfcap'         | 'mac_override'     | 'mac_admin'   |
| 'wake_alarm'      | 'block_suspend'    |
| 'perfmon'         | 'bpf'              |

(* File Rules *)
<file_rule> ::= <file_allow> | <file_deny>
<file_allow> ::= <file_path> <file_permissions> ','
<file_deny> ::= 'deny' <file_path> <file_permissions> ','

<file_path> ::= <absolute_path> | <pattern_path>
<absolute_path> ::= '/' <path_segment> { '/' <path_segment> }
<pattern_path> ::= <absolute_path> '*' | <absolute_path> '**'

|  |
| '?' |
<char_class> ::= <char> { '-' <char> }

<file_permissions> ::= <permission_set>
<permission_set> ::= <permission> { <permission> }
| 'w'  | 'a'  | 'l'  | 'k'  | 'm'  | 'x'  | 'ix' | 'Ux' |
| 'Px' | 'px' | 'Cx' | 'cx' | 'ix' | 'Ux' |

(* r: read, w: write, a: append, l: link, k: lock, m: mmap, x: execute *)
(* ix: inherit execute, Ux: unconfined execute, ux: unconfined execute with cleanup *)
(* Px: discrete profile execute, px: discrete profile execute with cleanup *)
(* Cx: child profile execute, cx: child profile execute with cleanup *)

(* Network Rules *)
<network_rule> ::= <network_allow> | <network_deny>
<network_allow> ::= 'network' <network_family> <network_type> <network_protocol> ','
<network_deny> ::= 'deny network' <network_family> <network_type> <network_protocol> ','

|  |
| 'inet'     | 'inet6'   | 'ax25'      | 'ipx'    |
| 'atmpvc'   | 'x25'     | 'rose'      | 'decnet' |
| 'security' | 'key'     | 'netlink'   | 'packet' |
| 'econet'   | 'atmsvc'  | 'rds'       | 'sna'    |
| 'pppox'    | 'wanpipe' | 'llc'       | 'ib'     |
| 'can'      | 'tipc'    | 'bluetooth' | 'iucv'   |
| 'kcm'      | 'qipcrtr' | 'smc'       |

|  |
| 'dgram' | 'seqpacket' | 'rdm' |
<type_list> ::= '{' <type_name> { ',' <type_name> } '}'

|  |
| 'udp' | 'icmp' | 'icmpv6' | 'ip' |
<protocol_list> ::= '{' <protocol_name> { ',' <protocol_name> } '}'

(* Mount Rules *)
<mount_rule> ::= <mount_allow> | <mount_deny>
<mount_allow> ::= 'mount' <mount_options> ','
<mount_deny> ::= 'deny mount' <mount_options> ','

<mount_options> ::= <mount_spec> <mount_point> <mount_type> <mount_flags>
<mount_spec> ::= <file_path>
<mount_point> ::= <file_path>
<mount_type> ::= <identifier>
<mount_flags> ::= '(' <mount_flag_list> ')'
<mount_flag_list> ::= <mount_flag> { ',' <mount_flag> }
| 'rw'         | 'nosuid'      | 'nodev' | 'noexec' |
| 'remount'    | 'bind'        | 'rbind' | 'move'   |
| 'make-slave' | 'make-shared' |

(* Pivot Root Rules *)
<pivot_root_rule> ::= <pivot_root_allow> | <pivot_root_deny>
<pivot_root_allow> ::= 'pivot_root' <old_root> <new_root> ','
<pivot_root_deny> ::= 'deny pivot_root' <old_root> <new_root> ','
<old_root> ::= <file_path>
<new_root> ::= <file_path>

(* Ptrace Rules *)
<ptrace_rule> ::= <ptrace_allow> | <ptrace_deny>
<ptrace_allow> ::= 'ptrace' <ptrace_peer> ','
<ptrace_deny> ::= 'deny ptrace' <ptrace_peer> ','
<ptrace_peer> ::= <peer_label> | <peer_set>
<peer_label> ::= <profile_name>
<peer_set> ::= '{' <peer_label> { ',' <peer_label> } '}'

(* Signal Rules *)
<signal_rule> ::= <signal_allow> | <signal_deny>
<signal_allow> ::= 'signal' <signal_set> <signal_peer> ','
<signal_deny> ::= 'deny signal' <signal_set> <signal_peer> ','
|  |
| 'int'    | 'quit' | 'ill'    | 'trap' | 'abrt' |
| 'fpe'    | 'kill' | 'usr1'   | 'segv' | 'usr2' |
| 'alrm'   | 'term' | 'stkflt' | 'chld' | 'cont' |
| 'stp'    | 'ttin' | 'ttou'   | 'urg'  | 'xcpu' |
| 'vtalrm' | 'prof' | 'winch'  | 'io'   | 'pwr'  |
| 'emt'    |
<signal_list> ::= '{' <signal_name> { ',' <signal_name> } '}'

(* D-Bus Rules *)
<dbus_rule> ::= <dbus_allow> | <dbus_deny>
<dbus_allow> ::= 'dbus' <dbus_bus> <dbus_path> <dbus_interface> <dbus_member> <dbus_peer> ','
<dbus_deny> ::= 'deny dbus' <dbus_bus> <dbus_path> <dbus_interface> <dbus_member> <dbus_peer> ','
| 'session' | 'accessibility' |
<dbus_path> ::= 'path=' <string_literal>
<dbus_interface> ::= 'interface=' <string_literal>
<dbus_member> ::= 'member=' <string_literal>
<dbus_peer> ::= 'peer=' '(' <peer_label> ')'

(* Unix Socket Rules *)
<unix_rule> ::= <unix_allow> | <unix_deny>
<unix_allow> ::= 'unix' <unix_type> <unix_address> <unix_peer> ','
<unix_deny> ::= 'deny unix' <unix_type> <unix_address> <unix_peer> ','
<unix_type> ::= <type_name> | <type_list>
<unix_address> ::= 'addr=' <string_literal>
<unix_peer> ::= 'peer=' '(' <peer_label> ')'

(* Resource Limit Rules *)
<rlimit_rule> ::= <rlimit_allow> | <rlimit_deny>
<rlimit_allow> ::= 'set rlimit' <rlimit_name> <rlimit_value> ','
<rlimit_deny> ::= 'deny set rlimit' <rlimit_name> <rlimit_value> ','
| 'fsize'      | 'data'     | 'stack'   | 'core'   |
| 'nproc'      | 'nofile'   | 'memlock' | 'as'     |
| 'sigpending' | 'msgqueue' | 'nice'    | 'rtprio' |
|  |

(* Change Profile Rules *)
<change_profile_rule> ::= 'change_profile' <target_profile> ','
<target_profile> ::= <profile_name>

(* Deny Rules *)
| <deny_network_rule> |
<deny_file_rule> ::= 'deny' <file_path> <file_permissions> ','
<deny_network_rule> ::= 'deny network' <network_family> <network_type> <network_protocol> ','
<deny_capability_rule> ::= 'deny capability' <capability_set> ','

<profile_footer> ::= '}'

(* Comments *)
<comment> ::= '#' <any_text> newline

(* Literals *)
<string_literal> ::= '"' <text> '"'
<integer> ::= <digit> { <digit> }
| '1' | '2' | '3' | '4' | '5' | '6' | '7' | '8' |
| 'B' | 'C' | 'D' | 'E' | 'F' | 'G' | 'H' | 'I' |
| 'K' | 'L' | 'M' | 'N' | 'O' | 'P' | 'Q' | 'R' | 'S' |
| 'U' | 'V' | 'W' | 'X' | 'Y' | 'Z' | 'a' | 'b' | 'c' |
| 'e' | 'f' | 'g' | 'h' | 'i' | 'j' | 'k' | 'l' | 'm' |
| 'o' | 'p' | 'q' | 'r' | 's' | 't' | 'u' | 'v' | 'w' |
| 'y' |
<any_text> ::= { <any_char> }
| <digit> | ' ' | '\t' | '!' | '@' | '#' |
| '%'     | '^' | '&'  | '*' | '(' | ')' | '-' | '_'  |
| '='     | '[' | ']'  | '{' | '}' | '   | '   | '\\' | ';' |
| '\''    | '"' | '<'  | '>' | ',' | '.' | '?' | '/'  | '`' |
newline ::= '\n'
```

---

## Component Profiles

### clawos-agent-loop

**Profile Name:** `clawos-agent-loop`
**Security Level:** MODERATE
**Primary Concerns:** PostgreSQL access, BPF loading, network communication

#### Profile Specification

```apparmor
# clawos-agent-loop AppArmor Profile
# Security Level: MODERATE
# Owner: Security Agent
# Status: FROZEN

#include <tunables/global>

profile clawos-agent-loop flags=(attach_disconnected) {
  # Include base abstractions
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openssl>
  #include <abstractions/perl>

  # Capability grants (minimum required principle)
  capability net_bind_service,    # Bind to privileged ports if needed
  capability bpf,                  # Load eBPF programs for monitoring
  capability dac_read_search,      # Search directories for file access
  capability dac_override,         # Override DAC for specific operations (MINIMAL)

  # PostgreSQL network access (monitored by XDP)
  network inet stream tcp to 127.0.0.1 port 5432,
  network inet6 stream tcp to ::1 port 5432,

  # Deny all other network access
  deny network inet stream,
  deny network inet6 stream,
  deny network inet dgram,
  deny network inet6 dgram,
  deny network inet raw,
  deny network inet6 raw,

  # File access - ClawFS workspace
  /var/lib/clawos/workspace/** rw,
  /var/lib/clawos/workspace/**/ r,

  # File access - Configuration
  /etc/clawos/** r,
  /etc/clawos/config.json rw,

  # File access - Logs
  /var/log/clawos/agent-loop.log w,
  /var/log/clawos/agent-loop.log* rw,

  # File access - Runtime
  /run/clawos/** rw,
  /run/clawos/agent-loop.sock rw,

  # File access - Temporary files
  /tmp/clawos-agent-loop/** rw,
  owner /tmp/** rw,

  # File access - System libraries
  /usr/lib/** r,
  /usr/lib64/** r,
  /lib/** r,
  /lib64/** r,

  # File access - Executables
  /usr/bin/** ix,
  /bin/** ix,

  # Deny sensitive file modifications
  deny /etc/passwd w,
  deny /etc/shadow w,
  deny /etc/group w,
  deny /etc/gshadow w,
  deny /etc/sudoers w,
  deny /etc/ssh/** w,

  # Deny kernel module operations
  deny /sys/module/** w,
  deny /proc/sys/** w,

  # Deny device access (except through eBPF)
  deny /dev/** rw,

  # Signal permissions
  signal (receive) peer=clawos-wasm-daemon,
  signal (receive) peer=clawos-kernel-svc,

  # Change profile for subprocesses
  change_profile -> clawos-wasm-daemon,

  # Ptrace restrictions
  deny ptrace (read,trace) peer=unconfined,
}
```

#### Security Notes

1. **CAP_BPF Conflict Resolution**: The `capability bpf` grant is required for loading eBPF monitoring programs. This is a documented LOW conflict resolution. The eBPF LSM layer provides additional validation before any BPF program is loaded.

2. **PostgreSQL Access**: Network access is restricted to PostgreSQL (TCP:5432) on localhost only. All other network access is explicitly denied. The XDP layer provides additional monitoring of PostgreSQL connections.

3. **File Confinement**: The agent loop is confined to `/var/lib/clawos/workspace/`, `/etc/clawos/`, and `/var/log/clawos/`. Access to system files is read-only where necessary.

4. **Sensitive File Protection**: Explicit deny rules prevent modification of `/etc/passwd`, `/etc/shadow`, and other security-sensitive files.

---

### clawos-wasm-daemon

**Profile Name:** `clawos-wasm-daemon`
**Security Level:** STRICT
**Primary Concerns:** File confinement, syscall restriction, network isolation

#### Profile Specification

```apparmor
# clawos-wasm-daemon AppArmor Profile
# Security Level: STRICT
# Owner: Security Agent
# Status: FROZEN

#include <tunables/global>

profile clawos-wasm-daemon flags=(attach_disconnected,mediate_deleted) {
  # Include base abstractions
  #include <abstractions/base>

  # Capability grants (minimum required principle)
  # NO CAPABILITIES GRANTED - STRICT ISOLATION

  # Deny all network access (WASM must use host function)
  deny network inet,
  deny network inet6,
  deny network unix,
  deny network packet,
  deny network ax25,
  deny network ipx,
  deny network netrom,
  deny network atmpvc,
  deny network x25,
  deny network rose,
  deny network decnet,
  deny network netbeui,
  deny network security,
  deny network key,
  deny network netlink,
  deny network ash,
  deny network econet,
  deny network atmsvc,
  deny network rds,
  deny network sna,
  deny network irda,
  deny network pppox,
  deny network wanpipe,
  deny network llc,
  deny network ib,
  deny network mpls,
  deny network can,
  deny network tipc,
  deny network bluetooth,
  deny network iucv,
  deny network rxrpc,
  deny network kcm,
  deny network qipcrtr,
  deny network smc,
  deny network xdp,

  # File access - WASM sandbox directory
  /var/lib/clawos/wasm-sandbox/** rw,
  /var/lib/clawos/wasm-sandbox/**/ r,

  # File access - WASM tool cache (read-only)
  /var/lib/clawos/wasm-cache/** r,

  # File access - Configuration (read-only)
  /etc/clawos/wasm/** r,

  # File access - Logs
  /var/log/clawos/wasm-daemon.log w,
  /var/log/clawos/wasm-daemon.log* rw,

  # File access - Runtime
  /run/clawos/wasm/** rw,
  /run/clawos/wasm.sock rw,

  # File access - Temporary files (isolated)
  /tmp/clawos-wasm/** rw,
  owner /tmp/clawos-wasm/** rw,

  # File access - WASM runtime libraries
  /usr/lib/wasmtime/** r,
  /usr/lib64/wasmtime/** r,

  # File access - System libraries (read-only)
  /usr/lib/** r,
  /usr/lib64/** r,
  /lib/** r,
  /lib64/** r,

  # Deny sensitive file access
  deny /etc/passwd rw,
  deny /etc/shadow rw,
  deny /etc/group rw,
  deny /etc/gshadow rw,
  deny /etc/sudoers rw,
  deny /etc/ssh/** rw,
  deny /root/** rw,
  deny /home/** rw,

  # Deny system configuration modification
  deny /etc/** w,
  deny /usr/local/etc/** w,

  # Deny kernel module operations
  deny /sys/module/** rw,
  deny /proc/sys/** rw,

  # Deny device access
  deny /dev/** rw,

  # Deny mount operations
  deny mount,
  deny umount,
  deny pivot_root,

  # Deny ptrace (prevent debugging)
  deny ptrace,

  # Deny signal to other processes
  deny signal send peer=unconfined,
  deny signal send peer=clawos-agent-loop,
  deny signal send peer=clawos-kernel-svc,

  # Allow signal from agent loop only
  signal (receive) peer=clawos-agent-loop,

  # Deny capability escalation
  deny capability,
  deny setuid,
  deny setgid,

  # Deny process creation outside sandbox
  deny /bin/** ix,
  deny /usr/bin/** ix,
  deny /sbin/** ix,
  deny /usr/sbin/** ix,

  # Allow only WASM runtime execution
  /usr/bin/wasmtime ix,
  /usr/local/bin/wasmtime ix,

  # Deny shared library modification
  deny /usr/lib/**/*.so w,
  deny /usr/lib64/**/*.so w,
  deny /lib/**/*.so w,
  deny /lib64/**/*.so w,
}
```

#### Security Notes

1. **Network Isolation**: All network access is explicitly denied. WASM tools must use the host function interface for any network operations, which are then mediated by the agent loop and monitored by eBPF LSM.

2. **No Capabilities**: The WASM daemon runs with zero Linux capabilities, following the principle of least privilege.

3. **Strict File Confinement**: The daemon is confined to `/var/lib/clawos/wasm-sandbox/` and `/tmp/clawos-wasm/`. Access to system files is read-only where absolutely necessary.

4. **Process Creation Restrictions**: Only the WASM runtime (`wasmtime`) can be executed. All other executables are denied.

5. **Signal Isolation**: The daemon can only receive signals from the agent loop. Sending signals to other processes is denied.

---

### clawos-kernel-svc

**Profile Name:** `clawos-kernel-svc`
**Security Level:** MODERATE
**Primary Concerns:** Device access, kernel interaction, eBPF program management

#### Profile Specification

```apparmor
# clawos-kernel-svc AppArmor Profile
# Security Level: MODERATE
# Owner: Security Agent
# Status: FROZEN

#include <tunables/global>

profile clawos-kernel-svc flags=(attach_disconnected) {
  # Include base abstractions
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # Capability grants (minimum required principle)
  capability sys_admin,              # Required for cgroup management
  capability sys_resource,           # Resource limit management
  capability net_admin,              # Network configuration (for XDP)
  capability ipc_lock,               # Lock memory for eBPF maps
  capability sys_module,             # Load kernel modules (RESTRICTED)
  capability mknod,                  # Create device nodes (RESTRICTED)

  # Network access - XDP monitoring (read-only)
  network inet raw,
  network packet raw,

  # Deny application network access
  deny network inet stream,
  deny network inet6 stream,
  deny network inet dgram,
  deny network inet6 dgram,

  # File access - eBPF programs and maps
  /sys/fs/bpf/** rw,
  /sys/kernel/debug/tracing/** rw,

  # File access - cgroup management
  /sys/fs/cgroup/** rw,
  /sys/fs/cgroup/clawos/** rw,

  # File access - Device nodes (restricted)
  /dev/null rw,
  /dev/zero rw,
  /dev/full rw,
  /dev/random r,
  /dev/urandom r,
  /dev/ptmx rw,
  /dev/pts/** rw,

  # Deny other device access
  deny /dev/sda* rw,
  deny /dev/nvme* rw,
  deny /dev/mapper/** rw,
  deny /dev/disk/** rw,
  deny /dev/snd/** rw,
  deny /dev/video* rw,
  deny /dev/input/** rw,

  # File access - Configuration
  /etc/clawos/kernel/** r,
  /etc/clawos/kernel/config.json rw,

  # File access - Logs
  /var/log/clawos/kernel-svc.log w,
  /var/log/clawos/kernel-svc.log* rw,
  /var/log/kern.log r,

  # File access - Runtime
  /run/clawos/kernel/** rw,
  /run/clawos/kernel.sock rw,

  # File access - System libraries
  /usr/lib/** r,
  /usr/lib64/** r,
  /lib/** r,
  /lib64/** r,

  # File access - Executables
  /usr/bin/** ix,
  /bin/** ix,
  /sbin/** ix,
  /usr/sbin/** ix,

  # File access - Kernel modules (read-only)
  /lib/modules/** r,
  /usr/lib/modules/** r,

  # Deny sensitive file modifications
  deny /etc/passwd w,
  deny /etc/shadow w,
  deny /etc/group w,
  deny /etc/gshadow w,
  deny /etc/sudoers w,
  deny /etc/ssh/** w,

  # Deny system configuration modification
  deny /etc/sysctl.conf w,
  deny /etc/sysctl.d/** w,

  # Mount operations (restricted)
  mount options=(ro,bind) /sys/fs/bpf/ -> /sys/fs/bpf/,
  deny mount,

  # Signal permissions
  signal (receive) peer=clawos-agent-loop,
  signal (send) peer=clawos-agent-loop,

  # Ptrace restrictions
  deny ptrace (read,trace) peer=unconfined,
  deny ptrace (read,trace) peer=clawos-wasm-daemon,

  # Change profile for subprocesses
  change_profile -> clawos-agent-loop,
}
```

#### Security Notes

1. **CAP_SYS_MODULE**: The `capability sys_module` is granted for loading kernel modules, but this is restricted by eBPF LSM hooks that validate all module loads before they are permitted.

2. **Device Access**: Access to block devices (`/dev/sda*`, `/dev/nvme*`) is explicitly denied. Only character devices required for normal operation (`/dev/null`, `/dev/zero`, `/dev/random`) are allowed.

3. **Network Access**: Only raw socket access is permitted for XDP monitoring. Application-level network access (TCP/UDP) is denied.

4. **cgroup Management**: Full read/write access to `/sys/fs/cgroup/` is required for managing resource quotas for all ClawOS components.

5. **eBPF Map Access**: Read/write access to `/sys/fs/bpf/` is required for managing eBPF programs and maps used for monitoring and enforcement.

---

## Rule Types

### File Rules

File rules control access to files and directories. The syntax is:

```
[deny] <path> <permissions>,
```

#### Permissions

| Permission | Description                                             |
| -----------| --------------------------------------------------------|
| `r`        | Read                                                    |
| `w`        | Write                                                   |
| `a`        | Append                                                  |
| `l`        | Create hard links                                       |
| `k`        | Lock                                                    |
| `m`        | Memory map (mmap)                                       |
| `x`        | Execute                                                 |
| `ix`       | Inherit execute (execute in current profile)            |
| `Ux`       | Unconfined execute (execute without confinement)        |
| `ux`       | Unconfined execute with cleanup                         |
| `Px`       | Discrete profile execute (execute in specified profile) |
| `px`       | Discrete profile execute with cleanup                   |
| `Cx`       | Child profile execute (execute in child profile)        |
| `cx`       | Child profile execute with cleanup                      |

#### Path Patterns

| Pattern          | Description             | Example                        |
| -----------------| ------------------------| -------------------------------|
| `/path/to/file`  | Exact file match        | `/etc/clawos/config.json`      |
| `/path/to/*`     | Wildcard (single level) | `/var/log/clawos/*.log`        |
| `/path/to/**`    | Recursive wildcard      | `/var/lib/clawos/workspace/**` |
| `/path/to/[abc]` | Character class         | `/etc/clawos/config[0-9].json` |

#### Examples

```apparmor
# Allow read access to configuration
/etc/clawos/config.json r,

# Allow read/write access to workspace
/var/lib/clawos/workspace/** rw,

# Deny write access to sensitive files
deny /etc/passwd w,
deny /etc/shadow w,

# Allow execute with profile transition
/usr/bin/wasmtime Px -> clawos-wasm-daemon,

# Allow inherit execute (stay in current profile)
/usr/bin/cat ix,
```

### Network Rules

Network rules control socket creation and network access. The syntax is:

```
[deny] network <family> <type> <protocol> [to <address> [port <port>]],
```

#### Families

| Family    | Description         |
| ----------| --------------------|
| `unix`    | Unix domain sockets |
| `inet`    | IPv4                |
| `inet6`   | IPv6                |
| `packet`  | Packet sockets      |
| `netlink` | Netlink sockets     |

#### Types

| Type        | Description                        |
| ------------| -----------------------------------|
| `stream`    | Stream sockets (TCP)               |
| `dgram`     | Datagram sockets (UDP)             |
| `raw`       | Raw sockets                        |
| `seqpacket` | Sequenced packet sockets           |
| `rdm`       | Reliably delivered message sockets |

#### Protocols

| Protocol | Description |
| ---------| ------------|
| `tcp`    | TCP         |
| `udp`    | UDP         |
| `icmp`   | ICMP        |
| `icmpv6` | ICMPv6      |
| `ip`     | IP (raw)    |

#### Examples

```apparmor
# Allow PostgreSQL access (localhost only)
network inet stream tcp to 127.0.0.1 port 5432,
network inet6 stream tcp to ::1 port 5432,

# Allow raw sockets for XDP
network inet raw,
network packet raw,

# Deny all other network access
deny network inet stream,
deny network inet dgram,
deny network inet6 stream,
deny network inet6 dgram,

# Allow Unix domain sockets
network unix stream,
```

### Capability Rules

Capability rules control Linux capabilities. The syntax is:

```
[deny] capability <capability_name>,
[deny] capability { <cap1>, <cap2>, ... },
```

#### Common Capabilities

| Capability             | Description                       | Use Case                    |
| -----------------------| ----------------------------------| ----------------------------|
| `CAP_NET_BIND_SERVICE` | Bind to privileged ports (< 1024) | Agent loop (if needed)      |
| `CAP_BPF`              | Load eBPF programs                | Agent loop, kernel service  |
| `CAP_NET_ADMIN`        | Network configuration             | Kernel service (XDP)        |
| `CAP_SYS_ADMIN`        | System administration             | Kernel service (cgroup)     |
| `CAP_SYS_MODULE`       | Load kernel modules               | Kernel service (restricted) |
| `CAP_DAC_OVERRIDE`     | Override DAC permissions          | Agent loop (minimal)        |
| `CAP_DAC_READ_SEARCH`  | Bypass file read checks           | Agent loop                  |
| `CAP_IPC_LOCK`         | Lock memory                       | Kernel service (eBPF maps)  |
| `CAP_MKNOD`            | Create device nodes               | Kernel service (restricted) |

#### Examples

```apparmor
# Grant specific capabilities
capability net_bind_service,
capability bpf,
capability dac_read_search,

# Grant multiple capabilities
capability { net_admin, ipc_lock, sys_resource },

# Deny dangerous capabilities
deny capability sys_module,
deny capability sys_rawio,
deny capability net_raw,
```

### Mount Rules

Mount rules control filesystem mount operations. The syntax is:

```
[deny] mount <options> <fstype> <source> -> <target>,
```

#### Examples

```apparmor
# Allow read-only bind mount
mount options=(ro,bind) /sys/fs/bpf/ -> /sys/fs/bpf/,

# Deny all mount operations
deny mount,

# Allow specific mount
mount options=(rw,noexec,nosuid) none -> /tmp/,
```

### Ptrace Rules

Ptrace rules control process tracing and debugging. The syntax is:

```
[deny] ptrace <access> peer=<profile>,
```

#### Access Types

| Access     | Description             |
| -----------| ------------------------|
| `read`     | Read process memory     |
| `trace`    | Trace process execution |
| `tracedby` | Be traced by process    |

#### Examples

```apparmor
# Allow ptrace from specific profile
ptrace (read,trace) peer=clawos-agent-loop,

# Deny ptrace from unconfined processes
deny ptrace (read,trace) peer=unconfined,

# Deny all ptrace
deny ptrace,
```

### Signal Rules

Signal rules control signal sending and receiving. The syntax is:

```
[deny] signal <signal_set> peer=<profile>,
```

#### Signal Sets

| Signal   | Description    |
| ---------| ---------------|
| `hup`    | Hangup         |
| `int`    | Interrupt      |
| `quit`   | Quit           |
| `kill`   | Kill           |
| `term`   | Terminate      |
| `usr1`   | User-defined 1 |
| `usr2`   | User-defined 2 |
| `exists` | Any signal     |

#### Examples

```apparmor
# Allow receiving signals from agent loop
signal (receive) peer=clawos-agent-loop,

# Allow sending specific signals
signal (send) set=(term,kill) peer=clawos-wasm-daemon,

# Deny sending signals to unconfined processes
deny signal send peer=unconfined,
```

### Change Profile Rules

Change profile rules control profile transitions. The syntax is:

```
change_profile -> <target_profile>,
```

#### Examples

```apparmor
# Transition to WASM daemon profile
change_profile -> clawos-wasm-daemon,

# Transition to unconfined (DANGEROUS - use with caution)
change_profile -> unconfined,
```

---

## Transition Rules

### Complain Mode → Enforce Mode Workflow

AppArmor profiles must be deployed in **complain mode** first for testing, then transitioned to **enforce mode** after validation.

#### Phase 1: Complain Mode (Testing)

```bash
# Load profile in complain mode
sudo aa-complain /usr/bin/clawos-agent-loop
# OR
sudo apparmor_parser -C /etc/apparmor.d/clawos-agent-loop
```

**Complain mode behavior:**
- Logs all violations but does not block them
- Allows full functionality while monitoring
- Generates audit logs for review

**Testing requirements:**
1. Run all normal operations
2. Execute all tool workflows
3. Test error conditions
4. Verify no unexpected violations

#### Phase 2: Violation Analysis

```bash
# View violations
sudo aa-logprof

# Analyze specific violations
sudo journalctl -u apparmor | grep clawos
```

**Analysis checklist:**
- [ ] All violations are expected
- [ ] No false positives blocking legitimate operations
- [ ] All required operations are allowed
- [ ] No security-sensitive operations are permitted

#### Phase 3: Profile Refinement

Based on violation analysis, refine the profile:

1. **Add missing permissions** for legitimate operations
2. **Tighten rules** if unexpected access is detected
3. **Remove overly permissive rules**
4. **Add deny rules** for security-sensitive operations

#### Phase 4: Enforce Mode (Production)

```bash
# Transition to enforce mode
sudo aa-enforce /usr/bin/clawos-agent-loop
# OR
sudo apparmor_parser /etc/apparmor.d/clawos-agent-loop
```

**Enforce mode behavior:**
- Blocks all violations
- Logs blocked operations
- Terminates violating processes (if configured)

**Pre-deployment checklist:**
- [ ] Complain mode testing completed (minimum 7 days)
- [ ] All violations analyzed and addressed
- [ ] Security Agent approval obtained
- [ ] Rollback plan documented
- [ ] Monitoring configured for enforce mode

### Profile Transition Matrix

| From Profile       | To Profile         | Trigger                | Security Level |
| -------------------| -------------------| -----------------------| ---------------|
| clawos-agent-loop  | clawos-wasm-daemon | WASM tool execution    | STRICT         |
| clawos-agent-loop  | clawos-kernel-svc  | Kernel service request | MODERATE       |
| clawos-wasm-daemon | clawos-agent-loop  | Tool completion        | MODERATE       |
| clawos-kernel-svc  | clawos-agent-loop  | Service response       | MODERATE       |
| Any                | unconfined         | **FORBIDDEN**          | N/A            |

### Transition Rules

1. **No unconfined transitions**: Transitions to `unconfined` are strictly forbidden except for emergency recovery (requires Security Agent approval).

2. **Downgrade protection**: Profiles cannot transition to a less restrictive security level without Security Agent approval.

3. **Audit logging**: All profile transitions must be logged to `/var/log/clawos/transitions.log`.

4. **Validation**: Profile transitions must be validated by eBPF LSM hooks before execution.

---

## Deny Rules

### Security-Sensitive Operation Deny Rules

The following operations are explicitly denied for all ClawOS components:

#### Network Deny Rules

```apparmor
# WASM daemon - no direct network access
deny network inet,
deny network inet6,
deny network unix,

# Agent loop - deny non-PostgreSQL network
deny network inet stream,
deny network inet6 stream,
deny network inet dgram,
deny network inet6 dgram,
deny network inet raw,
deny network inet6 raw,

# Kernel service - deny application network
deny network inet stream,
deny network inet6 stream,
deny network inet dgram,
deny network inet6 dgram,
```

#### File Deny Rules

```apparmor
# All components - deny sensitive file modifications
deny /etc/passwd w,
deny /etc/shadow w,
deny /etc/group w,
deny /etc/gshadow w,
deny /etc/sudoers w,
deny /etc/ssh/** w,

# All components - deny system configuration modification
deny /etc/sysctl.conf w,
deny /etc/sysctl.d/** w,

# All components - deny kernel module operations
deny /sys/module/** w,
deny /proc/sys/** w,

# WASM daemon - deny home directory access
deny /root/** rw,
deny /home/** rw,
```

#### Capability Deny Rules

```apparmor
# All components - deny dangerous capabilities
deny capability sys_rawio,
deny capability sys_boot,
deny capability sys_time,
deny capability sys_tty_config,

# WASM daemon - deny all capabilities
deny capability,

# Agent loop - deny raw sockets
deny capability net_raw,

# Kernel service - deny module loading (except through eBPF LSM)
deny capability sys_module,
```

#### Device Deny Rules

```apparmor
# All components - deny block device access
deny /dev/sda* rw,
deny /dev/nvme* rw,
deny /dev/mapper/** rw,
deny /dev/disk/** rw,

# All components - deny multimedia device access
deny /dev/snd/** rw,
deny /dev/video* rw,
deny /dev/input/** rw,

# WASM daemon - deny all device access
deny /dev/** rw,
```

#### Process Deny Rules

```apparmor
# All components - deny ptrace from unconfined
deny ptrace (read,trace) peer=unconfined,

# WASM daemon - deny process creation
deny /bin/** ix,
deny /usr/bin/** ix,
deny /sbin/** ix,
deny /usr/sbin/** ix,

# All components - deny mount operations
deny mount,
deny umount,
deny pivot_root,
```

### Deny Rule Priority

Deny rules have higher priority than allow rules. If a deny rule matches an operation, it will be blocked regardless of any allow rules that also match.

**Example:**
```apparmor
# Allow read access to /etc
/etc/** r,

# But deny write to /etc/passwd
deny /etc/passwd w,

# Result: /etc/passwd can be read but not written
```

---

## Example Profiles

### Complete Example: clawos-agent-loop

```apparmor
# clawos-agent-loop AppArmor Profile
# Security Level: MODERATE
# Owner: Security Agent
# Status: FROZEN
# SHA256: PLACEHOLDER_SHA256_SIGNATURE

#include <tunables/global>

profile clawos-agent-loop flags=(attach_disconnected) {
  # Include base abstractions
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openssl>
  #include <abstractions/perl>

  # Capability grants (minimum required principle)
  capability net_bind_service,
  capability bpf,
  capability dac_read_search,
  capability dac_override,

  # PostgreSQL network access (monitored by XDP)
  network inet stream tcp to 127.0.0.1 port 5432,
  network inet6 stream tcp to ::1 port 5432,

  # Deny all other network access
  deny network inet stream,
  deny network inet6 stream,
  deny network inet dgram,
  deny network inet6 dgram,
  deny network inet raw,
  deny network inet6 raw,

  # File access - ClawFS workspace
  /var/lib/clawos/workspace/** rw,
  /var/lib/clawos/workspace/**/ r,

  # File access - Configuration
  /etc/clawos/** r,
  /etc/clawos/config.json rw,

  # File access - Logs
  /var/log/clawos/agent-loop.log w,
  /var/log/clawos/agent-loop.log* rw,

  # File access - Runtime
  /run/clawos/** rw,
  /run/clawos/agent-loop.sock rw,

  # File access - Temporary files
  /tmp/clawos-agent-loop/** rw,
  owner /tmp/** rw,

  # File access - System libraries
  /usr/lib/** r,
  /usr/lib64/** r,
  /lib/** r,
  /lib64/** r,

  # File access - Executables
  /usr/bin/** ix,
  /bin/** ix,

  # Deny sensitive file modifications
  deny /etc/passwd w,
  deny /etc/shadow w,
  deny /etc/group w,
  deny /etc/gshadow w,
  deny /etc/sudoers w,
  deny /etc/ssh/** w,

  # Deny kernel module operations
  deny /sys/module/** w,
  deny /proc/sys/** w,

  # Deny device access (except through eBPF)
  deny /dev/** rw,

  # Signal permissions
  signal (receive) peer=clawos-wasm-daemon,
  signal (receive) peer=clawos-kernel-svc,

  # Change profile for subprocesses
  change_profile -> clawos-wasm-daemon,

  # Ptrace restrictions
  deny ptrace (read,trace) peer=unconfined,
}
```

### Complete Example: clawos-wasm-daemon

```apparmor
# clawos-wasm-daemon AppArmor Profile
# Security Level: STRICT
# Owner: Security Agent
# Status: FROZEN
# SHA256: PLACEHOLDER_SHA256_SIGNATURE

#include <tunables/global>

profile clawos-wasm-daemon flags=(attach_disconnected,mediate_deleted) {
  # Include base abstractions
  #include <abstractions/base>

  # Capability grants (minimum required principle)
  # NO CAPABILITIES GRANTED - STRICT ISOLATION

  # Deny all network access (WASM must use host function)
  deny network inet,
  deny network inet6,
  deny network unix,
  deny network packet,
  deny network ax25,
  deny network ipx,
  deny network netrom,
  deny network atmpvc,
  deny network x25,
  deny network rose,
  deny network decnet,
  deny network netbeui,
  deny network security,
  deny network key,
  deny network netlink,
  deny network ash,
  deny network econet,
  deny network atmsvc,
  deny network rds,
  deny network sna,
  deny network irda,
  deny network pppox,
  deny network wanpipe,
  deny network llc,
  deny network ib,
  deny network mpls,
  deny network can,
  deny network tipc,
  deny network bluetooth,
  deny network iucv,
  deny network rxrpc,
  deny network kcm,
  deny network qipcrtr,
  deny network smc,
  deny network xdp,

  # File access - WASM sandbox directory
  /var/lib/clawos/wasm-sandbox/** rw,
  /var/lib/clawos/wasm-sandbox/**/ r,

  # File access - WASM tool cache (read-only)
  /var/lib/clawos/wasm-cache/** r,

  # File access - Configuration (read-only)
  /etc/clawos/wasm/** r,

  # File access - Logs
  /var/log/clawos/wasm-daemon.log w,
  /var/log/clawos/wasm-daemon.log* rw,

  # File access - Runtime
  /run/clawos/wasm/** rw,
  /run/clawos/wasm.sock rw,

  # File access - Temporary files (isolated)
  /tmp/clawos-wasm/** rw,
  owner /tmp/clawos-wasm/** rw,

  # File access - WASM runtime libraries
  /usr/lib/wasmtime/** r,
  /usr/lib64/wasmtime/** r,

  # File access - System libraries (read-only)
  /usr/lib/** r,
  /usr/lib64/** r,
  /lib/** r,
  /lib64/** r,

  # Deny sensitive file access
  deny /etc/passwd rw,
  deny /etc/shadow rw,
  deny /etc/group rw,
  deny /etc/gshadow rw,
  deny /etc/sudoers rw,
  deny /etc/ssh/** rw,
  deny /root/** rw,
  deny /home/** rw,

  # Deny system configuration modification
  deny /etc/** w,
  deny /usr/local/etc/** w,

  # Deny kernel module operations
  deny /sys/module/** rw,
  deny /proc/sys/** rw,

  # Deny device access
  deny /dev/** rw,

  # Deny mount operations
  deny mount,
  deny umount,
  deny pivot_root,

  # Deny ptrace (prevent debugging)
  deny ptrace,

  # Deny signal to other processes
  deny signal send peer=unconfined,
  deny signal send peer=clawos-agent-loop,
  deny signal send peer=clawos-kernel-svc,

  # Allow signal from agent loop only
  signal (receive) peer=clawos-agent-loop,

  # Deny capability escalation
  deny capability,
  deny setuid,
  deny setgid,

  # Deny process creation outside sandbox
  deny /bin/** ix,
  deny /usr/bin/** ix,
  deny /sbin/** ix,
  deny /usr/sbin/** ix,

  # Allow only WASM runtime execution
  /usr/bin/wasmtime ix,
  /usr/local/bin/wasmtime ix,

  # Deny shared library modification
  deny /usr/lib/**/*.so w,
  deny /usr/lib64/**/*.so w,
  deny /lib/**/*.so w,
  deny /lib64/**/*.so w,
}
```

### Complete Example: clawos-kernel-svc

```apparmor
# clawos-kernel-svc AppArmor Profile
# Security Level: MODERATE
# Owner: Security Agent
# Status: FROZEN
# SHA256: PLACEHOLDER_SHA256_SIGNATURE

#include <tunables/global>

profile clawos-kernel-svc flags=(attach_disconnected) {
  # Include base abstractions
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # Capability grants (minimum required principle)
  capability sys_admin,
  capability sys_resource,
  capability net_admin,
  capability ipc_lock,
  capability sys_module,
  capability mknod,

  # Network access - XDP monitoring (read-only)
  network inet raw,
  network packet raw,

  # Deny application network access
  deny network inet stream,
  deny network inet6 stream,
  deny network inet dgram,
  deny network inet6 dgram,

  # File access - eBPF programs and maps
  /sys/fs/bpf/** rw,
  /sys/kernel/debug/tracing/** rw,

  # File access - cgroup management
  /sys/fs/cgroup/** rw,
  /sys/fs/cgroup/clawos/** rw,

  # File access - Device nodes (restricted)
  /dev/null rw,
  /dev/zero rw,
  /dev/full rw,
  /dev/random r,
  /dev/urandom r,
  /dev/ptmx rw,
  /dev/pts/** rw,

  # Deny other device access
  deny /dev/sda* rw,
  deny /dev/nvme* rw,
  deny /dev/mapper/** rw,
  deny /dev/disk/** rw,
  deny /dev/snd/** rw,
  deny /dev/video* rw,
  deny /dev/input/** rw,

  # File access - Configuration
  /etc/clawos/kernel/** r,
  /etc/clawos/kernel/config.json rw,

  # File access - Logs
  /var/log/clawos/kernel-svc.log w,
  /var/log/clawos/kernel-svc.log* rw,
  /var/log/kern.log r,

  # File access - Runtime
  /run/clawos/kernel/** rw,
  /run/clawos/kernel.sock rw,

  # File access - System libraries
  /usr/lib/** r,
  /usr/lib64/** r,
  /lib/** r,
  /lib64/** r,

  # File access - Executables
  /usr/bin/** ix,
  /bin/** ix,
  /sbin/** ix,
  /usr/sbin/** ix,

  # File access - Kernel modules (read-only)
  /lib/modules/** r,
  /usr/lib/modules/** r,

  # Deny sensitive file modifications
  deny /etc/passwd w,
  deny /etc/shadow w,
  deny /etc/group w,
  deny /etc/gshadow w,
  deny /etc/sudoers w,
  deny /etc/ssh/** w,

  # Deny system configuration modification
  deny /etc/sysctl.conf w,
  deny /etc/sysctl.d/** w,

  # Mount operations (restricted)
  mount options=(ro,bind) /sys/fs/bpf/ -> /sys/fs/bpf/,
  deny mount,

  # Signal permissions
  signal (receive) peer=clawos-agent-loop,
  signal (send) peer=clawos-agent-loop,

  # Ptrace restrictions
  deny ptrace (read,trace) peer=unconfined,
  deny ptrace (read,trace) peer=clawos-wasm-daemon,

  # Change profile for subprocesses
  change_profile -> clawos-agent-loop,
}
```

---

## Validation Rules

### Profile Validation Checklist

Before deploying an AppArmor profile, the following validation must be completed:

#### Syntax Validation

```bash
# Validate profile syntax
sudo apparmor_parser --skip-cache /etc/apparmor.d/clawos-agent-loop

# Check for errors
echo $?
# Expected output: 0 (success)
```

#### Semantic Validation

- [ ] All file paths exist or are valid patterns
- [ ] All capabilities are valid Linux capabilities
- [ ] All network rules use valid families, types, and protocols
- [ ] All profile transitions reference existing profiles
- [ ] No conflicting rules (allow and deny for same operation)

#### Security Validation

- [ ] Minimum required principle followed (only grant necessary capabilities)
- [ ] No unconfined transitions (except emergency recovery)
- [ ] All deny rules are explicit and justified
- [ ] Security-sensitive operations are denied
- [ ] Network access is restricted to allowlist only

#### Integration Validation

- [ ] Profile is compatible with eBPF LSM hooks
- [ ] Profile does not conflict with seccomp filters
- [ ] Profile respects cgroup resource limits
- [ ] Profile allows necessary IPC between components

### Automated Validation Script

```bash
#!/bin/bash
# validate-apparmor-profiles.sh
# Validates all ClawOS AppArmor profiles

PROFILES=(
  "/etc/apparmor.d/clawos-agent-loop"
  "/etc/apparmor.d/clawos-wasm-daemon"
  "/etc/apparmor.d/clawos-kernel-svc"
)

ERRORS=0

for profile in "${PROFILES[@]}"; do
  echo "Validating $profile..."

  # Syntax validation
  if ! sudo apparmor_parser --skip-cache "$profile" 2>&1; then
    echo "ERROR: Syntax validation failed for $profile"
    ERRORS=$((ERRORS + 1))
    continue
  fi

  # Check for common issues
  if grep -q "change_profile -> unconfined" "$profile"; then
    echo "WARNING: Unconfined transition found in $profile"
  fi

  if grep -q "deny capability" "$profile" | grep -v "deny capability,"; then
    echo "WARNING: Generic capability deny found in $profile"
  fi

  echo "OK: $profile validated successfully"
done

if [ $ERRORS -eq 0 ]; then
  echo "All profiles validated successfully"
  exit 0
else
  echo "Validation failed with $ERRORS error(s)"
  exit 1
fi
```

### Continuous Monitoring

AppArmor profiles must be continuously monitored for violations:

```bash
# Monitor violations in real-time
sudo journalctl -u apparmor -f | grep clawos

# Generate violation report
sudo aa-logprof --show-both

# Check profile status
sudo aa-status
```

### Violation Response Procedure

1. **Immediate**: Log violation to `/var/log/clawos/violations.log`
2. **Analysis**: Determine if violation is expected or unexpected
3. **Expected**: Update profile to allow the operation (if legitimate)
4. **Unexpected**: Investigate potential security breach
5. **Critical**: Escalate to Security Agent for immediate action

---

## Appendix A: AppArmor Command Reference

### Profile Management

| Command                        | Description           |
| -------------------------------| ----------------------|
| `apparmor_parser -r <profile>` | Reload profile        |
| `apparmor_parser -R <profile>` | Remove profile        |
| `apparmor_parser -C <profile>` | Load in complain mode |
| `aa-enforce <profile>`         | Set to enforce mode   |
| `aa-complain <profile>`        | Set to complain mode  |
| `aa-disable <profile>`         | Disable profile       |
| `aa-status`                    | Show profile status   |

### Log Analysis

| Command                              | Description              |
| -------------------------------------| -------------------------|
| `aa-logprof`                         | Interactive log analyzer |
| `journalctl -u apparmor`             | View AppArmor logs       |
| `dmesg \                             | grep apparmor`           | View kernel logs |
| `auditctl -w /etc/apparmor.d/ -p wa` | Audit profile changes    |

### Testing

| Command                          | Description                  |
| ---------------------------------| -----------------------------|
| `aa-exec -p <profile> <command>` | Run command under profile    |
| `aa-genprof <command>`           | Generate profile for command |
| `aa-decode`                      | Decode AppArmor log messages |

---

## Appendix B: Security Agent Approval Process

### Profile Modification Request

All profile modifications must be approved by the Security Agent:

1. **Submit Request**: Create modification request with:
   - Profile name
   - Proposed changes
   - Justification
   - Risk assessment

2. **Security Review**: Security Agent reviews:
   - Necessity of changes
   - Security implications
   - Impact on other components
   - Compliance with security hierarchy

3. **Approval Decision**:
   - **APPROVE**: Changes can be deployed
   - **REJECT**: Changes must be revised
   - **CONDITIONAL**: Changes approved with conditions

4. **Deployment**:
   - Update profile file
   - Update SHA256 signature
   - Store in ClawFS Vault
   - Deploy following complain → enforce workflow

### Emergency Override

In emergency situations, the Security Agent can:
1. Temporarily disable a profile: `aa-disable <profile>`
2. Load emergency profile: `apparmor_parser -r <emergency-profile>`
3. Override deny rules: Comment out deny rules and reload

**Emergency override requirements:**
- Document reason for override
- Set expiration time (maximum 24 hours)
- Notify all stakeholders
- Create incident report
- Review and remediate within 24 hours

---

## Appendix C: References

### AppArmor Documentation

- [AppArmor Wiki](https://gitlab.com/apparmor/apparmor/-/wikis/home)
- [AppArmor Manual Pages](https://manpages.ubuntu.com/manpages/bionic/man5/apparmor.d.5.html)
- [AppArmor Profile Syntax](https://gitlab.com/apparmor/apparmor/-/wikis/ProfileSyntax)

### Linux Capabilities

- [Linux Capabilities Manual](https://man7.org/linux/man-pages/man7/capabilities.7.html)
- [Capability List](https://man7.org/linux/man-pages/man7/capabilities.7.html)

### ClawOS Specifications

- P1.1: WIT Interface Spec Book (WASM ↔ Kernel ABI)
- P1.2: seccomp syscall whitelist JSON Schema
- P1.3: eBPF event struct format
- P1.4: ClawFS path convention + Secrets encryption format
- P1.5: cgroup v2 resource quota standard values table

### Security Standards

- [CIS Benchmark for Linux](https://www.cisecurity.org/benchmark/linux)
- [NIST SP 800-53](https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final)
- [ISO/IEC 27001](https://www.iso.org/standard/27001)

---

## Change History

| Version | Date       | Author         | Changes                      |
| --------| -----------| ---------------| -----------------------------|
| 1.0.0   | 2026-02-24 | Security Agent | Initial frozen specification |

---

**END OF SPECIFICATION**
