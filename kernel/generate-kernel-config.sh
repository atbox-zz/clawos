#!/bin/bash
#
# generate-kernel-config.sh
# Generates Linux 6.6 LTS kernel .config for ClawOS
# Based on P1.5 cgroup quotas specification and SKILLS.md kernel requirements
#
# Usage:
#   ./generate-kernel-config.sh [output_file]
#
# Arguments:
#   output_file - Path to output .config file (default: .config)
#
# Example:
#   ./generate-kernel-config.sh
#   ./generate-kernel-config.sh /path/to/linux-6.6/.config
#

set -euo pipefail

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Default output file
OUTPUT_FILE="${1:-.config}"

# Kernel version
KERNEL_VERSION="6.6"
KERNEL_LTS="LTS"

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Print header
print_header() {
    cat << 'EOF'
#
# Automatically generated by ClawOS kernel config generator
# Target: Linux 6.6 LTS
# Based on: P1.5 cgroup quotas specification
# Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
#
# ClawOS Kernel Configuration
# ===========================
# This configuration enables:
#   - cgroup v2 with full resource control
#   - eBPF with CO-RE support
#   - Linux namespaces for containerization
#   - seccomp for syscall filtering
#   - LSM stack (AppArmor + BPF LSM)
#   - Kernel hardening features
#
EOF
}

# Generate cgroup v2 configuration
generate_cgroup_config() {
    log_info "Generating cgroup v2 configuration..."

    cat << 'EOF'
#
# cgroup v2 Configuration (P1.5)
#
CONFIG_CGROUPS=y
CONFIG_MEMCG=y
CONFIG_CGROUP_PIDS=y
CONFIG_CGROUP_BPF=y
CONFIG_CGROUP_CPUACCT=y
CONFIG_CGROUP_SCHED=y
CONFIG_BLK_CGROUP=y
CONFIG_CGROUP_WRITEBACK=y

# Additional cgroup v2 features
CONFIG_CGROUP_FREEZER=y
CONFIG_CGROUP_HUGETLB=y
CONFIG_CGROUP_DEVICE=y
CONFIG_CGROUP_PERF=y
CONFIG_CGROUP_NET_PRIO=y
CONFIG_CGROUP_NET_CLASSID=y
CONFIG_CPUSETS=y
CONFIG_PROC_PID_CPUSET=y
CONFIG_CGROUP_RDMA=y
CONFIG_CGROUP_MISC=y

# Memory controller extensions
CONFIG_MEMCG_KMEM=y
CONFIG_MEMCG_SWAP=y
CONFIG_MEMCG_SWAP_ENABLED=y
CONFIG_BLK_CGROUP_IOCOST=y
CONFIG_BLK_CGROUP_IOLATENCY=y

# CPU controller extensions
CONFIG_FAIR_GROUP_SCHED=y
CONFIG_CFS_BANDWIDTH=y
CONFIG_RT_GROUP_SCHED=y

# I/O controller extensions
CONFIG_BLK_DEV_THROTTLING=y

# PIDs controller
CONFIG_PIDS=y

EOF
}

# Generate eBPF configuration
generate_ebpf_config() {
    log_info "Generating eBPF configuration..."

    cat << 'EOF'
#
# eBPF Configuration (SKILLS.md)
#
CONFIG_BPF=y
CONFIG_BPF_SYSCALL=y
CONFIG_BPF_JIT=y
CONFIG_BPF_JIT_ALWAYS_ON=y
CONFIG_DEBUG_INFO_BTF=y
CONFIG_BPF_LSM=y

# eBPF networking
CONFIG_BPF_STREAM_PARSER=y
CONFIG_NETFILTER_XT_MATCH_BPF=y
CONFIG_CLS_BPF=y
CONFIG_CLS_ACT=y
CONFIG_NET_CLS_BPF=y
CONFIG_NET_ACT_BPF=y
CONFIG_BPF_EVENTS=y
CONFIG_KPROBE_EVENTS=y
CONFIG_UPROBE_EVENTS=y
CONFIG_BPF_KPROBE_OVERRIDE=y

# eBPF maps and helpers
CONFIG_BPF_LIRC_MODE2=y
CONFIG_HAVE_BPF_JIT=y
CONFIG_HAVE_EBPF_JIT=y

# eBPF tracing
CONFIG_BPFILTER=y
CONFIG_BPFILTER_UMH=y

# eBPF cgroup hooks
CONFIG_CGROUP_BPF=y

EOF
}

# Generate namespace configuration
generate_namespace_config() {
    log_info "Generating namespace configuration..."

    cat << 'EOF'
#
# Namespaces Configuration (SKILLS.md)
#
CONFIG_NAMESPACES=y
CONFIG_USER_NS=y
CONFIG_PID_NS=y
CONFIG_NET_NS=y
CONFIG_MNT_NS=y

# Additional namespace support
CONFIG_UTS_NS=y
CONFIG_IPC_NS=y
CONFIG_TIME_NS=y

# Namespace helpers
CONFIG_NS=y

EOF
}

# Generate seccomp configuration
generate_seccomp_config() {
    log_info "Generating seccomp configuration..."

    cat << 'EOF'
#
# seccomp Configuration (SKILLS.md)
#
CONFIG_SECCOMP=y
CONFIG_SECCOMP_FILTER=y
CONFIG_HAVE_ARCH_SECCOMP_FILTER=y
CONFIG_SECCOMP_CACHE_DEBUG=y

# Additional seccomp features
CONFIG_SECCOMP_ARCH_ISA=y

EOF
}

# Generate LSM stack configuration
generate_lsm_config() {
    log_info "Generating LSM stack configuration..."

    cat << 'EOF'
#
# LSM Stack Configuration (SKILLS.md)
#
CONFIG_SECURITY=y
CONFIG_SECURITY_NETWORK=y
CONFIG_SECURITY_NETWORK_XFRM=y
CONFIG_SECURITY_PATH=y
CONFIG_LSM="lockdown,yama,apparmor,bpf"

# AppArmor
CONFIG_SECURITY_APPARMOR=y
CONFIG_SECURITY_APPARMOR_DEBUG=y
CONFIG_SECURITY_APPARMOR_INTROSPECT=y
CONFIG_SECURITY_APPARMOR_HASH=y
CONFIG_SECURITY_APPARMOR_HASH_DEFAULT=y
CONFIG_SECURITY_APPARMOR_PARANOID_LOAD=y

# BPF LSM
CONFIG_BPF_LSM=y

# Yama
CONFIG_SECURITY_YAMA=y

# Lockdown
CONFIG_SECURITY_LOCKDOWN_LSM=y
CONFIG_SECURITY_LOCKDOWN_LSM_EARLY=y
CONFIG_LOCK_DOWN_KERNEL_FORCE_NONE=y
CONFIG_LOCK_DOWN_KERNEL_FORCE_INTEGRITY=y
CONFIG_LOCK_DOWN_KERNEL_FORCE_CONFIDENTIALITY=y

# Additional LSM features
CONFIG_HARDENED_USERCOPY=y
CONFIG_FORTIFY_SOURCE=y

EOF
}

# Generate hardening configuration
generate_hardening_config() {
    log_info "Generating kernel hardening configuration..."

    cat << 'EOF'
#
# Kernel Hardening Configuration (SKILLS.md)
#
CONFIG_RANDOMIZE_BASE=y
CONFIG_RANDOMIZE_MEMORY=y
CONFIG_RANDOMIZE_MEMORY_PHYSICAL_PADDING=0xa

# Stack protection
CONFIG_STACKPROTECTOR=y
CONFIG_STACKPROTECTOR_STRONG=y
CONFIG_STACKPROTECTOR_PER_TASK=y

# VMAP stack
CONFIG_VMAP_STACK=y

# SLAB hardening
CONFIG_SLAB_FREELIST_HARDENED=y
CONFIG_SLAB_FREELIST_RANDOM=y
CONFIG_HARDENED_USERCOPY=y

# Module signing
CONFIG_MODULE_SIG=y
CONFIG_MODULE_SIG_FORCE=y
CONFIG_MODULE_SIG_ALL=y
CONFIG_MODULE_SIG_SHA512=y
CONFIG_MODULE_SIG_HASH="sha512"
CONFIG_MODULE_SIG_KEY="certs/signing_key.pem"

# Kernel address space layout
CONFIG_KASLR=y
CONFIG_KASAN=y
CONFIG_KASAN_GENERIC=y

# Control flow integrity
CONFIG_CC_STACKPROTECTOR=y
CONFIG_CC_STACKPROTECTOR_STRONG=y

# Memory debugging
CONFIG_DEBUG_LIST=y
CONFIG_DEBUG_SG=y
CONFIG_DEBUG_CREDENTIALS=y
CONFIG_DEBUG_NOTIFIERS=y
CONFIG_DEBUG_OBJECTS=y

# Additional hardening
CONFIG_STRICT_DEVMEM=y
CONFIG_IO_STRICT_DEVMEM=y
CONFIG_DEBUG_WX=y
CONFIG_DEBUG_RODATA=y
CONFIG_DEBUG_RODATA_TEST=y
CONFIG_DEBUG_SET_MODULE_RONX=y
CONFIG_DEBUG_KERNEL=y
CONFIG_PANIC_ON_OOPS=y
CONFIG_PANIC_TIMEOUT=5

# Randomization
CONFIG_RANDOM_TRUST_CPU=y
CONFIG_RANDOM_TRUST_BOOTLOADER=y

# Refcount hardening
CONFIG_REFCOUNT_FULL=y

# Overflow hardening
CONFIG_DEBUG_ATOMIC_SLEEP=y
CONFIG_DEBUG_VM=y
CONFIG_DEBUG_VM_PGFLAGS=y
CONFIG_DEBUG_VM_RB=y
CONFIG_DEBUG_VM_PGTABLE=y

# Hardening for specific subsystems
CONFIG_HARDENED_USERCOPY=y
CONFIG_FORTIFY_SOURCE=y
CONFIG_STRICT_KERNEL_RWX=y
CONFIG_STRICT_MODULE_RWX=y

# Security keys
CONFIG_KEYS=y
CONFIG_KEYS_DEBUG_PROC_KEYS=y
CONFIG_ENCRYPTED_KEYS=y
CONFIG_KEY_DH_OPERATIONS=y

EOF
}

# Generate networking configuration (required for cgroup v2 and eBPF)
generate_networking_config() {
    log_info "Generating networking configuration..."

    cat << 'EOF'
#
# Networking Configuration (required for cgroup v2 and eBPF)
#
CONFIG_NET=y
CONFIG_NET_INGRESS=y
CONFIG_NET_EGRESS=y
CONFIG_NET_XGRESS=y

# Packet filtering
CONFIG_NETFILTER=y
CONFIG_NETFILTER_ADVANCED=y
CONFIG_NETFILTER_INGRESS=y
CONFIG_NETFILTER_EGRESS=y

# Network packet filtering framework
CONFIG_NETFILTER_NETLINK=y
CONFIG_NETFILTER_NETLINK_ACCT=y
CONFIG_NETFILTER_NETLINK_QUEUE=y
CONFIG_NETFILTER_NETLINK_LOG=y

# Core Netfilter Configuration
CONFIG_NF_CONNTRACK=y
CONFIG_NF_LOG_SYSLOG=y
CONFIG_NF_CONNTRACK_PROCFS=y
CONFIG_NF_CONNTRACK_EVENTS=y
CONFIG_NF_CONNTRACK_TIMEOUT=y
CONFIG_NF_CONNTRACK_TIMESTAMP=y
CONFIG_NF_CONNTRACK_LABELS=y
CONFIG_NF_CT_PROTO_DCCP=y
CONFIG_NF_CT_PROTO_SCTP=y
CONFIG_NF_CT_PROTO_UDPLITE=y
CONFIG_NF_CONNTRACK_AMANDA=y
CONFIG_NF_CONNTRACK_FTP=y
CONFIG_NF_CONNTRACK_H323=y
CONFIG_NF_CONNTRACK_IRC=y
CONFIG_NF_CONNTRACK_NETBIOS_NS=y
CONFIG_NF_CONNTRACK_PPTP=y
CONFIG_NF_CONNTRACK_SANE=y
CONFIG_NF_CONNTRACK_SIP=y
CONFIG_NF_CONNTRACK_TFTP=y
CONFIG_NF_CT_NETLINK=y
CONFIG_NF_CT_NETLINK_TIMEOUT=y
CONFIG_NF_CT_NETLINK_HELPER=y
CONFIG_NETFILTER_NETLINK_GLUE_CT=y
CONFIG_NF_NAT=y
CONFIG_NF_NAT_AMANDA=y
CONFIG_NF_NAT_FTP=y
CONFIG_NF_NAT_IRC=y
CONFIG_NF_NAT_SIP=y
CONFIG_NF_NAT_TFTP=y
CONFIG_NF_NAT_REDIRECT=y
CONFIG_NF_TABLES=y
CONFIG_NF_TABLES_INET=y
CONFIG_NFT_NUMGEN=y
CONFIG_NFT_CT=y
CONFIG_NFT_CONNLIMIT=y
CONFIG_NFT_LOG=y
CONFIG_NFT_LIMIT=y
CONFIG_NFT_MASQ=y
CONFIG_NFT_REDIR=y
CONFIG_NFT_NAT=y
CONFIG_NFT_TUNNEL=y
CONFIG_NFT_OBJREF=y
CONFIG_NFT_QUOTA=y
CONFIG_NFT_REJECT=y
CONFIG_NFT_REJECT_INET=y
CONFIG_NFT_COMPAT=y
CONFIG_NFT_HASH=y
CONFIG_NFT_FIB=y
CONFIG_NFT_FIB_INET=y
CONFIG_NFT_SOCKET=y
CONFIG_NFT_OSF=y
CONFIG_NFT_TPROXY=y
CONFIG_NFT_SYNPROXY=y
CONFIG_NF_DUP_NETDEV=y
CONFIG_NFT_DUP_NETDEV=y
CONFIG_NFT_FWD_NETDEV=y
CONFIG_NF_FLOW_TABLE_INET=y
CONFIG_NF_FLOW_TABLE=y

# Xtables support
CONFIG_NETFILTER_XTABLES=y

# Core Netfilter Configuration
CONFIG_NETFILTER_XT_TARGET_CLASSIFY=y
CONFIG_NETFILTER_XT_TARGET_CONNMARK=y
CONFIG_NETFILTER_XT_TARGET_CONNSECMARK=y
CONFIG_NETFILTER_XT_TARGET_CT=y
CONFIG_NETFILTER_XT_TARGET_DSCP=y
CONFIG_NETFILTER_XT_TARGET_HL=y
CONFIG_NETFILTER_XT_TARGET_HMARK=y
CONFIG_NETFILTER_XT_TARGET_IDLETIMER=y
CONFIG_NETFILTER_XT_TARGET_LED=y
CONFIG_NETFILTER_XT_TARGET_LOG=y
CONFIG_NETFILTER_XT_TARGET_MARK=y
CONFIG_NETFILTER_XT_NAT=y
CONFIG_NETFILTER_XT_TARGET_NETMAP=y
CONFIG_NETFILTER_XT_TARGET_NFLOG=y
CONFIG_NETFILTER_XT_TARGET_NFQUEUE=y
CONFIG_NETFILTER_XT_TARGET_NOTRACK=y
CONFIG_NETFILTER_XT_TARGET_RATEEST=y
CONFIG_NETFILTER_XT_TARGET_REDIRECT=y
CONFIG_NETFILTER_XT_TARGET_MASQUERADE=y
CONFIG_NETFILTER_XT_TARGET_TEE=y
CONFIG_NETFILTER_XT_TARGET_TPROXY=y
CONFIG_NETFILTER_XT_TARGET_TRACE=y
CONFIG_NETFILTER_XT_TARGET_SECMARK=y
CONFIG_NETFILTER_XT_TARGET_TCPMSS=y
CONFIG_NETFILTER_XT_TARGET_TCPOPTSTRIP=y
CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y
CONFIG_NETFILTER_XT_MATCH_BPF=y
CONFIG_NETFILTER_XT_MATCH_CGROUP=y
CONFIG_NETFILTER_XT_MATCH_CLUSTER=y
CONFIG_NETFILTER_XT_MATCH_COMMENT=y
CONFIG_NETFILTER_XT_MATCH_CONNBYTES=y
CONFIG_NETFILTER_XT_MATCH_CONNLABEL=y
CONFIG_NETFILTER_XT_MATCH_CONNLIMIT=y
CONFIG_NETFILTER_XT_MATCH_CONNMARK=y
CONFIG_NETFILTER_XT_MATCH_CONNTRACK=y
CONFIG_NETFILTER_XT_MATCH_CPU=y
CONFIG_NETFILTER_XT_MATCH_DCCP=y
CONFIG_NETFILTER_XT_MATCH_DEVGROUP=y
CONFIG_NETFILTER_XT_MATCH_DSCP=y
CONFIG_NETFILTER_XT_MATCH_ECN=y
CONFIG_NETFILTER_XT_MATCH_ESP=y
CONFIG_NETFILTER_XT_MATCH_HASHLIMIT=y
CONFIG_NETFILTER_XT_MATCH_HELPER=y
CONFIG_NETFILTER_XT_MATCH_HL=y
CONFIG_NETFILTER_XT_MATCH_IPCOMP=y
CONFIG_NETFILTER_XT_MATCH_IPRANGE=y
CONFIG_NETFILTER_XT_MATCH_IPVS=y
CONFIG_NETFILTER_XT_MATCH_L2TP=y
CONFIG_NETFILTER_XT_MATCH_LENGTH=y
CONFIG_NETFILTER_XT_MATCH_LIMIT=y
CONFIG_NETFILTER_XT_MATCH_MAC=y
CONFIG_NETFILTER_XT_MATCH_MARK=y
CONFIG_NETFILTER_XT_MATCH_MULTIPORT=y
CONFIG_NETFILTER_XT_MATCH_NFACCT=y
CONFIG_NETFILTER_XT_MATCH_OSF=y
CONFIG_NETFILTER_XT_MATCH_OWNER=y
CONFIG_NETFILTER_XT_MATCH_POLICY=y
CONFIG_NETFILTER_XT_MATCH_PHYSDEV=y
CONFIG_NETFILTER_XT_MATCH_PKTTYPE=y
CONFIG_NETFILTER_XT_MATCH_QUOTA=y
CONFIG_NETFILTER_XT_MATCH_RATEEST=y
CONFIG_NETFILTER_XT_MATCH_REALM=y
CONFIG_NETFILTER_XT_MATCH_RECENT=y
CONFIG_NETFILTER_XT_MATCH_SCTP=y
CONFIG_NETFILTER_XT_MATCH_SOCKET=y
CONFIG_NETFILTER_XT_MATCH_STATE=y
CONFIG_NETFILTER_XT_MATCH_STATISTIC=y
CONFIG_NETFILTER_XT_MATCH_STRING=y
CONFIG_NETFILTER_XT_MATCH_TCPMSS=y
CONFIG_NETFILTER_XT_MATCH_TIME=y
CONFIG_NETFILTER_XT_MATCH_U32=y

# IP: Netfilter Configuration
CONFIG_NF_DEFRAG_IPV4=y
CONFIG_NF_SOCKET_IPV4=y
CONFIG_NF_TPROXY_IPV4=y
CONFIG_NF_TABLES_IPV4=y
CONFIG_NFT_REJECT_IPV4=y
CONFIG_NFT_DUP_IPV4=y
CONFIG_NFT_FIB_IPV4=y
CONFIG_NF_TABLES_ARP=y
CONFIG_NF_DUP_IPV4=y
CONFIG_NF_LOG_ARP=y
CONFIG_NF_LOG_IPV4=y
CONFIG_NF_REJECT_IPV4=y
CONFIG_NF_NAT_IPV4=y
CONFIG_NFT_CHAIN_NAT_IPV4=y
CONFIG_NFT_MASQ_IPV4=y
CONFIG_NFT_REDIR_IPV4=y
CONFIG_IP_NF_IPTABLES=y
CONFIG_IP_NF_MATCH_AH=y
CONFIG_IP_NF_MATCH_ECN=y
CONFIG_IP_NF_MATCH_RPFILTER=y
CONFIG_IP_NF_MATCH_TTL=y
CONFIG_IP_NF_FILTER=y
CONFIG_IP_NF_TARGET_REJECT=y
CONFIG_IP_NF_TARGET_SYNPROXY=y
CONFIG_IP_NF_NAT=y
CONFIG_IP_NF_TARGET_MASQUERADE=y
CONFIG_IP_NF_TARGET_NETMAP=y
CONFIG_IP_NF_TARGET_REDIRECT=y
CONFIG_IP_NF_MANGLE=y
CONFIG_IP_NF_TARGET_CLUSTERIP=y
CONFIG_IP_NF_TARGET_ECN=y
CONFIG_IP_NF_TARGET_TTL=y
CONFIG_IP_NF_RAW=y
CONFIG_IP_NF_SECURITY=y
CONFIG_IP_NF_ARPTABLES=y
CONFIG_IP_NF_ARPFILTER=y
CONFIG_IP_NF_ARP_MANGLE=y

# IPv6: Netfilter Configuration
CONFIG_NF_DEFRAG_IPV6=y
CONFIG_NF_SOCKET_IPV6=y
CONFIG_NF_TPROXY_IPV6=y
CONFIG_NF_TABLES_IPV6=y
CONFIG_NFT_REJECT_IPV6=y
CONFIG_NFT_DUP_IPV6=y
CONFIG_NFT_FIB_IPV6=y
CONFIG_NF_DUP_IPV6=y
CONFIG_NF_REJECT_IPV6=y
CONFIG_NF_NAT_IPV6=y
CONFIG_NFT_CHAIN_NAT_IPV6=y
CONFIG_NFT_MASQ_IPV6=y
CONFIG_NFT_REDIR_IPV6=y
CONFIG_IP6_NF_IPTABLES=y
CONFIG_IP6_NF_MATCH_AH=y
CONFIG_IP6_NF_MATCH_EUI64=y
CONFIG_IP6_NF_MATCH_FRAG=y
CONFIG_IP6_NF_MATCH_OPTS=y
CONFIG_IP6_NF_MATCH_HL=y
CONFIG_IP6_NF_MATCH_IPV6HEADER=y
CONFIG_IP6_NF_MATCH_MH=y
CONFIG_IP6_NF_MATCH_RPFILTER=y
CONFIG_IP6_NF_MATCH_RT=y
CONFIG_IP6_NF_MATCH_SRH=y
CONFIG_IP6_NF_TARGET_HL=y
CONFIG_IP6_NF_FILTER=y
CONFIG_IP6_NF_TARGET_REJECT=y
CONFIG_IP6_NF_TARGET_SYNPROXY=y
CONFIG_IP6_NF_MANGLE=y
CONFIG_IP6_NF_RAW=y
CONFIG_IP6_NF_SECURITY=y
CONFIG_IP6_NF_NAT=y
CONFIG_IP6_NF_TARGET_MASQUERADE=y
CONFIG_IP6_NF_TARGET_NPT=y

# Bridge: Netfilter Configuration
CONFIG_BRIDGE_NF_EBTABLES=y
CONFIG_BRIDGE_EBT_BROUTE=y

# Socket filtering
CONFIG_PACKET=y
CONFIG_PACKET_DIAG=y

# Unix domain sockets
CONFIG_UNIX=y
CONFIG_UNIX_DIAG=y

# TLS
CONFIG_TLS=y
CONFIG_TLS_DEVICE=y

# XDP sockets
CONFIG_XDP_SOCKETS=y
CONFIG_XDP_SOCKETS_DIAG=y

# INET socket monitoring
CONFIG_INET_DIAG=y
CONFIG_INET_TCP_DIAG=y
CONFIG_INET_UDP_DIAG=y
CONFIG_INET_RAW_DIAG=y
CONFIG_INET_DIAG_DESTROY=y

# TCP advanced congestion control
CONFIG_TCP_CONG_ADVANCED=y
CONFIG_TCP_CONG_CUBIC=y
CONFIG_DEFAULT_CUBIC=y

# TCP MD5 signature
CONFIG_TCP_MD5SIG=y

# TCP authentication
CONFIG_TCP_AO=y

# UDP socket
CONFIG_UDP=y
CONFIG_UDP_DIAG=y

# IPv6
CONFIG_IPV6=y
CONFIG_IPV6_ROUTER_PREF=y
CONFIG_IPV6_ROUTE_INFO=y
CONFIG_IPV6_OPTIMISTIC_DAD=y
CONFIG_INET6_AH=y
CONFIG_INET6_ESP=y
CONFIG_INET6_ESP_OFFLOAD=y
CONFIG_INET6_IPCOMP=y
CONFIG_IPV6_MIP6=y
CONFIG_IPV6_ILA=y
CONFIG_INET6_XFRM_TUNNEL=y
CONFIG_INET6_TUNNEL=y
CONFIG_INET6_XFRM_MODE_TRANSPORT=y
CONFIG_INET6_XFRM_MODE_TUNNEL=y
CONFIG_INET6_XFRM_MODE_BEET=y
CONFIG_INET6_XFRM_MODE_ROUTEOPTIMIZATION=y
CONFIG_IPV6_SIT=y
CONFIG_IPV6_SIT_6RD=y
CONFIG_IPV6_TUNNEL=y
CONFIG_IPV6_GRE=y
CONFIG_IPV6_FOU=y
CONFIG_IPV6_FOU_TUNNEL=y
CONFIG_IPV6_MULTIPLE_TABLES=y
CONFIG_IPV6_SUBTREES=y
CONFIG_IPV6_MROUTE=y
CONFIG_IPV6_MROUTE_MULTIPLE_TABLES=y
CONFIG_IPV6_PIMSM_V2=y

# Network device support
CONFIG_NETDEVICES=y
CONFIG_NET_CORE=y
CONFIG_DUMMY=y
CONFIG_VETH=y
CONFIG_TUN=y
CONFIG_VXLAN=y
CONFIG_GENEVE=y
CONFIG_GTP=y
CONFIG_MACSEC=y

# Wireless
CONFIG_WIRELESS=y
CONFIG_CFG80211=y
CONFIG_MAC80211=y

EOF
}

# Generate filesystem configuration (required for cgroup v2)
generate_filesystem_config() {
    log_info "Generating filesystem configuration..."

    cat << 'EOF'
#
# Filesystem Configuration (required for cgroup v2)
#
CONFIG_FS_POSIX_ACL=y
CONFIG_FILE_LOCKING=y

# Ext4 filesystem
CONFIG_EXT4_FS=y
CONFIG_EXT4_USE_FOR_EXT2=y
CONFIG_EXT4_FS_POSIX_ACL=y
CONFIG_EXT4_FS_SECURITY=y
CONFIG_JBD2=y

# XFS filesystem
CONFIG_XFS_FS=y
CONFIG_XFS_POSIX_ACL=y
CONFIG_XFS_RT=y
CONFIG_XFS_ONLINE_SCRUB=y
CONFIG_XFS_ONLINE_REPAIR=y

# Btrfs filesystem
CONFIG_BTRFS_FS=y
CONFIG_BTRFS_FS_POSIX_ACL=y

# proc filesystem
CONFIG_PROC_FS=y
CONFIG_PROC_KCORE=y
CONFIG_PROC_VMCORE=y
CONFIG_PROC_SYSCTL=y
CONFIG_PROC_PAGE_MONITOR=y

# sysfs
CONFIG_SYSFS=y

# tmpfs
CONFIG_TMPFS=y
CONFIG_TMPFS_POSIX_ACL=y
CONFIG_TMPFS_XATTR=y

# devtmpfs
CONFIG_DEVTMPFS=y
CONFIG_DEVTMPFS_MOUNT=y

# cgroup filesystem
CONFIG_CGROUPS=y
CONFIG_CGROUP_FAVOR_DYNMODS=y

# debugfs
CONFIG_DEBUG_FS=y

# tracefs
CONFIG_TRACING=y
CONFIG_TRACEPOINTS=y
CONFIG_TRACE_CLOCK=y
CONFIG_RING_BUFFER=y
CONFIG_EVENT_TRACING=y
CONFIG_CONTEXT_SWITCH_TRACER=y
CONFIG_TRACING=y
CONFIG_GENERIC_TRACER=y
CONFIG_TRACING_SUPPORT=y
CONFIG_FTRACE=y

# securityfs
CONFIG_SECURITYFS=y

# configfs
CONFIG_CONFIGFS_FS=y

# efivarfs
CONFIG_EFIVAR_FS=y

# hugetlbfs
CONFIG_HUGETLBFS=y
CONFIG_HUGETLB_PAGE=y

# memfd
CONFIG_MEMFD_CREATE=y

# overlayfs
CONFIG_OVERLAY_FS=y
CONFIG_OVERLAY_FS_INDEX=y
CONFIG_OVERLAY_FS_XINO_AUTO=y
CONFIG_OVERLAY_FS_METACOPY=y

EOF
}

# Generate boot parameters documentation
generate_boot_params() {
    log_info "Generating boot parameters documentation..."

    cat << 'EOF'
#
# Boot Parameters (P1.5)
#
# Add these to your bootloader configuration (GRUB, systemd-boot, etc.):
#
#   cgroup_no_v1=all
#   cgroup_enable=memory
#   cgroup_memory=1
#
# Example GRUB2 entry:
#   linux /vmlinuz-6.6.0-clawos root=/dev/sda1 ro quiet cgroup_no_v1=all cgroup_enable=memory cgroup_memory=1
#
# Example systemd-boot entry:
#   options root=/dev/sda1 ro quiet cgroup_no_v1=all cgroup_enable=memory cgroup_memory=1
#
EOF
}

# Generate footer
generate_footer() {
    cat << 'EOF'
#
# End of ClawOS Kernel Configuration
#
# Next steps:
#   1. Copy this file to your Linux kernel source directory
#   2. Run: make olddefconfig
#   3. Review: make menuconfig (optional)
#   4. Build: make -j$(nproc)
#   5. Install: make modules_install install
#   6. Update bootloader with boot parameters
#
# For more information, see:
#   - specs/p1/P1.5-cgroup-quotas.json
#   - SKILLS.md (lines 508-547)
#   - https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v2.html
#
EOF
}

# Main function
main() {
    log_info "ClawOS Linux ${KERNEL_VERSION} ${KERNEL_LTS} Kernel Config Generator"
    log_info "Output file: ${OUTPUT_FILE}"

    # Check if output directory exists
    OUTPUT_DIR=$(dirname "${OUTPUT_FILE}")
    if [ ! -d "${OUTPUT_DIR}" ]; then
        log_error "Output directory does not exist: ${OUTPUT_DIR}"
        exit 1
    fi

    # Generate configuration
    {
        print_header
        generate_cgroup_config
        generate_ebpf_config
        generate_namespace_config
        generate_seccomp_config
        generate_lsm_config
        generate_hardening_config
        generate_networking_config
        generate_filesystem_config
        generate_boot_params
        generate_footer
    } > "${OUTPUT_FILE}"

    # Count config options
    CONFIG_COUNT=$(grep -c "^CONFIG_[A-Z_]*=y" "${OUTPUT_FILE}" || true)
    log_info "Generated ${CONFIG_COUNT} kernel configuration options"

    # Verify critical options
    log_info "Verifying critical kernel options..."

    CRITICAL_OPTIONS=(
        "CONFIG_CGROUPS=y"
        "CONFIG_MEMCG=y"
        "CONFIG_CGROUP_PIDS=y"
        "CONFIG_CGROUP_BPF=y"
        "CONFIG_BPF=y"
        "CONFIG_BPF_SYSCALL=y"
        "CONFIG_BPF_JIT=y"
        "CONFIG_DEBUG_INFO_BTF=y"
        "CONFIG_BPF_LSM=y"
        "CONFIG_NAMESPACES=y"
        "CONFIG_USER_NS=y"
        "CONFIG_PID_NS=y"
        "CONFIG_NET_NS=y"
        "CONFIG_MNT_NS=y"
        "CONFIG_SECCOMP=y"
        "CONFIG_SECCOMP_FILTER=y"
        "CONFIG_SECURITY=y"
        "CONFIG_SECURITY_APPARMOR=y"
        'CONFIG_LSM="lockdown,yama,apparmor,bpf"'
        "CONFIG_RANDOMIZE_BASE=y"
        "CONFIG_STACKPROTECTOR_STRONG=y"
        "CONFIG_SLAB_FREELIST_HARDENED=y"
        "CONFIG_MODULE_SIG=y"
        "CONFIG_MODULE_SIG_FORCE=y"
        "CONFIG_SECURITY_LOCKDOWN_LSM=y"
    )

    MISSING_OPTIONS=()
    for option in "${CRITICAL_OPTIONS[@]}"; do
        if ! grep -q "^${option}" "${OUTPUT_FILE}"; then
            MISSING_OPTIONS+=("${option}")
        fi
    done

    if [ ${#MISSING_OPTIONS[@]} -gt 0 ]; then
        log_error "Missing critical options:"
        for option in "${MISSING_OPTIONS[@]}"; do
            log_error "  - ${option}"
        done
        exit 1
    fi

    log_info "All critical kernel options verified successfully"
    log_info "Configuration file generated: ${OUTPUT_FILE}"
    log_info ""
    log_info "To use this configuration:"
    log_info "  1. Copy to kernel source: cp ${OUTPUT_FILE} /path/to/linux-${KERNEL_VERSION}/.config"
    log_info "  2. Run: make olddefconfig"
    log_info "  3. Build: make -j\$(nproc)"
}

# Run main function
main "$@"
