# P4.6: AppArmor Profile Refinement Strategy

**Status:** DRAFT
**Version:** 1.0.0
**Spec ID:** P4.6
**Owner:** Security Agent
**Created:** 2026-02-24T00:00:00Z
**Related Specs:** P1.6 (AppArmor Profile Rule Language)

---

## Table of Contents

1. [Overview](#overview)
2. [Complain Mode Testing Procedures](#complain-mode-testing-procedures)
3. [Deny Rule Analysis](#deny-rule-analysis)
4. [False Positive Handling](#false-positive-handling)
5. [Gradual Enforce Mode Transition](#gradual-enforce-mode-transition)
6. [Audit Logging for Rule Violations](#audit-logging-for-rule-violations)
7. [Security Agent Approval Workflow](#security-agent-approval-workflow)
8. [Refinement Decision Matrix](#refinement-decision-matrix)
9. [Automated Refinement Tools](#automated-refinement-tools)

---

## Overview

This specification defines the strategy for refining AppArmor profiles in ClawOS, focusing on removing over-restrictions while maintaining security. The refinement process balances operational requirements with security constraints through systematic testing, analysis, and approval workflows.

### Objectives

1. **Remove Over-Restrictions**: Identify and eliminate rules that block legitimate operations
2. **Maintain Security**: Ensure no security-sensitive operations are inadvertently allowed
3. **Minimize False Positives**: Reduce violations that don't represent actual security threats
4. **Gradual Transition**: Move from complain mode to enforce mode safely
5. **Audit Trail**: Maintain complete logs of all profile changes and violations

### Scope

This specification applies to all ClawOS components with AppArmor profiles:
- `clawos-agent-loop` (MODERATE security level)
- `clawos-wasm-daemon` (STRICT security level)
- `clawos-kernel-svc` (MODERATE security level)

### Refinement Principles

| Principle            | Description                                                       |
| ---------------------| ------------------------------------------------------------------|
| **Minimum Required** | Only grant permissions absolutely necessary for operation         |
| **Defense in Depth** | AppArmor works with eBPF LSM and seccomp; don't rely on one layer |
| **Fail Safe**        | Default to deny when uncertain                                    |
| **Audit Everything** | Log all violations and profile changes                            |
| **Gradual Rollout**  | Test in complain mode before enforcing                            |

---

## Complain Mode Testing Procedures

### Phase 1: Initial Complain Mode Deployment

#### 1.1 Pre-Deployment Checklist

```bash
#!/bin/bash
# pre-complain-checklist.sh
# Verify system state before complain mode deployment

echo "=== Pre-Complain Mode Deployment Checklist ==="

# 1. Verify profile syntax
echo "[1/6] Validating profile syntax..."
for profile in /etc/apparmor.d/clawos-*; do
    if ! sudo apparmor_parser --skip-cache "$profile" 2>&1; then
        echo "ERROR: Syntax validation failed for $profile"
        exit 1
    fi
done
echo "OK: All profiles have valid syntax"

# 2. Check current profile status
echo "[2/6] Checking current profile status..."
sudo aa-status | grep clawos
echo "OK: Profile status retrieved"

# 3. Verify eBPF LSM is active
echo "[3/6] Verifying eBPF LSM status..."
if ! sudo bpftool prog show | grep -q clawos; then
    echo "WARNING: eBPF LSM programs not detected"
fi
echo "OK: eBPF LSM status checked"

# 4. Check audit logging is enabled
echo "[4/6] Verifying audit logging..."
if ! sudo auditctl -l | grep -q apparmor; then
    echo "WARNING: AppArmor audit rules not configured"
    sudo auditctl -w /etc/apparmor.d/ -p wa -k apparmor_changes
fi
echo "OK: Audit logging configured"

# 5. Verify log directory exists
echo "[5/6] Checking log directories..."
sudo mkdir -p /var/log/clawos/apparmor
sudo touch /var/log/clawos/apparmor/complain-mode.log
echo "OK: Log directories ready"

# 6. Backup current profiles
echo "[6/6] Backing up current profiles..."
BACKUP_DIR="/var/backups/clawos/apparmor/$(date +%Y%m%d_%H%M%S)"
sudo mkdir -p "$BACKUP_DIR"
sudo cp /etc/apparmor.d/clawos-* "$BACKUP_DIR/"
echo "OK: Profiles backed up to $BACKUP_DIR"

echo "=== Pre-Deployment Checklist Complete ==="
```

#### 1.2 Deploy to Complain Mode

```bash
#!/bin/bash
# deploy-complain-mode.sh
# Deploy all ClawOS profiles in complain mode

PROFILES=(
    "clawos-agent-loop"
    "clawos-wasm-daemon"
    "clawos-kernel-svc"
)

echo "=== Deploying Profiles in Complain Mode ==="

for profile in "${PROFILES[@]}"; do
    echo "Deploying $profile in complain mode..."

    # Method 1: Using aa-complain
    sudo aa-complain "/usr/bin/$profile"

    # Method 2: Using apparmor_parser (alternative)
    # sudo apparmor_parser -C "/etc/apparmor.d/$profile"

    # Verify deployment
    if sudo aa-status | grep -q "$profile.*complain"; then
        echo "OK: $profile is in complain mode"
    else
        echo "ERROR: Failed to deploy $profile in complain mode"
        exit 1
    fi
done

echo "=== All Profiles Deployed in Complain Mode ==="
```

### Phase 2: Testing Scenarios

#### 2.1 Normal Operations Testing

```bash
#!/bin/bash
# test-normal-operations.sh
# Test normal operations under complain mode

echo "=== Testing Normal Operations ==="

# Test 1: Agent loop startup
echo "[1/10] Testing agent loop startup..."
sudo systemctl start clawos-agent-loop
sleep 5
if sudo systemctl is-active --quiet clawos-agent-loop; then
    echo "OK: Agent loop started successfully"
else
    echo "ERROR: Agent loop failed to start"
fi

# Test 2: PostgreSQL connection
echo "[2/10] Testing PostgreSQL connection..."
sudo -u clawos psql -h 127.0.0.1 -p 5432 -c "SELECT 1;" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "OK: PostgreSQL connection successful"
else
    echo "WARNING: PostgreSQL connection failed"
fi

# Test 3: WASM tool execution
echo "[3/10] Testing WASM tool execution..."
sudo -u clawos clawos-agent-loop --test-wasm-tool > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "OK: WASM tool execution successful"
else
    echo "WARNING: WASM tool execution failed"
fi

# Test 4: File operations in workspace
echo "[4/10] Testing file operations..."
TEST_FILE="/var/lib/clawos/workspace/test_$(date +%s).txt"
sudo -u clawos touch "$TEST_FILE"
sudo -u clawos echo "test" > "$TEST_FILE"
sudo -u clawos cat "$TEST_FILE" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "OK: File operations successful"
    sudo rm -f "$TEST_FILE"
else
    echo "WARNING: File operations failed"
fi

# Test 5: Configuration file access
echo "[5/10] Testing configuration file access..."
sudo -u clawos cat /etc/clawos/config.json > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "OK: Configuration file access successful"
else
    echo "WARNING: Configuration file access failed"
fi

# Test 6: Log file writing
echo "[6/10] Testing log file writing..."
sudo -u clawos logger -t clawos-test "Test log message" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "OK: Log file writing successful"
else
    echo "WARNING: Log file writing failed"
fi

# Test 7: Kernel service operations
echo "[7/10] Testing kernel service operations..."
sudo systemctl status clawos-kernel-svc > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "OK: Kernel service operational"
else
    echo "WARNING: Kernel service not operational"
fi

# Test 8: eBPF program loading
echo "[8/10] Testing eBPF program loading..."
sudo bpftool prog show | grep -q clawos
if [ $? -eq 0 ]; then
    echo "OK: eBPF programs loaded"
else
    echo "WARNING: eBPF programs not loaded"
fi

# Test 9: cgroup operations
echo "[9/10] Testing cgroup operations..."
sudo cat /sys/fs/cgroup/clawos/memory.current > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "OK: cgroup operations successful"
else
    echo "WARNING: cgroup operations failed"
fi

# Test 10: Signal handling
echo "[10/10] Testing signal handling..."
sudo kill -USR1 $(pgrep clawos-agent-loop) > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "OK: Signal handling successful"
else
    echo "WARNING: Signal handling failed"
fi

echo "=== Normal Operations Testing Complete ==="
```

#### 2.2 Error Conditions Testing

```bash
#!/bin/bash
# test-error-conditions.sh
# Test error conditions to verify deny rules work correctly

echo "=== Testing Error Conditions ==="

# Test 1: Attempt to modify /etc/passwd (should be denied)
echo "[1/5] Testing /etc/passwd modification denial..."
sudo -u clawos sh -c 'echo "test" >> /etc/passwd' > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "OK: /etc/passwd modification correctly denied"
else
    echo "ERROR: /etc/passwd modification was allowed (SECURITY ISSUE)"
fi

# Test 2: Attempt to access /etc/shadow (should be denied)
echo "[2/5] Testing /etc/shadow access denial..."
sudo -u clawos cat /etc/shadow > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "OK: /etc/shadow access correctly denied"
else
    echo "ERROR: /etc/shadow access was allowed (SECURITY ISSUE)"
fi

# Test 3: Attempt to load kernel module (should be denied for most components)
echo "[3/5] Testing kernel module loading denial..."
sudo -u clawos insmod /tmp/test_module.ko > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "OK: Kernel module loading correctly denied"
else
    echo "WARNING: Kernel module loading was allowed (may be expected for kernel-svc)"
fi

# Test 4: Attempt to access block devices (should be denied)
echo "[4/5] Testing block device access denial..."
sudo -u clawos dd if=/dev/sda of=/tmp/test bs=512 count=1 > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "OK: Block device access correctly denied"
else
    echo "ERROR: Block device access was allowed (SECURITY ISSUE)"
fi

# Test 5: Attempt to connect to external network (should be denied)
echo "[5/5] Testing external network access denial..."
sudo -u clawos curl -s https://example.com > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "OK: External network access correctly denied"
else
    echo "ERROR: External network access was allowed (SECURITY ISSUE)"
fi

echo "=== Error Conditions Testing Complete ==="
```

#### 2.3 Extended Testing Duration

**Minimum Testing Period**: 7 days in complain mode

**Testing Schedule**:

| Day | Activity                           | Purpose                         |
| ----| -----------------------------------| --------------------------------|
| 1   | Initial deployment and basic tests | Verify profile loads correctly  |
| 2-3 | Normal operations testing          | Run all standard workflows      |
| 4   | Error conditions testing           | Verify deny rules work          |
| 5-6 | Extended operations testing        | Run edge cases and stress tests |
| 7   | Violation analysis and refinement  | Analyze logs and refine profile |

### Phase 3: Violation Collection

```bash
#!/bin/bash
# collect-violations.sh
# Collect and categorize AppArmor violations

echo "=== Collecting AppArmor Violations ==="

VIOLATION_LOG="/var/log/clawos/apparmor/violations_$(date +%Y%m%d_%H%M%S).log"
mkdir -p /var/log/clawos/apparmor

# Collect violations from journal
|  |
| grep -E "(DENIED | REJECTING)" |

# Collect violations from audit log
|  |
| grep apparmor |

# Collect violations from dmesg
|  |
| grep -i apparmor | grep -E "(DENIED | REJECTING)" |

# Generate summary
|  |
| grep -c -E "(DENIED | REJECTING)")" |

echo "=== Violations collected to $VIOLATION_LOG ==="
```

---

## Deny Rule Analysis

### Analysis Framework

#### 3.1 Deny Rule Classification

| Category              | Description                                  | Example                                                  | Action                          |
| ----------------------| ---------------------------------------------| ---------------------------------------------------------| --------------------------------|
| **Security-Critical** | Blocks operations that must never be allowed | `deny /etc/passwd w`                                     | **KEEP** - Never remove         |
| **Over-Restrictive**  | Blocks legitimate operations                 | `deny /tmp/** rw`                                        | **REFINE** - Make more specific |
| **Redundant**         | Covered by other deny rules                  | `deny /etc/passwd rw` (when `deny /etc/passwd w` exists) | **REMOVE** - Duplicate          |
| **Outdated**          | No longer applicable                         | `deny /old/path/** w`                                    | **REMOVE** - Path doesn't exist |
| **Conditional**       | Should only apply in certain contexts        | `deny network inet` (for WASM daemon)                    | **KEEP** - Context-specific     |

#### 3.2 Deny Rule Analysis Procedure

```bash
#!/bin/bash
# analyze-deny-rules.sh
# Analyze deny rules in AppArmor profiles

echo "=== Deny Rule Analysis ==="

PROFILES=(
    "/etc/apparmor.d/clawos-agent-loop"
    "/etc/apparmor.d/clawos-wasm-daemon"
    "/etc/apparmor.d/clawos-kernel-svc"
)

for profile in "${PROFILES[@]}"; do
    echo -e "\n=== Analyzing $profile ==="

    # Extract deny rules
    echo "Deny rules found:"
    grep -n "deny" "$profile" | while read -r line; do
        echo "  $line"
    done

    # Check for security-critical deny rules
    echo -e "\nSecurity-critical deny rules:"
| /etc/shadow | /etc/sudoers | /etc/ssh)" "$profile" |
        echo "  [KEEP] $line"
    done

    # Check for potentially over-restrictive rules
    echo -e "\nPotentially over-restrictive rules (broad patterns):"
    grep -E "deny.*/\*\*" "$profile" | while read -r line; do
        echo "  [REVIEW] $line"
    done

    # Check for redundant deny rules
    echo -e "\nChecking for redundant deny rules..."
    # This would require more complex analysis
    echo "  (Manual review required for redundancy detection)"
done

echo -e "\n=== Analysis Complete ==="
```

#### 3.3 Deny Rule Impact Assessment

For each deny rule, assess:

1. **Security Impact**: What security risk does this rule mitigate?
2. **Operational Impact**: What legitimate operations does this rule block?
3. **Frequency**: How often is this rule triggered in complain mode?
4. **Alternatives**: Can the same security be achieved with a more specific rule?

**Impact Assessment Template**:

```markdown
## Deny Rule: [rule text]

### Security Impact
| HIGH | MEDIUM |
- **Threat Model**: [description of threat]
- **Mitigation**: [how this rule mitigates the threat]

### Operational Impact
- **Blocked Operations**: [list of operations blocked]
- **Frequency**: [number of violations in testing period]
- **Workarounds**: [any workarounds available]

### Recommendation
| REFINE |
- **Justification**: [reason for recommendation]
- **Proposed Change**: [if REFINE, propose new rule]
```

### Common Over-Restriction Patterns

#### Pattern 1: Overly Broad File Deny Rules

**Problem**:
```apparmor
deny /tmp/** rw,  # Blocks ALL temp file access
```

**Refinement**:
```apparmor
deny /tmp/clawos-agent-loop/** rw,  # Only block specific temp directory
owner /tmp/** rw,  # Allow owner's temp files
```

#### Pattern 2: Overly Broad Network Deny Rules

**Problem**:
```apparmor
deny network inet,  # Blocks ALL IPv4 access
```

**Refinement**:
```apparmor
deny network inet stream,  # Only block TCP
network inet stream tcp to 127.0.0.1 port 5432,  # Allow PostgreSQL
```

#### Pattern 3: Redundant Deny Rules

**Problem**:
```apparmor
deny /etc/passwd rw,
deny /etc/passwd w,  # Redundant - rw includes w
```

**Refinement**:
```apparmor
deny /etc/passwd w,  # Keep only the specific rule
```

#### Pattern 4: Outdated Path Deny Rules

**Problem**:
```apparmor
deny /var/lib/old-clawos/** rw,  # Path doesn't exist
```

**Refinement**:
```apparmor
# Remove the rule entirely
```

---

## False Positive Handling

### False Positive Classification

| Type                     | Description                                | Example             | Resolution                      |
| -------------------------| -------------------------------------------| --------------------| --------------------------------|
| **Legitimate Operation** | Operation is required for normal operation | Reading config file | Add allow rule                  |
| **Library Dependency**   | Operation required by shared library       | Loading .so file    | Add library path                |
| **Transient Operation**  | Operation occurs during startup/shutdown   | Creating PID file   | Add specific path               |
| **Debug Operation**      | Operation only during debugging            | Writing debug log   | Add debug-specific rule         |
| **Test Artifact**        | Operation only during testing              | Creating test file  | Exclude from production profile |

### False Positive Detection

```bash
#!/bin/bash
# detect-false-positives.sh
# Detect potential false positives in violation logs

echo "=== False Positive Detection ==="

VIOLATION_LOG="$1"

if [ -z "$VIOLATION_LOG" ]; then
    echo "Usage: $0 <violation_log>"
    exit 1
fi

# Pattern 1: Legitimate config file access
echo -e "\n=== Potential False Positives: Config File Access ==="
| REJECTING).*config" "$VIOLATION_LOG" |
    echo "  $line"
    echo "  [ACTION] Review if config file access is legitimate"
done

# Pattern 2: Library loading
echo -e "\n=== Potential False Positives: Library Loading ==="
| REJECTING).*\.so" "$VIOLATION_LOG" |
    echo "  $line"
    echo "  [ACTION] Add library path to profile"
done

# Pattern 3: Temporary file operations
echo -e "\n=== Potential False Positives: Temporary Files ==="
| REJECTING).*(/tmp | /var/tmp)" "$VIOLATION_LOG" |
    echo "  $line"
    echo "  [ACTION] Review temp file access pattern"
done

# Pattern 4: Log file writing
echo -e "\n=== Potential False Positives: Log File Writing ==="
| REJECTING).*log" "$VIOLATION_LOG" |
    echo "  $line"
    echo "  [ACTION] Add log file path to profile"
done

# Pattern 5: Runtime directory access
echo -e "\n=== Potential False Positives: Runtime Directory ==="
| REJECTING).*(/run | /var/run)" "$VIOLATION_LOG" |
    echo "  $line"
    echo "  [ACTION] Review runtime directory access"
done

echo -e "\n=== False Positive Detection Complete ==="
```

### False Positive Resolution Workflow

#### Step 1: Identify the Operation

Extract the exact operation from the violation log:

```
apparmor="DENIED" operation="open" profile="clawos-agent-loop" name="/etc/clawos/config.json" pid=1234 comm="clawos-agent-loop" requested_mask="r" denied_mask="r" fsuid=1000 ouid=0
```

**Key fields**:
- `operation`: Type of operation (open, mkdir, connect, etc.)
- `name`: Path or resource being accessed
- `requested_mask`: Permissions requested
- `denied_mask`: Permissions denied

#### Step 2: Verify Legitimacy

Check if the operation is legitimate:

```bash
#!/bin/bash
# verify-legitimacy.sh
# Verify if a denied operation is legitimate

OPERATION="$1"
PATH="$2"
PROFILE="$3"

echo "=== Verifying Legitimacy ==="
echo "Operation: $OPERATION"
echo "Path: $PATH"
echo "Profile: $PROFILE"

# Check if path exists
if [ -e "$PATH" ]; then
    echo "Path exists: YES"
else
    echo "Path exists: NO (may be transient)"
fi

# Check if path is in expected locations
case "$PATH" in
    /etc/clawos/*)
        echo "Location: ClawOS config directory (LEGITIMATE)"
        ;;
    /var/lib/clawos/*)
        echo "Location: ClawOS data directory (LEGITIMATE)"
        ;;
    /var/log/clawos/*)
        echo "Location: ClawOS log directory (LEGITIMATE)"
        ;;
    /run/clawos/*)
        echo "Location: ClawOS runtime directory (LEGITIMATE)"
        ;;
    /tmp/clawos*)
        echo "Location: ClawOS temp directory (LEGITIMATE)"
        ;;
| /etc/shadow |
        echo "Location: Security-sensitive file (VERIFY CAREFULLY)"
        ;;
    *)
        echo "Location: Unknown (REVIEW REQUIRED)"
        ;;
esac

# Check if operation is expected for profile
case "$PROFILE" in
    clawos-agent-loop)
        case "$PATH" in
| /var/lib/clawos/* | /var/log/clawos/* |
                echo "Operation: Expected for agent-loop profile"
                ;;
            *)
                echo "Operation: Unexpected for agent-loop profile (REVIEW)"
                ;;
        esac
        ;;
    clawos-wasm-daemon)
        case "$PATH" in
| /var/lib/clawos/wasm-cache/* |
                echo "Operation: Expected for wasm-daemon profile"
                ;;
            *)
                echo "Operation: Unexpected for wasm-daemon profile (REVIEW)"
                ;;
        esac
        ;;
    clawos-kernel-svc)
        case "$PATH" in
| /sys/fs/cgroup/* |
                echo "Operation: Expected for kernel-svc profile"
                ;;
            *)
                echo "Operation: Unexpected for kernel-svc profile (REVIEW)"
                ;;
        esac
        ;;
esac

echo "=== Legitimacy Verification Complete ==="
```

#### Step 3: Create Allow Rule

If the operation is legitimate, create an appropriate allow rule:

```bash
#!/bin/bash
# generate-allow-rule.sh
# Generate an allow rule based on violation log

VIOLATION_LINE="$1"

# Parse violation line
OPERATION=$(echo "$VIOLATION_LINE" | grep -oP 'operation="\K[^"]+')
NAME=$(echo "$VIOLATION_LINE" | grep -oP 'name="\K[^"]+')
REQUESTED_MASK=$(echo "$VIOLATION_LINE" | grep -oP 'requested_mask="\K[^"]+')

echo "=== Generating Allow Rule ==="
echo "Operation: $OPERATION"
echo "Path: $NAME"
echo "Permissions: $REQUESTED_MASK"

# Generate rule based on operation type
case "$OPERATION" in
| create | unlink |
        # File operation
        echo "Generated rule:"
        echo "$NAME $REQUESTED_MASK,"
        ;;
| bind |
        # Network operation
        echo "Network operation detected - manual rule generation required"
        echo "Violation details:"
        echo "$VIOLATION_LINE"
        ;;
    *)
        echo "Unknown operation type: $OPERATION"
        echo "Manual rule generation required"
        ;;
esac

echo "=== Allow Rule Generation Complete ==="
```

#### Step 4: Test the Allow Rule

Before adding the rule to the profile, test it:

```bash
#!/bin/bash
# test-allow-rule.sh
# Test an allow rule before adding to profile

PROFILE="$1"
RULE="$2"

echo "=== Testing Allow Rule ==="
echo "Profile: $PROFILE"
echo "Rule: $RULE"

# Create temporary profile with the new rule
TEMP_PROFILE="/tmp/test_profile_$$.apparmor"
cp "/etc/apparmor.d/$PROFILE" "$TEMP_PROFILE"

# Add the rule before the closing brace
sed -i '$ i\  '"$RULE" "$TEMP_PROFILE"

# Validate the profile
echo "Validating profile with new rule..."
if sudo apparmor_parser --skip-cache "$TEMP_PROFILE" 2>&1; then
    echo "OK: Profile syntax is valid"
else
    echo "ERROR: Profile syntax is invalid"
    rm -f "$TEMP_PROFILE"
    exit 1
fi

# Load the profile in complain mode
echo "Loading profile in complain mode..."
if sudo apparmor_parser -C "$TEMP_PROFILE" 2>&1; then
    echo "OK: Profile loaded successfully"
else
    echo "ERROR: Failed to load profile"
    rm -f "$TEMP_PROFILE"
    exit 1
fi

# Test the operation
echo "Testing the operation..."
# (This would be specific to the operation being tested)

# Clean up
sudo apparmor_parser -R "$TEMP_PROFILE" 2>&1
rm -f "$TEMP_PROFILE"

echo "=== Allow Rule Testing Complete ==="
```

---

## Gradual Enforce Mode Transition

### Transition Strategy

The transition from complain mode to enforce mode follows a gradual, phased approach to minimize risk.

### Phase 1: Partial Enforcement (30% of Rules)

```bash
#!/bin/bash
# transition-partial-enforce.sh
# Transition to partial enforcement mode

echo "=== Transitioning to Partial Enforcement (30%) ==="

PROFILES=(
    "clawos-agent-loop"
    "clawos-wasm-daemon"
    "clawos-kernel-svc"
)

for profile in "${PROFILES[@]}"; do
    echo "Processing $profile..."

    # Create partial enforcement profile
    # This would involve:
    # 1. Keeping deny rules in place
    # 2. Adding audit flag to allow rules to log allowed operations
    # 3. Monitoring for unexpected allowed operations

    # For now, we'll use the audit flag
    sudo sed -i 's/flags=(/flags=(audit,/' "/etc/apparmor.d/$profile"

    # Reload the profile
    sudo apparmor_parser -r "/etc/apparmor.d/$profile"

    echo "OK: $profile transitioned to partial enforcement"
done

echo "=== Partial Enforcement Transition Complete ==="
```

### Phase 2: Monitoring Period (7 Days)

During the monitoring period:

1. **Monitor for unexpected allowed operations**
2. **Verify all deny rules are working**
3. **Check for performance impact**
4. **Review audit logs**

```bash
#!/bin/bash
# monitor-partial-enforce.sh
# Monitor partial enforcement mode

echo "=== Monitoring Partial Enforcement ==="

# Check for unexpected allowed operations
echo "Checking for unexpected allowed operations..."
| grep -E "ALLOWED" |

# Verify deny rules are working
echo "Verifying deny rules..."
| grep -E "DENIED" |

# Check performance impact
echo "Checking performance impact..."
| grep -E "Active |

# Generate report
echo "Generating monitoring report..."
REPORT_FILE="/var/log/clawos/apparmor/partial-enforce-report_$(date +%Y%m%d).log"
{
    echo "=== Partial Enforcement Monitoring Report ==="
    echo "Date: $(date)"
    echo ""
    echo "Unexpected allowed operations:"
| grep -E "ALLOWED" |
    echo ""
    echo "Denied operations count:"
| grep -E "DENIED" |
    echo ""
    echo "Service status:"
| grep -E "Active |
} > "$REPORT_FILE"

echo "Report saved to $REPORT_FILE"
echo "=== Monitoring Complete ==="
```

### Phase 3: Full Enforcement (100% of Rules)

```bash
#!/bin/bash
# transition-full-enforce.sh
# Transition to full enforcement mode

echo "=== Transitioning to Full Enforcement ==="

PROFILES=(
    "clawos-agent-loop"
    "clawos-wasm-daemon"
    "clawos-kernel-svc"
)

for profile in "${PROFILES[@]}"; do
    echo "Processing $profile..."

    # Remove audit flag (if added in partial enforcement)
    sudo sed -i 's/flags=(audit,/flags=(/' "/etc/apparmor.d/$profile"

    # Set to enforce mode
    sudo aa-enforce "/usr/bin/$profile"

    # Verify enforcement
    if sudo aa-status | grep -q "$profile.*enforce"; then
        echo "OK: $profile is in enforce mode"
    else
        echo "ERROR: Failed to set $profile to enforce mode"
        exit 1
    fi
done

echo "=== Full Enforcement Transition Complete ==="
```

### Rollback Procedure

If issues arise during enforcement:

```bash
#!/bin/bash
# rollback-to-complain.sh
# Rollback to complain mode

echo "=== Rolling Back to Complain Mode ==="

PROFILES=(
    "clawos-agent-loop"
    "clawos-wasm-daemon"
    "clawos-kernel-svc"
)

for profile in "${PROFILES[@]}"; do
    echo "Rolling back $profile..."

    # Set to complain mode
    sudo aa-complain "/usr/bin/$profile"

    # Verify rollback
    if sudo aa-status | grep -q "$profile.*complain"; then
        echo "OK: $profile rolled back to complain mode"
    else
        echo "ERROR: Failed to rollback $profile"
        exit 1
    fi
done

echo "=== Rollback Complete ==="
```

### Transition Checklist

| Phase                   | Duration | Checklist Items                                                                                                                   |
| ------------------------| ---------| ----------------------------------------------------------------------------------------------------------------------------------|
| **Complain Mode**       | 7 days   | [ ] All normal operations tested<br>[ ] Error conditions tested<br>[ ] Violations collected<br>[ ] False positives identified     |
| **Partial Enforcement** | 7 days   | [ ] Audit flag added<br>[ ] Monitoring configured<br>[ ] Unexpected operations reviewed<br>[ ] Performance checked                |
| **Full Enforcement**    | Ongoing  | [ ] All profiles in enforce mode<br>[ ] Monitoring active<br>[ ] Rollback plan documented<br>[ ] Security Agent approval obtained |

---

## Audit Logging for Rule Violations

### Audit Log Configuration

#### 6.1 Configure Audit Rules

```bash
#!/bin/bash
# configure-audit-logging.sh
# Configure audit logging for AppArmor violations

echo "=== Configuring Audit Logging ==="

# Add audit rules for AppArmor
sudo auditctl -w /etc/apparmor.d/ -p wa -k apparmor_changes
sudo auditctl -w /var/log/apparmor/ -p wa -k apparmor_logs
sudo auditctl -a always,exit -F arch=b64 -S apparmor -k apparmor_violations

# Make audit rules persistent
sudo mkdir -p /etc/audit/rules.d
cat <<EOF | sudo tee /etc/audit/rules.d/apparmor.rules
-w /etc/apparmor.d/ -p wa -k apparmor_changes
-w /var/log/apparmor/ -p wa -k apparmor_logs
-a always,exit -F arch=b64 -S apparmor -k apparmor_violations
EOF

# Restart auditd
sudo systemctl restart auditd

echo "OK: Audit logging configured"
echo "=== Audit Logging Configuration Complete ==="
```

#### 6.2 Custom Violation Logger

```bash
#!/bin/bash
# log-violations.sh
# Custom violation logger for AppArmor

VIOLATION_LOG="/var/log/clawos/apparmor/violations.log"
SUMMARY_LOG="/var/log/clawos/apparmor/violations-summary.log"

mkdir -p /var/log/clawos/apparmor

# Monitor journalctl for violations
|  |
| grep -qE "(DENIED |
        # Log the violation
        echo "$(date -Iseconds) $line" >> "$VIOLATION_LOG"

        # Extract key information
        PROFILE=$(echo "$line" | grep -oP 'profile="\K[^"]+')
        OPERATION=$(echo "$line" | grep -oP 'operation="\K[^"]+')
        NAME=$(echo "$line" | grep -oP 'name="\K[^"]+')

        # Update summary
        {
| $PROFILE | $OPERATION |
        } >> "$SUMMARY_LOG"

        # Alert if critical violation
| grep -qE "(passwd | shadow |
            echo "CRITICAL: Security-sensitive file access attempt detected"
            # Send alert (would integrate with alerting system)
        fi
    fi
done
```

### Violation Log Format

#### Standard Format

```
| clawos-agent-loop | open | /etc/clawos/config.json | requested_mask="r" | denied_mask="r" |
```

#### Fields

| Field            | Description           | Example                     |
| -----------------| ----------------------| ----------------------------|
| `timestamp`      | ISO 8601 timestamp    | `2026-02-24T10:30:45+00:00` |
| `profile`        | AppArmor profile name | `clawos-agent-loop`         |
| `operation`      | Type of operation     | `open`, `connect`, `mkdir`  |
| `name`           | Path or resource      | `/etc/clawos/config.json`   |
| `requested_mask` | Permissions requested | `r`, `w`, `rw`              |
| `denied_mask`    | Permissions denied    | `r`, `w`, `rw`              |
| `pid`            | Process ID            | `1234`                      |

### Violation Analysis

```bash
#!/bin/bash
# analyze-violations.sh
# Analyze violation logs

VIOLATION_LOG="$1"

if [ -z "$VIOLATION_LOG" ]; then
    echo "Usage: $0 <violation_log>"
    exit 1
fi

echo "=== Violation Analysis ==="

# Total violations
TOTAL=$(wc -l < "$VIOLATION_LOG")
echo "Total violations: $TOTAL"

# Violations by profile
echo -e "\n=== Violations by Profile ==="
| ' '{print $3}' "$VIOLATION_LOG" | sort | uniq -c |

# Violations by operation
echo -e "\n=== Violations by Operation ==="
| ' '{print $4}' "$VIOLATION_LOG" | sort | uniq -c |

# Top 10 most violated paths
echo -e "\n=== Top 10 Most Violated Paths ==="
| ' '{print $5}' "$VIOLATION_LOG" | sort | uniq -c | sort -rn |

# Security-sensitive violations
echo -e "\n=== Security-Sensitive Violations ==="
| shadow | sudoers |

# Recent violations (last 24 hours)
echo -e "\n=== Recent Violations (Last 24 Hours) ==="
SINCE=$(date -d '24 hours ago' -Iseconds)
awk -F'|' -v since="$SINCE" '$1 >= since' "$VIOLATION_LOG"

echo "=== Analysis Complete ==="
```

### Violation Alerting

```bash
#!/bin/bash
# violation-alert.sh
# Send alerts for critical violations

VIOLATION_LOG="/var/log/clawos/apparmor/violations.log"
ALERT_LOG="/var/log/clawos/apparmor/alerts.log"

# Check for critical violations in the last hour
| grep -E "(DENIED | REJECTING)" | grep -E "(passwd | shadow | sudoers | ssh)" |

if [ "$CRITICAL_VIOLATIONS" -gt 0 ]; then
    ALERT_MESSAGE="CRITICAL: $CRITICAL_VIOLATIONS security-sensitive violations detected in the last hour"

    # Log the alert
    echo "$(date -Iseconds) $ALERT_MESSAGE" >> "$ALERT_LOG"

    # Send alert (would integrate with alerting system)
    # For now, just print
    echo "$ALERT_MESSAGE"

    # Could also send email, Slack, etc.
    # echo "$ALERT_MESSAGE" | mail -s "AppArmor Critical Violation" security@example.com
fi

# Check for high violation rate
| grep -cE "(DENIED |
if [ "$VIOLATION_RATE" -gt 100 ]; then
    ALERT_MESSAGE="WARNING: High violation rate detected: $VIOLATION_RATE violations in the last hour"

    echo "$(date -Iseconds) $ALERT_MESSAGE" >> "$ALERT_LOG"
    echo "$ALERT_MESSAGE"
fi
```

---

## Security Agent Approval Workflow

### Approval Process

#### 7.1 Profile Modification Request

All profile modifications must follow this approval workflow:

```bash
#!/bin/bash
# submit-profile-change.sh
# Submit a profile modification request

PROFILE="$1"
CHANGE_DESCRIPTION="$2"
JUSTIFICATION="$3"

|  | [ -z "$CHANGE_DESCRIPTION" ] |  |
    echo "Usage: $0 <profile> <change_description> <justification>"
    exit 1
fi

REQUEST_DIR="/var/lib/clawos/apparmor-requests"
REQUEST_ID="$(date +%Y%m%d_%H%M%S)_$PROFILE"
REQUEST_FILE="$REQUEST_DIR/$REQUEST_ID.json"

mkdir -p "$REQUEST_DIR"

# Create request JSON
cat <<EOF | sudo tee "$REQUEST_FILE"
{
  "request_id": "$REQUEST_ID",
  "profile": "$PROFILE",
  "status": "pending",
  "submitted_at": "$(date -Iseconds)",
  "submitted_by": "$(whoami)",
  "change_description": "$CHANGE_DESCRIPTION",
  "justification": "$JUSTIFICATION",
  "current_profile_hash": "$(sha256sum /etc/apparmor.d/$PROFILE | awk '{print $1}')",
  "approval": null,
  "deployed": false
}
EOF

echo "Profile change request submitted: $REQUEST_ID"
echo "Request file: $REQUEST_FILE"
```

#### 7.2 Security Agent Review

```bash
#!/bin/bash
# review-profile-change.sh
# Review a profile modification request

REQUEST_ID="$1"

if [ -z "$REQUEST_ID" ]; then
    echo "Usage: $0 <request_id>"
    exit 1
fi

REQUEST_FILE="/var/lib/clawos/apparmor-requests/$REQUEST_ID.json"

if [ ! -f "$REQUEST_FILE" ]; then
    echo "ERROR: Request not found: $REQUEST_ID"
    exit 1
fi

echo "=== Profile Change Request Review ==="
echo ""

# Display request details
jq '.' "$REQUEST_FILE"

echo ""
echo "=== Review Checklist ==="

# Extract profile name
PROFILE=$(jq -r '.profile' "$REQUEST_FILE")

# Check for security-sensitive changes
echo "[1/5] Checking for security-sensitive changes..."
| grep -qiE "(deny | capability | network | passwd |
    echo "WARNING: Security-sensitive changes detected"
    echo "ACTION: Requires thorough review"
else
    echo "OK: No obvious security-sensitive changes"
fi

# Check profile syntax
echo "[2/5] Validating profile syntax..."
if sudo apparmor_parser --skip-cache "/etc/apparmor.d/$PROFILE" 2>&1; then
    echo "OK: Profile syntax is valid"
else
    echo "ERROR: Profile syntax is invalid"
    exit 1
fi

# Check for unconfined transitions
echo "[3/5] Checking for unconfined transitions..."
if grep -q "change_profile -> unconfined" "/etc/apparmor.d/$PROFILE"; then
    echo "WARNING: Unconfined transition found"
    echo "ACTION: Requires explicit justification"
else
    echo "OK: No unconfined transitions"
fi

# Check for overly broad rules
echo "[4/5] Checking for overly broad rules..."
if grep -E "deny.*/\*\*" "/etc/apparmor.d/$PROFILE" | grep -v "#"; then
    echo "WARNING: Overly broad deny rules found"
    echo "ACTION: Review if rules can be more specific"
else
    echo "OK: No overly broad rules detected"
fi

# Check compliance with security hierarchy
echo "[5/5] Checking compliance with security hierarchy..."
echo "ACTION: Manual review required for eBPF LSM integration"

echo ""
echo "=== Review Complete ==="
```

#### 7.3 Approval Decision

```bash
#!/bin/bash
# approve-profile-change.sh
# Approve or reject a profile modification request

REQUEST_ID="$1"
DECISION="$2"  # approve, reject, conditional
COMMENTS="$3"

|        |
| reject |
    exit 1
fi

REQUEST_FILE="/var/lib/clawos/apparmor-requests/$REQUEST_ID.json"

if [ ! -f "$REQUEST_FILE" ]; then
    echo "ERROR: Request not found: $REQUEST_ID"
    exit 1
fi

# Update request with approval decision
jq --arg decision "$DECISION" \
   --arg comments "$COMMENTS" \
   --arg approved_at "$(date -Iseconds)" \
   --arg approved_by "$(whoami)" \
   '.status = $decision | .approval = {"decision": $decision, "comments": $comments, "approved_at": $approved_at, "approved_by": $approved_by}' \
   "$REQUEST_FILE" > "${REQUEST_FILE}.tmp" && sudo mv "${REQUEST_FILE}.tmp" "$REQUEST_FILE"

echo "Request $REQUEST_ID has been $DECISION"

if [ "$DECISION" = "approve" ]; then
    echo "You can now deploy the profile change"
elif [ "$DECISION" = "conditional" ]; then
    echo "Conditions: $COMMENTS"
    echo "Address conditions before deployment"
elif [ "$DECISION" = "reject" ]; then
    echo "Reason: $COMMENTS"
    echo "Revise the request and resubmit"
fi
```

#### 7.4 Deployment

```bash
#!/bin/bash
# deploy-profile-change.sh
# Deploy an approved profile change

REQUEST_ID="$1"

if [ -z "$REQUEST_ID" ]; then
    echo "Usage: $0 <request_id>"
    exit 1
fi

REQUEST_FILE="/var/lib/clawos/apparmor-requests/$REQUEST_ID.json"

if [ ! -f "$REQUEST_FILE" ]; then
    echo "ERROR: Request not found: $REQUEST_ID"
    exit 1
fi

# Check if request is approved
STATUS=$(jq -r '.status' "$REQUEST_FILE")
if [ "$STATUS" != "approve" ]; then
    echo "ERROR: Request is not approved (status: $STATUS)"
    exit 1
fi

PROFILE=$(jq -r '.profile' "$REQUEST_FILE")

echo "=== Deploying Profile Change ==="
echo "Profile: $PROFILE"
echo "Request: $REQUEST_ID"

# Backup current profile
BACKUP_DIR="/var/backups/clawos/apparmor/$(date +%Y%m%d_%H%M%S)"
sudo mkdir -p "$BACKUP_DIR"
sudo cp "/etc/apparmor.d/$PROFILE" "$BACKUP_DIR/"
echo "Backup saved to: $BACKUP_DIR"

# Deploy in complain mode first
echo "Deploying in complain mode..."
sudo aa-complain "/usr/bin/$PROFILE"

# Reload profile
sudo apparmor_parser -r "/etc/apparmor.d/$PROFILE"

# Verify deployment
if sudo aa-status | grep -q "$PROFILE.*complain"; then
    echo "OK: Profile deployed in complain mode"
else
    echo "ERROR: Failed to deploy profile"
    exit 1
fi

# Update request
jq --arg deployed_at "$(date -Iseconds)" \
   --arg deployed_by "$(whoami)" \
   '.deployed = true | .deployment = {"deployed_at": $deployed_at, "deployed_by": $deployed_by}' \
   "$REQUEST_FILE" > "${REQUEST_FILE}.tmp" && sudo mv "${REQUEST_FILE}.tmp" "$REQUEST_FILE"

echo "=== Deployment Complete ==="
echo "Profile is now in complain mode for testing"
echo "After testing, transition to enforce mode"
```

### Emergency Override

In emergency situations, the Security Agent can bypass the normal approval workflow:

```bash
#!/bin/bash
# emergency-override.sh
# Emergency override for profile changes

PROFILE="$1"
REASON="$2"

|  |
    echo "Usage: $0 <profile> <reason>"
    exit 1
fi

echo "=== EMERGENCY OVERRIDE ==="
echo "Profile: $PROFILE"
echo "Reason: $REASON"
echo "Timestamp: $(date -Iseconds)"
echo "Authorized by: $(whoami)"

# Log the emergency override
EMERGENCY_LOG="/var/log/clawos/apparmor/emergency-overrides.log"
{
    echo "=== Emergency Override ==="
    echo "Timestamp: $(date -Iseconds)"
    echo "Profile: $PROFILE"
    echo "Reason: $REASON"
    echo "Authorized by: $(whoami)"
    echo ""
} | sudo tee -a "$EMERGENCY_LOG"

# Backup current profile
BACKUP_DIR="/var/backups/clawos/apparmor/emergency_$(date +%Y%m%d_%H%M%S)"
sudo mkdir -p "$BACKUP_DIR"
sudo cp "/etc/apparmor.d/$PROFILE" "$BACKUP_DIR/"

# Apply emergency changes
# (This would be specific to the emergency situation)

# Reload profile
sudo apparmor_parser -r "/etc/apparmor.d/$PROFILE"

echo "=== Emergency Override Applied ==="
echo "Backup saved to: $BACKUP_DIR"
echo "You must create an incident report within 24 hours"
```

---

## Refinement Decision Matrix

### Decision Criteria

| Criterion                     | Weight | Description                                     |
| ------------------------------| -------| ------------------------------------------------|
| **Security Impact**           | 40%    | Risk of allowing the operation                  |
| **Operational Necessity**     | 30%    | How critical the operation is for functionality |
| **Violation Frequency**       | 15%    | How often the violation occurs                  |
| **Alternative Solutions**     | 10%    | Whether there are safer alternatives            |
| **Implementation Complexity** | 5%     | Difficulty of implementing the change           |

### Decision Matrix

```bash
#!/bin/bash
# refinement-decision-matrix.sh
# Decision matrix for profile refinement

VIOLATION="$1"

if [ -z "$VIOLATION" ]; then
    echo "Usage: $0 <violation_description>"
    exit 1
fi

echo "=== Refinement Decision Matrix ==="
echo "Violation: $VIOLATION"
echo ""

# Score each criterion
echo "Please score each criterion (1-10):"

read -p "Security Impact (1=low risk, 10=high risk): " security_score
read -p "Operational Necessity (1=optional, 10=critical): " operational_score
read -p "Violation Frequency (1=rare, 10=frequent): " frequency_score
read -p "Alternative Solutions (1=none, 10=many): " alternative_score
read -p "Implementation Complexity (1=simple, 10=complex): " complexity_score

# Calculate weighted score
weighted_score=$((security_score * 40 + operational_score * 30 + frequency_score * 15 + alternative_score * 10 + complexity_score * 5))
weighted_score=$((weighted_score / 100))

echo ""
echo "Weighted Score: $weighted_score/10"

# Make decision based on score
if [ "$weighted_score" -le 3 ]; then
    echo "Decision: ALLOW - Low security risk, high operational necessity"
    echo "Action: Add allow rule to profile"
elif [ "$weighted_score" -le 6 ]; then
    echo "Decision: REVIEW - Moderate risk, requires further analysis"
    echo "Action: Submit for Security Agent review"
elif [ "$weighted_score" -le 8 ]; then
    echo "Decision: RESTRICT - High security risk, consider alternatives"
    echo "Action: Implement with additional restrictions"
else
    echo "Decision: DENY - Very high security risk"
    echo "Action: Keep deny rule, investigate root cause"
fi

echo "=== Decision Matrix Complete ==="
```

### Common Scenarios

| Scenario                       | Security Impact | Operational Necessity | Decision |
| -------------------------------| ----------------| ----------------------| ---------|
| Reading config file            | Low             | High                  | ALLOW    |
| Writing to /etc/passwd         | Critical        | Low                   | DENY     |
| Loading shared library         | Low             | High                  | ALLOW    |
| Connecting to external network | High            | Low                   | DENY     |
| Creating temp file             | Low             | High                  | ALLOW    |
| Loading kernel module          | High            | Medium                | REVIEW   |
| Accessing /dev/sda             | Critical        | Low                   | DENY     |
| Writing to log file            | Low             | High                  | ALLOW    |

---

## Automated Refinement Tools

### Automated Violation Analyzer

```bash
#!/bin/bash
# auto-analyze-violations.sh
# Automated violation analysis tool

VIOLATION_LOG="$1"
OUTPUT_DIR="/var/lib/clawos/apparmor-analysis"

if [ -z "$VIOLATION_LOG" ]; then
    echo "Usage: $0 <violation_log>"
    exit 1
fi

mkdir -p "$OUTPUT_DIR"

echo "=== Automated Violation Analysis ==="

# Extract unique violations
echo "Extracting unique violations..."
UNIQUE_VIOLATIONS="$OUTPUT_DIR/unique-violations.txt"
| ' '{print $3 " | " $4 " | " $5}' "$VIOLATION_LOG" |

# Categorize violations
echo "Categorizing violations..."
CONFIG_VIOLATIONS="$OUTPUT_DIR/config-violations.txt"
LIBRARY_VIOLATIONS="$OUTPUT_DIR/library-violations.txt"
TEMP_VIOLATIONS="$OUTPUT_DIR/temp-violations.txt"
LOG_VIOLATIONS="$OUTPUT_DIR/log-violations.txt"
RUNTIME_VIOLATIONS="$OUTPUT_DIR/runtime-violations.txt"
SECURITY_VIOLATIONS="$OUTPUT_DIR/security-violations.txt"

grep -E "config" "$UNIQUE_VIOLATIONS" > "$CONFIG_VIOLATIONS" 2>/dev/null
grep -E "\.so" "$UNIQUE_VIOLATIONS" > "$LIBRARY_VIOLATIONS" 2>/dev/null
grep -E "(/tmp|/var/tmp)" "$UNIQUE_VIOLATIONS" > "$TEMP_VIOLATIONS" 2>/dev/null
grep -E "log" "$UNIQUE_VIOLATIONS" > "$LOG_VIOLATIONS" 2>/dev/null
|  |
| shadow | sudoers |

# Generate recommendations
echo "Generating recommendations..."
RECOMMENDATIONS="$OUTPUT_DIR/recommendations.txt"
{
    echo "=== Violation Analysis Recommendations ==="
    echo "Generated: $(date -Iseconds)"
    echo ""

    # Config file violations
    if [ -s "$CONFIG_VIOLATIONS" ]; then
        echo "## Config File Violations"
        echo "Count: $(wc -l < $CONFIG_VIOLATIONS)"
        echo "Recommendation: Review and add allow rules for legitimate config access"
        echo ""
    fi

    # Library violations
    if [ -s "$LIBRARY_VIOLATIONS" ]; then
        echo "## Library Loading Violations"
        echo "Count: $(wc -l < $LIBRARY_VIOLATIONS)"
        echo "Recommendation: Add library paths to profile"
        echo ""
    fi

    # Temp file violations
    if [ -s "$TEMP_VIOLATIONS" ]; then
        echo "## Temporary File Violations"
        echo "Count: $(wc -l < $TEMP_VIOLATIONS)"
        echo "Recommendation: Add temp directory access with owner restriction"
        echo ""
    fi

    # Log file violations
    if [ -s "$LOG_VIOLATIONS" ]; then
        echo "## Log File Violations"
        echo "Count: $(wc -l < $LOG_VIOLATIONS)"
        echo "Recommendation: Add log file paths to profile"
        echo ""
    fi

    # Runtime violations
    if [ -s "$RUNTIME_VIOLATIONS" ]; then
        echo "## Runtime Directory Violations"
        echo "Count: $(wc -l < $RUNTIME_VIOLATIONS)"
        echo "Recommendation: Add runtime directory access"
        echo ""
    fi

    # Security violations
    if [ -s "$SECURITY_VIOLATIONS" ]; then
        echo "## SECURITY-SENSITIVE VIOLATIONS"
        echo "Count: $(wc -l < $SECURITY_VIOLATIONS)"
        echo "Recommendation: IMMEDIATE REVIEW REQUIRED"
        echo "These violations may indicate security issues"
        echo ""
    fi

} > "$RECOMMENDATIONS"

echo "Analysis complete"
echo "Output directory: $OUTPUT_DIR"
echo "Recommendations: $RECOMMENDATIONS"
```

### Automated Rule Generator

```bash
#!/bin/bash
# auto-generate-rules.sh
# Automatically generate allow rules from violations

VIOLATION_LOG="$1"
PROFILE="$2"
OUTPUT_FILE="$3"

|  |
    echo "Usage: $0 <violation_log> <profile> [output_file]"
    exit 1
fi

if [ -z "$OUTPUT_FILE" ]; then
    OUTPUT_FILE="/var/lib/clawos/apparmor-generated-rules/${PROFILE}-generated.rules"
fi

mkdir -p "$(dirname "$OUTPUT_FILE")"

echo "=== Automated Rule Generation ==="
echo "Profile: $PROFILE"
echo "Output: $OUTPUT_FILE"

# Generate rules from violations
{
    echo "# Auto-generated rules for $PROFILE"
    echo "# Generated: $(date -Iseconds)"
    echo "# Source: $VIOLATION_LOG"
    echo ""
    echo "# WARNING: Review all rules before adding to profile"
    echo ""

    # Extract unique violations and generate rules
    awk -F'|' '{
        profile = $3
        operation = $4
        path = $5
        permissions = $6

        # Only generate rules for this profile
        if (profile == "'"$PROFILE"'") {
            # Generate rule based on operation type
|  | operation == "create" |  |
                print "# Allow " operation " on " path
                print path " " permissions ","
                print ""
            }
        }
    }' "$VIOLATION_LOG" | sort -u

} > "$OUTPUT_FILE"

echo "Rules generated: $(wc -l < $OUTPUT_FILE)"
echo "Please review the generated rules before applying"
```

### Automated Testing Framework

```bash
#!/bin/bash
# auto-test-profile.sh
# Automated testing framework for AppArmor profiles

PROFILE="$1"
TEST_DIR="/var/lib/clawos/apparmor-tests/$PROFILE"

if [ -z "$PROFILE" ]; then
    echo "Usage: $0 <profile>"
    exit 1
fi

mkdir -p "$TEST_DIR"

echo "=== Automated Profile Testing ==="
echo "Profile: $PROFILE"
echo "Test directory: $TEST_DIR"

# Test 1: Syntax validation
echo "[1/5] Syntax validation..."
if sudo apparmor_parser --skip-cache "/etc/apparmor.d/$PROFILE" 2>&1; then
    echo "PASS: Syntax validation"
else
    echo "FAIL: Syntax validation"
    exit 1
fi

# Test 2: Load in complain mode
echo "[2/5] Load in complain mode..."
if sudo aa-complain "/usr/bin/$PROFILE" 2>&1; then
    echo "PASS: Complain mode load"
else
    echo "FAIL: Complain mode load"
    exit 1
fi

# Test 3: Run test suite
echo "[3/5] Run test suite..."
if [ -f "$TEST_DIR/test-suite.sh" ]; then
    bash "$TEST_DIR/test-suite.sh"
    if [ $? -eq 0 ]; then
        echo "PASS: Test suite"
    else
        echo "FAIL: Test suite"
    fi
else
    echo "SKIP: No test suite found"
fi

# Test 4: Check for violations
echo "[4/5] Check for violations..."
| grep -cE "(DENIED |
if [ "$VIOLATIONS" -eq 0 ]; then
    echo "PASS: No violations"
else
    echo "WARN: $VIOLATIONS violations detected"
fi

# Test 5: Verify deny rules
echo "[5/5] Verify deny rules..."
# This would run specific tests for deny rules
echo "INFO: Manual verification required for deny rules"

echo "=== Testing Complete ==="
```

---

## Appendix A: Quick Reference

### Common Commands

| Command                        | Description                   |
| -------------------------------| ------------------------------|
| `aa-complain <profile>`        | Set profile to complain mode  |
| `aa-enforce <profile>`         | Set profile to enforce mode   |
| `aa-status`                    | Show profile status           |
| `aa-logprof`                   | Interactive log analyzer      |
| `apparmor_parser -C <profile>` | Load profile in complain mode |
| `apparmor_parser -r <profile>` | Reload profile                |
| `apparmor_parser -R <profile>` | Remove profile                |

### Log Locations

| Log Type          | Location                                  |
| ------------------| ------------------------------------------|
| AppArmor logs     | `/var/log/syslog`, `/var/log/kern.log`    |
| Audit logs        | `/var/log/audit/audit.log`                |
| ClawOS violations | `/var/log/clawos/apparmor/violations.log` |
| Profile requests  | `/var/lib/clawos/apparmor-requests/`      |

### File Locations

| File Type       | Location                                    |
| ----------------| --------------------------------------------|
| Profiles        | `/etc/apparmor.d/`                          |
| Backups         | `/var/backups/clawos/apparmor/`             |
| Generated rules | `/var/lib/clawos/apparmor-generated-rules/` |
| Test suites     | `/var/lib/clawos/apparmor-tests/`           |

---

## Appendix B: Troubleshooting

### Common Issues

#### Issue: Profile fails to load

**Symptoms**:
```
Error: Failed to load profile
```

**Solutions**:
1. Check syntax: `sudo apparmor_parser --skip-cache <profile>`
2. Check for conflicting rules
3. Verify all paths exist
4. Check profile flags

#### Issue: Too many violations

**Symptoms**:
- Hundreds of violations in logs
- Services failing to start

**Solutions**:
1. Switch to complain mode: `sudo aa-complain <profile>`
2. Analyze violations: `sudo aa-logprof`
3. Identify false positives
4. Add missing allow rules
5. Test before enforcing

#### Issue: Legitimate operation blocked

**Symptoms**:
- Service fails with permission denied
- Operation works in complain mode

**Solutions**:
1. Find the violation in logs
2. Verify the operation is legitimate
3. Add allow rule to profile
4. Test in complain mode
5. Deploy with approval

---

## Change History

| Version | Date       | Author         | Changes         |
| --------| -----------| ---------------| ----------------|
| 1.0.0   | 2026-02-24 | Security Agent | Initial version |
