# P3.6: Endpoint Allowlist Configuration Specification

**Status:** ðŸ“ DRAFT
**Version:** v0.1
**Date:** 2026-02-24
**Owner:** Core Dev Agent
**SHA256:** `SHA256_PLACEHOLDER_TO_BE_FILLED_ON_SIGNING`

---

## Overview

This specification defines the endpoint allowlist configuration for external AI API access within ClawOS. The allowlist enforces strict security boundaries by:

- **Explicit Whitelisting:** Only pre-approved LLM providers and endpoints are accessible
- **Rate Limiting:** Per-endpoint request quotas prevent abuse and cost overruns
- **Security Policies:** TLS verification, signature validation, and credential management
- **Provider-Specific Config:** Tailored settings for NEAR AI bridge, OpenRouter, and other providers

**Critical Requirement:** All external AI API requests MUST be validated against this allowlist. Any endpoint not in the allowlist MUST be rejected with `EPERM` (4) error code (per P1.7 IPC protocol).

---

## Design Principles

1. **Default Deny:** No endpoint is accessible unless explicitly whitelisted
2. **Provider Isolation:** Each provider has isolated configuration and rate limits
3. **Credential Security:** API keys stored securely, never exposed in logs
4. **Audit Trail:** All endpoint access logged with correlation IDs
5. **Graceful Degradation:** Rate limit exceeded returns `EAGAIN` (1) for retry
6. **Schema Validation:** JSON Schema for runtime validation of allowlist config

---

## Allowlist JSON Schema

### Complete Allowlist Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://clawos.org/schemas/endpoint-allowlist-v0.1.json",
  "title": "ClawOS Endpoint Allowlist Configuration",
  "description": "External AI API endpoint allowlist configuration v0.1",
  "type": "object",
  "required": [
    "version",
    "providers"
  ],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$",
      "description": "Configuration version (e.g., '0.1')"
    },
    "providers": {
      "type": "array",
      "minItems": 1,
      "description": "List of allowed AI API providers",
      "items": {
        "$ref": "#/definitions/provider"
      }
    },
    "global_rate_limits": {
      "$ref": "#/definitions/rate_limit",
      "description": "Global rate limits applied across all providers"
    },
    "security_policies": {
      "$ref": "#/definitions/security_policies",
      "description": "Global security policies"
    }
  },
  "definitions": {
    "provider": {
      "type": "object",
      "required": [
        "provider_id",
        "provider_name",
        "base_url",
        "endpoints",
        "rate_limits",
        "security"
      ],
      "properties": {
        "provider_id": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "description": "Unique provider identifier (e.g., 'near-ai', 'openrouter')"
        },
        "provider_name": {
          "type": "string",
          "description": "Human-readable provider name"
        },
        "base_url": {
          "type": "string",
          "format": "uri",
          "description": "Base URL for provider API"
        },
        "endpoints": {
          "type": "array",
          "minItems": 1,
          "description": "Allowed endpoints for this provider",
          "items": {
            "$ref": "#/definitions/endpoint"
          }
        },
        "rate_limits": {
          "$ref": "#/definitions/rate_limit",
          "description": "Rate limits for this provider"
        },
        "security": {
          "$ref": "#/definitions/provider_security",
          "description": "Security settings for this provider"
        },
        "credentials": {
          "$ref": "#/definitions/credentials",
          "description": "Credential configuration for this provider"
        },
        "metadata": {
          "type": "object",
          "description": "Additional provider metadata"
        }
      }
    },
    "endpoint": {
      "type": "object",
      "required": [
        "endpoint_id",
        "path",
        "method",
        "models"
      ],
      "properties": {
        "endpoint_id": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "description": "Unique endpoint identifier"
        },
        "path": {
          "type": "string",
          "description": "API path (relative to base_url)"
        },
        "method": {
          "type": "string",
          "enum": ["GET", "POST", "PUT", "DELETE"],
          "description": "HTTP method"
        },
        "models": {
          "type": "array",
          "minItems": 1,
          "description": "Allowed models for this endpoint",
          "items": {
            "type": "string"
          }
        },
        "rate_limits": {
          "$ref": "#/definitions/rate_limit",
          "description": "Endpoint-specific rate limits (overrides provider)"
        },
        "max_tokens": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum tokens per request"
        },
        "timeout_ms": {
          "type": "integer",
          "minimum": 1000,
          "default": 30000,
          "description": "Request timeout in milliseconds"
        },
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Whether this endpoint is enabled"
        }
      }
    },
    "rate_limit": {
      "type": "object",
      "properties": {
        "requests_per_minute": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum requests per minute"
        },
        "requests_per_hour": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum requests per hour"
        },
        "requests_per_day": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum requests per day"
        },
        "tokens_per_minute": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum tokens processed per minute"
        },
        "burst_allowance": {
          "type": "integer",
          "minimum": 1,
          "description": "Burst allowance for rate limiting"
        },
        "burst_window_ms": {
          "type": "integer",
          "minimum": 1000,
          "default": 10000,
          "description": "Burst window in milliseconds"
        }
      }
    },
    "security": {
      "type": "object",
      "required": [
        "tls_verify",
        "signature_validation"
      ],
      "properties": {
        "tls_verify": {
          "type": "boolean",
          "description": "Enable TLS certificate verification"
        },
        "signature_validation": {
          "type": "boolean",
          "description": "Enable response signature validation"
        },
        "allowed_ciphers": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Allowed TLS cipher suites"
        },
        "min_tls_version": {
          "type": "string",
          "enum": ["1.2", "1.3"],
          "default": "1.3",
          "description": "Minimum TLS version"
        }
      }
    },
    "provider_security": {
      "type": "object",
      "required": [
        "tls_verify",
        "signature_validation"
      ],
      "properties": {
        "tls_verify": {
          "type": "boolean",
          "description": "Enable TLS certificate verification"
        },
        "signature_validation": {
          "type": "boolean",
          "description": "Enable response signature validation"
        },
        "signature_algorithm": {
          "type": "string",
          "enum": ["ed25519", "rsa-pss", "ecdsa"],
          "description": "Signature algorithm for validation"
        },
        "public_key": {
          "type": "string",
          "description": "Public key for signature validation (base64 encoded)"
        },
        "allowed_ciphers": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Allowed TLS cipher suites"
        },
        "min_tls_version": {
          "type": "string",
          "enum": ["1.2", "1.3"],
          "default": "1.3",
          "description": "Minimum TLS version"
        }
      }
    },
    "credentials": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["api_key", "bearer_token", "oauth2", "custom"],
          "description": "Credential type"
        },
        "header_name": {
          "type": "string",
          "description": "Header name for credential (e.g., 'Authorization', 'X-API-Key')"
        },
        "header_prefix": {
          "type": "string",
          "description": "Header prefix (e.g., 'Bearer ', 'sk-')"
        },
        "key_ref": {
          "type": "string",
          "description": "Reference to stored credential key (not the actual key)"
        },
        "oauth2_config": {
          "type": "object",
          "properties": {
            "token_url": {
              "type": "string",
              "format": "uri"
            },
            "client_id": {
              "type": "string"
            },
            "scopes": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "security_policies": {
      "type": "object",
      "properties": {
        "tls_verify": {
          "type": "boolean",
          "default": true,
          "description": "Global TLS verification setting"
        },
        "signature_validation": {
          "type": "boolean",
          "default": true,
          "description": "Global signature validation setting"
        },
        "min_tls_version": {
          "type": "string",
          "enum": ["1.2", "1.3"],
          "default": "1.3",
          "description": "Global minimum TLS version"
        },
        "allowed_ip_ranges": {
          "type": "array",
          "items": {
            "type": "string",
            "format": "ipv4"
          },
          "description": "Allowed IP ranges for provider endpoints"
        },
        "blocked_regions": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Blocked geographic regions (ISO 3166-1 alpha-2)"
        }
      }
    }
  }
}
```

---

## Provider Configurations

### NEAR AI Bridge Configuration

**Provider ID:** `near-ai`
**Base URL:** `https://ai.near.org/api/v1`

#### Provider Configuration

```json
{
  "provider_id": "near-ai",
  "provider_name": "NEAR AI Bridge",
  "base_url": "https://ai.near.org/api/v1",
  "endpoints": [
    {
      "endpoint_id": "chat-completions",
      "path": "/chat/completions",
      "method": "POST",
      "models": [
        "claude-3-5-sonnet-20241022",
        "claude-3-opus-20240229",
        "claude-3-haiku-20240307",
        "gpt-4-turbo-preview",
        "gpt-4-0125-preview",
        "gpt-3.5-turbo-0125"
      ],
      "max_tokens": 4096,
      "timeout_ms": 60000,
      "enabled": true
    },
    {
      "endpoint_id": "embeddings",
      "path": "/embeddings",
      "method": "POST",
      "models": [
        "text-embedding-ada-002",
        "text-embedding-3-small",
        "text-embedding-3-large"
      ],
      "max_tokens": 8192,
      "timeout_ms": 30000,
      "enabled": true
    }
  ],
  "rate_limits": {
    "requests_per_minute": 60,
    "requests_per_hour": 1000,
    "requests_per_day": 10000,
    "tokens_per_minute": 90000,
    "burst_allowance": 10,
    "burst_window_ms": 10000
  },
  "security": {
    "tls_verify": true,
    "signature_validation": true,
    "signature_algorithm": "ed25519",
    "public_key": "BASE64_ENCODED_PUBLIC_KEY_HERE",
    "min_tls_version": "1.3"
  },
  "credentials": {
    "type": "bearer_token",
    "header_name": "Authorization",
    "header_prefix": "Bearer ",
    "key_ref": "near-ai-api-key"
  },
  "metadata": {
    "region": "us-east-1",
    "documentation_url": "https://docs.near.org/ai",
    "support_email": "ai-support@near.org"
  }
}
```

#### NEAR AI Bridge Specific Notes

**Signature Validation:**
- NEAR AI Bridge signs all responses using Ed25519
- Public key must be configured in allowlist
- Invalid signatures trigger `EPERM` (4) error

**Rate Limiting:**
- Token-based rate limiting enforced at both request and token level
- Burst allowance allows short-term spikes
- Rate limit exceeded returns `EAGAIN` (1) with retry-after header

**Error Handling (per P1.7 IPC protocol):**
| Error | Code | Action |
|-------|------|--------|
| Rate limit exceeded | 1 (EAGAIN) | Retry with exponential backoff |
| Invalid signature | 4 (EPERM) | Log security event, reject |
| TLS verification failed | 4 (EPERM) | Log security event, reject |
| Provider timeout | 6 (ETIMEOUT) | Retry up to 2 times |
| Provider error | 7 (EINTERNAL) | Log and escalate |

---

### OpenRouter Configuration

**Provider ID:** `openrouter`
**Base URL:** `https://openrouter.ai/api/v1`

#### Provider Configuration

```json
{
  "provider_id": "openrouter",
  "provider_name": "OpenRouter",
  "base_url": "https://openrouter.ai/api/v1",
  "endpoints": [
    {
      "endpoint_id": "chat-completions",
      "path": "/chat/completions",
      "method": "POST",
      "models": [
        "anthropic/claude-3.5-sonnet",
        "anthropic/claude-3-opus",
        "anthropic/claude-3-haiku",
        "openai/gpt-4-turbo",
        "openai/gpt-4",
        "openai/gpt-3.5-turbo",
        "google/gemini-pro",
        "meta-llama/llama-3-70b-instruct",
        "mistralai/mistral-large"
      ],
      "max_tokens": 8192,
      "timeout_ms": 120000,
      "enabled": true
    },
    {
      "endpoint_id": "models",
      "path": "/models",
      "method": "GET",
      "models": [],
      "timeout_ms": 10000,
      "enabled": true
    }
  ],
  "rate_limits": {
    "requests_per_minute": 100,
    "requests_per_hour": 2000,
    "requests_per_day": 20000,
    "tokens_per_minute": 150000,
    "burst_allowance": 20,
    "burst_window_ms": 15000
  },
  "security": {
    "tls_verify": true,
    "signature_validation": false,
    "min_tls_version": "1.3"
  },
  "credentials": {
    "type": "bearer_token",
    "header_name": "Authorization",
    "header_prefix": "Bearer ",
    "key_ref": "openrouter-api-key"
  },
  "metadata": {
    "region": "global",
    "documentation_url": "https://openrouter.ai/docs",
    "support_email": "support@openrouter.ai"
  }
}
```

#### OpenRouter Specific Notes

**Signature Validation:**
- OpenRouter does not provide response signatures
- Signature validation disabled for this provider
- Relies on TLS verification for security

**Model Access:**
- OpenRouter provides access to multiple LLM providers
- Model names prefixed with provider ID (e.g., `anthropic/claude-3.5-sonnet`)
- Only models explicitly listed in allowlist are accessible

**Rate Limiting:**
- Higher limits than NEAR AI Bridge due to multi-provider nature
- Per-model rate limiting can be configured via endpoint overrides

**Error Handling (per P1.7 IPC protocol):**
| Error | Code | Action |
|-------|------|--------|
| Rate limit exceeded | 1 (EAGAIN) | Retry with exponential backoff |
| Model not allowed | 4 (EPERM) | Log security event, reject |
| TLS verification failed | 4 (EPERM) | Log security event, reject |
| Provider timeout | 6 (ETIMEOUT) | Retry up to 2 times |
| Provider error | 7 (EINTERNAL) | Log and escalate |

---

## Rate Limiting Rules

### Rate Limiting Algorithm

**Token Bucket Algorithm:**
```
bucket_capacity = burst_allowance
refill_rate = requests_per_minute / 60
current_tokens = bucket_capacity

On each request:
  IF current_tokens >= 1:
    current_tokens -= 1
    ALLOW request
  ELSE:
    REJECT with EAGAIN (1)
    Include Retry-After header

Refill every second:
  current_tokens = min(bucket_capacity, current_tokens + refill_rate)
```

### Per-Endpoint Rate Limits

| Provider | Endpoint | Requests/Min | Requests/Hour | Requests/Day | Tokens/Min | Burst |
|----------|----------|--------------|---------------|--------------|------------|-------|
| near-ai | chat-completions | 60 | 1000 | 10000 | 90000 | 10 |
| near-ai | embeddings | 100 | 2000 | 20000 | 150000 | 20 |
| openrouter | chat-completions | 100 | 2000 | 20000 | 150000 | 20 |
| openrouter | models | 200 | 5000 | 50000 | N/A | 50 |

### Rate Limit Response Headers

When rate limit is exceeded, response includes:

```http
HTTP/1.1 429 Too Many Requests
Content-Type: application/json
Retry-After: 30
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1708768800

{
  "error_code": 1,
  "error_message": "EAGAIN: rate limit exceeded, retry after 30s",
  "retry_after": 30
}
```

### Rate Limit Enforcement Points

1. **Pre-Request Check:** Validate against allowlist before making request
2. **Post-Request Check:** Update rate limit counters after response
3. **Token Counting:** Track tokens consumed for token-based limits
4. **Sliding Window:** Use sliding window for accurate rate limiting

---

## Security Policies

### TLS Verification

**Mandatory TLS Verification:**
- All provider endpoints MUST use HTTPS
- TLS certificate validation enabled by default
- Certificate pinning for critical providers (NEAR AI Bridge)

**TLS Configuration:**
```json
{
  "tls_verify": true,
  "min_tls_version": "1.3",
  "allowed_ciphers": [
    "TLS_AES_256_GCM_SHA384",
    "TLS_AES_128_GCM_SHA256",
    "TLS_CHACHA20_POLY1305_SHA256"
  ]
}
```

**TLS Verification Failure:**
- Reject request with `EPERM` (4)
- Log security event with certificate details
- Notify Security Agent via IPC (per P1.7)

### Signature Validation

**Provider-Specific Signature Validation:**

| Provider | Signature Algorithm | Validation Status |
|----------|---------------------|-------------------|
| near-ai | Ed25519 | Enabled |
| openrouter | N/A | Disabled |

**Signature Validation Process:**
1. Extract signature from response headers
2. Verify signature using provider's public key
3. Reject invalid signatures with `EPERM` (4)
4. Log signature validation failures

**Signature Header Format:**
```http
X-Signature: ed25519.BASE64_ENCODED_SIGNATURE
X-Signature-Timestamp: 1708768800
```

### Credential Management

**Credential Storage:**
- API keys stored in secure credential store (e.g., HashiCorp Vault)
- Never expose credentials in logs or error messages
- Rotate credentials regularly (90-day maximum)

**Credential Reference Format:**
```json
{
  "credentials": {
    "type": "bearer_token",
    "header_name": "Authorization",
    "header_prefix": "Bearer ",
    "key_ref": "near-ai-api-key"
  }
}
```

**Credential Retrieval:**
1. Request credential from secure store using `key_ref`
2. Inject into request headers
3. Clear from memory after use
4. Log credential access (without exposing value)

### IP Whitelisting

**Allowed IP Ranges (Optional):**
```json
{
  "security_policies": {
    "allowed_ip_ranges": [
      "104.16.0.0/12",  // Cloudflare (NEAR AI)
      "172.64.0.0/13",  // Cloudflare (OpenRouter)
      "162.159.0.0/16"  // Cloudflare
    ]
  }
}
```

**IP Validation:**
- Resolve provider DNS to IP addresses
- Validate against allowed IP ranges
- Reject requests to unauthorized IPs with `EPERM` (4)

### Geographic Restrictions

**Blocked Regions (Optional):**
```json
{
  "security_policies": {
    "blocked_regions": [
      "CU",  // Cuba
      "IR",  // Iran
      "KP",  // North Korea
      "SY"   // Syria
    ]
  }
}
```

**Region Validation:**
- GeoIP lookup on provider endpoints
- Block requests to endpoints in restricted regions
- Log blocked access attempts

---

## Error Handling

### Error Codes (per P1.7 IPC Protocol)

| Code | Name | Description | Action |
|------|------|-------------|--------|
| 0 | SUCCESS | Request completed successfully | Continue |
| 1 | EAGAIN | Rate limit exceeded | Retry with backoff |
| 2 | EIO | Network/IO error | Retry up to 3 times |
| 3 | ENOENT | Endpoint not found in allowlist | Return 404 |
| 4 | EPERM | Permission denied (security violation) | Log security event |
| 5 | EPROTO | Protocol error | Close connection |
| 6 | ETIMEOUT | Request timeout | Retry up to 2 times |
| 7 | EINTERNAL | Internal error | Log and escalate |
| 8 | EPANIC | Unrecoverable error | Initiate rollback |

### Error Response Format

```json
{
  "error_code": 4,
  "error_message": "EPERM: endpoint not in allowlist",
  "provider_id": "unknown-provider",
  "endpoint_path": "/api/v1/chat/completions",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440000",
  "timestamp_ns": 1234567890123456789
}
```

### Error Handling Workflow

```
1. Validate endpoint against allowlist
   â”œâ”€ Not found â†’ ENOENT (3) â†’ Return 404
   â””â”€ Found â†’ Continue

2. Check rate limits
   â”œâ”€ Exceeded â†’ EAGAIN (1) â†’ Return 429 with Retry-After
   â””â”€ OK â†’ Continue

3. Validate security policies
   â”œâ”€ TLS failed â†’ EPERM (4) â†’ Log security event
   â”œâ”€ Signature invalid â†’ EPERM (4) â†’ Log security event
   â””â”€ OK â†’ Continue

4. Make request to provider
   â”œâ”€ Timeout â†’ ETIMEOUT (6) â†’ Retry up to 2 times
   â”œâ”€ Network error â†’ EIO (2) â†’ Retry up to 3 times
   â””â”€ Success â†’ Return response

5. Update rate limit counters
   â””â”€ Log request with correlation ID
```

---

## Configuration File Location

### Default Configuration Path

```
/etc/clawos/config/endpoint-allowlist.json
```

### Configuration Reload

**Hot Reload:**
- Configuration changes detected via inotify
- Reload without service restart
- Validate new configuration before applying
- Rollback on validation failure

**Reload Process:**
1. Detect configuration file change
2. Validate new configuration against JSON Schema
3. Apply new configuration atomically
4. Log configuration change with diff
5. Notify all components via IPC (per P1.7)

---

## Audit Logging

### Log Format

```json
{
  "timestamp_ns": 1234567890123456789,
  "event_type": "endpoint_access",
  "provider_id": "near-ai",
  "endpoint_id": "chat-completions",
  "model": "claude-3-5-sonnet-20241022",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440000",
  "request_tokens": 1000,
  "response_tokens": 500,
  "status": "success",
  "duration_ms": 1234,
  "rate_limit_remaining": 59
}
```

### Log Events

| Event Type | Description |
|------------|-------------|
| `endpoint_access` | Successful endpoint access |
| `endpoint_denied` | Endpoint not in allowlist |
| `rate_limit_exceeded` | Rate limit exceeded |
| `security_violation` | TLS or signature validation failed |
| `credential_access` | Credential retrieved from store |
| `config_reload` | Configuration reloaded |

### Log Retention

- Retain logs for 90 days
- Archive to cold storage after 30 days
- Compress archived logs
- Index for searchability

---

## Implementation Notes

### Rust Implementation (Phase 2, D-01~D-02)

**Recommended Crates:**
- `reqwest` - HTTP client with TLS support
- `serde_json` - JSON serialization/deserialization
- `jsonschema` - Schema validation
- `ed25519-dalek` - Ed25519 signature verification
- `rustls` - TLS implementation
- `governor` - Rate limiting

**Key Components:**
1. `AllowlistConfig` - Configuration structure
2. `EndpointValidator` - Allowlist validation
3. `RateLimiter` - Token bucket rate limiting
4. `SecurityValidator` - TLS and signature validation
5. `CredentialManager` - Secure credential retrieval
6. `AuditLogger` - Structured logging

### Configuration Validation

**Validation Steps:**
1. Parse JSON configuration
2. Validate against JSON Schema
3. Check for duplicate provider IDs
4. Check for duplicate endpoint IDs
5. Validate URL formats
6. Validate rate limit values
7. Validate security settings

**Validation Failure:**
- Reject invalid configuration
- Log validation errors
- Keep previous configuration active
- Notify administrator

---

## Appendix A: Complete Example Configuration

```json
{
  "version": "0.1",
  "providers": [
    {
      "provider_id": "near-ai",
      "provider_name": "NEAR AI Bridge",
      "base_url": "https://ai.near.org/api/v1",
      "endpoints": [
        {
          "endpoint_id": "chat-completions",
          "path": "/chat/completions",
          "method": "POST",
          "models": [
            "claude-3-5-sonnet-20241022",
            "claude-3-opus-20240229",
            "claude-3-haiku-20240307"
          ],
          "max_tokens": 4096,
          "timeout_ms": 60000,
          "enabled": true
        },
        {
          "endpoint_id": "embeddings",
          "path": "/embeddings",
          "method": "POST",
          "models": [
            "text-embedding-ada-002",
            "text-embedding-3-small"
          ],
          "max_tokens": 8192,
          "timeout_ms": 30000,
          "enabled": true
        }
      ],
      "rate_limits": {
        "requests_per_minute": 60,
        "requests_per_hour": 1000,
        "requests_per_day": 10000,
        "tokens_per_minute": 90000,
        "burst_allowance": 10,
        "burst_window_ms": 10000
      },
      "security": {
        "tls_verify": true,
        "signature_validation": true,
        "signature_algorithm": "ed25519",
        "public_key": "BASE64_ENCODED_PUBLIC_KEY_HERE",
        "min_tls_version": "1.3"
      },
      "credentials": {
        "type": "bearer_token",
        "header_name": "Authorization",
        "header_prefix": "Bearer ",
        "key_ref": "near-ai-api-key"
      }
    },
    {
      "provider_id": "openrouter",
      "provider_name": "OpenRouter",
      "base_url": "https://openrouter.ai/api/v1",
      "endpoints": [
        {
          "endpoint_id": "chat-completions",
          "path": "/chat/completions",
          "method": "POST",
          "models": [
            "anthropic/claude-3.5-sonnet",
            "anthropic/claude-3-opus",
            "openai/gpt-4-turbo",
            "google/gemini-pro"
          ],
          "max_tokens": 8192,
          "timeout_ms": 120000,
          "enabled": true
        }
      ],
      "rate_limits": {
        "requests_per_minute": 100,
        "requests_per_hour": 2000,
        "requests_per_day": 20000,
        "tokens_per_minute": 150000,
        "burst_allowance": 20,
        "burst_window_ms": 15000
      },
      "security": {
        "tls_verify": true,
        "signature_validation": false,
        "min_tls_version": "1.3"
      },
      "credentials": {
        "type": "bearer_token",
        "header_name": "Authorization",
        "header_prefix": "Bearer ",
        "key_ref": "openrouter-api-key"
      }
    }
  ],
  "global_rate_limits": {
    "requests_per_minute": 200,
    "requests_per_hour": 5000,
    "requests_per_day": 50000
  },
  "security_policies": {
    "tls_verify": true,
    "signature_validation": true,
    "min_tls_version": "1.3",
    "allowed_ip_ranges": [
      "104.16.0.0/12",
      "172.64.0.0/13",
      "162.159.0.0/16"
    ],
    "blocked_regions": [
      "CU",
      "IR",
      "KP",
      "SY"
    ]
  }
}
```

---

## Appendix B: Error Code Quick Reference

| Code | Name | Retry? | Log Level | HTTP Status |
|------|------|--------|-----------|-------------|
| 0 | SUCCESS | N/A | DEBUG | 200 |
| 1 | EAGAIN | Yes | INFO | 429 |
| 2 | EIO | Yes | WARNING | 502 |
| 3 | ENOENT | No | INFO | 404 |
| 4 | EPERM | No | ERROR | 403 |
| 5 | EPROTO | No | ERROR | 400 |
| 6 | ETIMEOUT | Yes | WARNING | 504 |
| 7 | EINTERNAL | No | ERROR | 500 |
| 8 | EPANIC | No | CRITICAL | 500 |

---

## Appendix C: Version History

### v0.1 (2026-02-24)
- Initial draft
- Define allowlist JSON schema
- Specify NEAR AI bridge configuration
- Specify OpenRouter endpoints
- Define rate limiting rules per endpoint
- Include security policies (TLS verification, signature validation)
- Define error handling per P1.7 IPC protocol

---

## References

- **P1.7:** IPC protocol specification (error code mapping)
- **P3.1:** Tool migration specification (tool endpoint access)
- **P3.2:** Channels repackaging specification (AI channel configuration)
- **D-01~D-02:** Rust implementation (Phase 2)
- **NEAR AI Documentation:** https://docs.near.org/ai
- **OpenRouter Documentation:** https://openrouter.ai/docs

---

**END OF SPECIFICATION**
